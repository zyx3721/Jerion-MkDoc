
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="记录相关知识，沉淀生活，记录点滴。">
      
      
        <meta name="author" content="Jerion">
      
      
        <link rel="canonical" href="https://jerion.cn/linux/Ansible/Ansible%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E4%BD%BF%E7%94%A8/">
      
      
        <link rel="prev" href="../../../blog/">
      
      
        <link rel="next" href="../../Linux%E5%91%BD%E4%BB%A4/1.linux%E5%91%BD%E4%BB%A4%E5%9F%BA%E6%9C%AC%E6%A0%BC%E5%BC%8F/">
      
      
        <link rel="alternate" type="application/rss+xml" title="RSS 订阅" href="../../../feed_rss_created.xml">
        <link rel="alternate" type="application/rss+xml" title="已更新内容的 RSS 订阅" href="../../../feed_rss_updated.xml">
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.33">
    
    
      
        <title>Ansible安装部署使用 - Jerion's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Microsoft+Yahei:300,300i,400,400i,700,700i%7CConsolas,Courier,courier+new,stkaiti,kaiti,simkai,monospace:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Microsoft Yahei";--md-code-font:"Consolas,Courier,courier new,stkaiti,kaiti,simkai,monospace"}</style>
      
    
    
      <link rel="stylesheet" href="../../../css/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  <script async src="https://umami.weiyan.cc/script.js" data-website-id="b713abc7-f5eb-4683-a132-9fda53e29198"></script>
<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id:"3JIbgFniDcGIaNP7",ck:"3JIbgFniDcGIaNP7",autoTrack:true})</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
   <meta name="baidu-site-verification" content="codeva-hJH2gPjZkn" />

   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="grey" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#ansible安装部署使用" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="Jerion&#39;s Blog" class="md-header__button md-logo" aria-label="Jerion's Blog" data-md-component="logo">
      
  <img src="../../../assets/octocat.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jerion's Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Ansible安装部署使用
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="grey" data-md-color-accent="deep-orange"  aria-label="切换到暗色模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换到暗色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="grey" data-md-color-accent="deep-orange"  aria-label="切换到亮色模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换到亮色模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/zyx3721/Jerion-MkDoc" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Jerion-MkDoc
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../blog/" class="md-tabs__link">
          
  
    
  
  博客

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
    
  
  Linux

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../shell/" class="md-tabs__link">
          
  
    
  
  Shell

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../vmware/Esxi6.7%E5%AE%89%E8%A3%85MacOS%2010.15.6/" class="md-tabs__link">
          
  
    
  
  VMware

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../python/Python%E5%8F%8APycharm%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/" class="md-tabs__link">
          
  
    
  
  Python

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../docker/docker-deploy/deploy-blog/docker%20%E5%AE%89%E8%A3%85typecho%E5%8D%9A%E5%AE%A2/" class="md-tabs__link">
          
  
    
  
  Docker

        </a>
      </li>
    
  

    
  

    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../routeswitch/Cisio/%E5%8D%95%E8%87%82%E8%B7%AF%E7%94%B1/" class="md-tabs__link">
          
  
    
  
  路由交换

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../synology/VSP%20%E5%AE%89%E8%A3%85%E9%BB%91%E7%BE%A4%E6%99%96/" class="md-tabs__link">
          
  
    
  
  群晖

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../sql/PostgreSQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/" class="md-tabs__link">
          
  
    
  
  数据库

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../bat/git/" class="md-tabs__link">
          
  
    
  
  批处理

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../k8s/" class="md-tabs__link">
          
  
    
  
  K8S

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../git/Git/Git%20Extensions%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3/" class="md-tabs__link">
          
  
    
  
  Git

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../essay/" class="md-tabs__link">
          
  
    
  
  随笔

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Jerion&#39;s Blog" class="md-nav__button md-logo" aria-label="Jerion's Blog" data-md-component="logo">
      
  <img src="../../../assets/octocat.jpg" alt="logo">

    </a>
    Jerion's Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/zyx3721/Jerion-MkDoc" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Jerion-MkDoc
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../blog/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    博客
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
          
        
      
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Linux
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Linux
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" checked>
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Ansible
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            Ansible
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Ansible安装部署使用
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Ansible安装部署使用
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#一ansible概念" class="md-nav__link">
    <span class="md-ellipsis">
      一、Ansible概念
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一、Ansible概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1参考文档" class="md-nav__link">
    <span class="md-ellipsis">
      1.参考文档
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2ansible简介" class="md-nav__link">
    <span class="md-ellipsis">
      2.Ansible简介
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3ansible组件" class="md-nav__link">
    <span class="md-ellipsis">
      3.Ansible组件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.Ansible组件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-playbook编写" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 playbook编写
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-playbook执行" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 playbook执行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-facts配置" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 Facts配置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#二安装ansible" class="md-nav__link">
    <span class="md-ellipsis">
      二、安装ansible
    </span>
  </a>
  
    <nav class="md-nav" aria-label="二、安装ansible">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1手动安装" class="md-nav__link">
    <span class="md-ellipsis">
      1.手动安装
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2yum安装脚本" class="md-nav__link">
    <span class="md-ellipsis">
      2.yum安装脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3源码安装脚本" class="md-nav__link">
    <span class="md-ellipsis">
      3.源码安装脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4查看ansible版本" class="md-nav__link">
    <span class="md-ellipsis">
      4.查看ansible版本
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#三ansible配置文件" class="md-nav__link">
    <span class="md-ellipsis">
      三、Ansible配置文件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="三、Ansible配置文件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1主配置文件" class="md-nav__link">
    <span class="md-ellipsis">
      1.主配置文件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.主配置文件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-创建配置文件目录" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 创建配置文件目录
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-配置ansiblecfg文件" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 配置ansible.cfg文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-设置环境变量" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 设置环境变量
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-重新加载-shell-环境" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 重新加载 Shell 环境
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2主机清单" class="md-nav__link">
    <span class="md-ellipsis">
      2.主机清单
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3存放角色的目录" class="md-nav__link">
    <span class="md-ellipsis">
      3.存放角色的目录
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#四生成ssh密钥" class="md-nav__link">
    <span class="md-ellipsis">
      四、生成ssh密钥
    </span>
  </a>
  
    <nav class="md-nav" aria-label="四、生成ssh密钥">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1内网服务器" class="md-nav__link">
    <span class="md-ellipsis">
      1.内网服务器
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.内网服务器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-生成-ssh-密钥对" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 生成 SSH 密钥对
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-查看生成的密钥" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 查看生成的密钥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-复制公钥到远程主机" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 复制公钥到远程主机
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-无密钥登录测试" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 无密钥登录测试
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2云服务器" class="md-nav__link">
    <span class="md-ellipsis">
      2.云服务器
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.云服务器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-复制公钥到远程主机" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 复制公钥到远程主机
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-修改-sshd_config-配置文件" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 修改 sshd_config 配置文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-重启-ssh-服务" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 重启 SSH 服务
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-修改-root-目录及文件的权限" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 修改 root 目录及文件的权限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-无密钥登录测试" class="md-nav__link">
    <span class="md-ellipsis">
      2.5 无密钥登录测试
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#五ansible使用" class="md-nav__link">
    <span class="md-ellipsis">
      五、ansible使用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="五、ansible使用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1创建ansible项目目录" class="md-nav__link">
    <span class="md-ellipsis">
      1.创建ansible项目目录
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2主机清单inventory" class="md-nav__link">
    <span class="md-ellipsis">
      2.主机清单inventory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.主机清单inventory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-修改-hosts-文件" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 修改 hosts 文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-测试-inventory-文件" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 测试 Inventory 文件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3ansible测试ping" class="md-nav__link">
    <span class="md-ellipsis">
      3.ansible测试ping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4编写playbook测试" class="md-nav__link">
    <span class="md-ellipsis">
      4.编写Playbook测试
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.编写Playbook测试">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-创建-playbook-文件" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 创建 Playbook 文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-执行-playbook-文件" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 执行 Playbook 文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-注意事项" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 注意事项
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#六ansible获取nginx信息" class="md-nav__link">
    <span class="md-ellipsis">
      六、ansible获取nginx信息
    </span>
  </a>
  
    <nav class="md-nav" aria-label="六、ansible获取nginx信息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1检查nginx路径" class="md-nav__link">
    <span class="md-ellipsis">
      1.检查nginx路径
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2查看nginx配置文件所在" class="md-nav__link">
    <span class="md-ellipsis">
      2.查看nginx配置文件所在
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3查看nginx配置文件内容" class="md-nav__link">
    <span class="md-ellipsis">
      3.查看nginx配置文件内容
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4查找服务器上所有的ssl证书" class="md-nav__link">
    <span class="md-ellipsis">
      4.查找服务器上所有的ssl证书
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5搜索证书的确切路径" class="md-nav__link">
    <span class="md-ellipsis">
      5.搜索证书的确切路径
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6查看证书所在目录" class="md-nav__link">
    <span class="md-ellipsis">
      6.查看证书所在目录
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#七获取证书列表信息" class="md-nav__link">
    <span class="md-ellipsis">
      七、获取证书列表信息
    </span>
  </a>
  
    <nav class="md-nav" aria-label="七、获取证书列表信息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1配置python脚本云服务器" class="md-nav__link">
    <span class="md-ellipsis">
      1.配置python脚本（云服务器）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.配置python脚本（云服务器）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-脚本功能说明" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 脚本功能说明
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1 脚本功能说明">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111-导入必要及可选的库" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.1 导入必要及可选的库
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112-定义登录信息和url" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.2 定义登录信息和URL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113-准备自动进行身份认证的信息可选" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.3 准备自动进行身份认证的信息（可选）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#114-准备登录请求的负载" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.4 准备登录请求的负载
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#115-发送登录请求并处理响应" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.5 发送登录请求并处理响应
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#116-设置请求头和准备获取域名列表的请求体" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.6 设置请求头和准备获取域名列表的请求体
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#117-发送获取域名列表的请求并处理响应" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.7 发送获取域名列表的请求并处理响应
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#118-循环处理每个域名获取其证书信息并写入文件" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.8 循环处理每个域名，获取其证书信息并写入文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#119-处理失败情况" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.9 处理失败情况
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-脚本相关问题" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 脚本相关问题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 脚本相关问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-如何查看后端登录的url" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.1 如何查看后端登录的URL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-如何查看后端登录后的域名列表url" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.2 如何查看后端登录后的域名列表URL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123-如何查看后端登录后的获取证书信息url" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.3 如何查看后端登录后的获取证书信息URL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#124-如何查看抓取到的token值" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.4 如何查看抓取到的token值
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#125-如何查看登录请求的负载" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.5 如何查看登录请求的负载
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#126-如何查看请求头和准备获取域名列表的请求体" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.6 如何查看请求头和准备获取域名列表的请求体
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#127-如何查看查询并获取证书信息的请求体" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.7 如何查看查询并获取证书信息的请求体
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2运行python脚本云服务器" class="md-nav__link">
    <span class="md-ellipsis">
      2.运行python脚本（云服务器）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3配置python脚本sunline" class="md-nav__link">
    <span class="md-ellipsis">
      3.配置python脚本（sunline）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4运行python脚本sunline" class="md-nav__link">
    <span class="md-ellipsis">
      4.运行python脚本（sunline）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#八获取nginx配置" class="md-nav__link">
    <span class="md-ellipsis">
      八、获取nginx配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="八、获取nginx配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1导出域名信息" class="md-nav__link">
    <span class="md-ellipsis">
      1.导出域名信息
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2配置将域名解析为ip的脚本" class="md-nav__link">
    <span class="md-ellipsis">
      2.配置将域名解析为IP的脚本
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.配置将域名解析为IP的脚本">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-仅输出为ip信息且不重复" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 仅输出为IP信息且不重复
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.1 仅输出为IP信息且不重复">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#211-配置shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.1 配置shell脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#212-运行shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.2 运行shell脚本
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-输出为域名ip信息" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 输出为域名+IP信息
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.2 输出为域名+IP信息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#221-配置shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1 配置shell脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#222-运行shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.2 运行shell脚本
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3获取nginx配置" class="md-nav__link">
    <span class="md-ellipsis">
      3.获取nginx配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.获取nginx配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-配置主机清单文件" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 配置主机清单文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-配置获取nginx配置和证书信息的脚本" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 配置获取nginx配置和证书信息的脚本
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 配置获取nginx配置和证书信息的脚本">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-配置shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.1 配置shell脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-运行shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.2 运行shell脚本
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-配置提取nginx及证书信息的脚本" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 配置提取nginx及证书信息的脚本
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.3 配置提取nginx及证书信息的脚本">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#331-配置shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.1 配置shell脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#332-运行shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.2 运行shell脚本
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#九使用yunwei账号" class="md-nav__link">
    <span class="md-ellipsis">
      九、使用yunwei账号
    </span>
  </a>
  
    <nav class="md-nav" aria-label="九、使用yunwei账号">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1安装sshpass" class="md-nav__link">
    <span class="md-ellipsis">
      1.安装sshpass
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2修改主机清单文件" class="md-nav__link">
    <span class="md-ellipsis">
      2.修改主机清单文件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Linux命令
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            Linux命令
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/1.linux%E5%91%BD%E4%BB%A4%E5%9F%BA%E6%9C%AC%E6%A0%BC%E5%BC%8F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    1. linux命令基本格式
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/2.ls%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2. ls命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/3.touch%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3. touch命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/4.%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%E7%9F%A5%E8%AF%86%E6%A6%82%E5%BF%B5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4. 源码安装知识概念
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/5.%E9%80%9A%E8%BF%87sshkey%E5%AF%86%E9%92%A5%E7%99%BB%E5%BD%95%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5. 通过sshkey密钥登录服务器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/6.stat%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6. stat命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/7.more%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7. more命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/8.cat%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8. cat命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/9.tail%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9. tail命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/10.less%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    10. less命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/11.head%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    11. head命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/12.file%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    12. file命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/13.tac%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    13. tac命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/14.cd%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    14. cd命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/15.mkdir%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    15. mkdir命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/16.tree%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    16. tree命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/17.nmap%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    17. nmap命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/18.rsync%E5%91%BD%E4%BB%A4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    18. rsync命令
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Linux%E5%91%BD%E4%BB%A4/passwd%E5%92%8Cshowad%E6%A6%82%E8%BF%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    19. passwd和shadow概述
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../shell/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Shell
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../vmware/Esxi6.7%E5%AE%89%E8%A3%85MacOS%2010.15.6/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    VMware
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../python/Python%E5%8F%8APycharm%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Python
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
          
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    
  
  
    <a href="../../../docker/docker-deploy/deploy-blog/docker%20%E5%AE%89%E8%A3%85typecho%E5%8D%9A%E5%AE%A2/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Docker
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../routeswitch/Cisio/%E5%8D%95%E8%87%82%E8%B7%AF%E7%94%B1/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    路由交换
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../synology/VSP%20%E5%AE%89%E8%A3%85%E9%BB%91%E7%BE%A4%E6%99%96/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    群晖
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
          
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../sql/PostgreSQL%20%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    数据库
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
          
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../bat/git/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    批处理
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../k8s/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    K8S
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
          
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    
  
  
    <a href="../../../git/Git/Git%20Extensions%E4%BD%BF%E7%94%A8%E6%96%87%E6%A1%A3/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Git
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../essay/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    随笔
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#一ansible概念" class="md-nav__link">
    <span class="md-ellipsis">
      一、Ansible概念
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一、Ansible概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1参考文档" class="md-nav__link">
    <span class="md-ellipsis">
      1.参考文档
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2ansible简介" class="md-nav__link">
    <span class="md-ellipsis">
      2.Ansible简介
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3ansible组件" class="md-nav__link">
    <span class="md-ellipsis">
      3.Ansible组件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.Ansible组件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-playbook编写" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 playbook编写
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-playbook执行" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 playbook执行
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-facts配置" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 Facts配置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#二安装ansible" class="md-nav__link">
    <span class="md-ellipsis">
      二、安装ansible
    </span>
  </a>
  
    <nav class="md-nav" aria-label="二、安装ansible">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1手动安装" class="md-nav__link">
    <span class="md-ellipsis">
      1.手动安装
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2yum安装脚本" class="md-nav__link">
    <span class="md-ellipsis">
      2.yum安装脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3源码安装脚本" class="md-nav__link">
    <span class="md-ellipsis">
      3.源码安装脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4查看ansible版本" class="md-nav__link">
    <span class="md-ellipsis">
      4.查看ansible版本
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#三ansible配置文件" class="md-nav__link">
    <span class="md-ellipsis">
      三、Ansible配置文件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="三、Ansible配置文件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1主配置文件" class="md-nav__link">
    <span class="md-ellipsis">
      1.主配置文件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.主配置文件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-创建配置文件目录" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 创建配置文件目录
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-配置ansiblecfg文件" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 配置ansible.cfg文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-设置环境变量" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 设置环境变量
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-重新加载-shell-环境" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 重新加载 Shell 环境
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2主机清单" class="md-nav__link">
    <span class="md-ellipsis">
      2.主机清单
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3存放角色的目录" class="md-nav__link">
    <span class="md-ellipsis">
      3.存放角色的目录
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#四生成ssh密钥" class="md-nav__link">
    <span class="md-ellipsis">
      四、生成ssh密钥
    </span>
  </a>
  
    <nav class="md-nav" aria-label="四、生成ssh密钥">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1内网服务器" class="md-nav__link">
    <span class="md-ellipsis">
      1.内网服务器
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.内网服务器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-生成-ssh-密钥对" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 生成 SSH 密钥对
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-查看生成的密钥" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 查看生成的密钥
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-复制公钥到远程主机" class="md-nav__link">
    <span class="md-ellipsis">
      1.3 复制公钥到远程主机
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14-无密钥登录测试" class="md-nav__link">
    <span class="md-ellipsis">
      1.4 无密钥登录测试
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2云服务器" class="md-nav__link">
    <span class="md-ellipsis">
      2.云服务器
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.云服务器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-复制公钥到远程主机" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 复制公钥到远程主机
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-修改-sshd_config-配置文件" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 修改 sshd_config 配置文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-重启-ssh-服务" class="md-nav__link">
    <span class="md-ellipsis">
      2.3 重启 SSH 服务
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-修改-root-目录及文件的权限" class="md-nav__link">
    <span class="md-ellipsis">
      2.4 修改 root 目录及文件的权限
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#25-无密钥登录测试" class="md-nav__link">
    <span class="md-ellipsis">
      2.5 无密钥登录测试
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#五ansible使用" class="md-nav__link">
    <span class="md-ellipsis">
      五、ansible使用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="五、ansible使用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1创建ansible项目目录" class="md-nav__link">
    <span class="md-ellipsis">
      1.创建ansible项目目录
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2主机清单inventory" class="md-nav__link">
    <span class="md-ellipsis">
      2.主机清单inventory
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.主机清单inventory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-修改-hosts-文件" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 修改 hosts 文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-测试-inventory-文件" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 测试 Inventory 文件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3ansible测试ping" class="md-nav__link">
    <span class="md-ellipsis">
      3.ansible测试ping
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4编写playbook测试" class="md-nav__link">
    <span class="md-ellipsis">
      4.编写Playbook测试
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.编写Playbook测试">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-创建-playbook-文件" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 创建 Playbook 文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-执行-playbook-文件" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 执行 Playbook 文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-注意事项" class="md-nav__link">
    <span class="md-ellipsis">
      4.3 注意事项
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#六ansible获取nginx信息" class="md-nav__link">
    <span class="md-ellipsis">
      六、ansible获取nginx信息
    </span>
  </a>
  
    <nav class="md-nav" aria-label="六、ansible获取nginx信息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1检查nginx路径" class="md-nav__link">
    <span class="md-ellipsis">
      1.检查nginx路径
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2查看nginx配置文件所在" class="md-nav__link">
    <span class="md-ellipsis">
      2.查看nginx配置文件所在
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3查看nginx配置文件内容" class="md-nav__link">
    <span class="md-ellipsis">
      3.查看nginx配置文件内容
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4查找服务器上所有的ssl证书" class="md-nav__link">
    <span class="md-ellipsis">
      4.查找服务器上所有的ssl证书
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5搜索证书的确切路径" class="md-nav__link">
    <span class="md-ellipsis">
      5.搜索证书的确切路径
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6查看证书所在目录" class="md-nav__link">
    <span class="md-ellipsis">
      6.查看证书所在目录
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#七获取证书列表信息" class="md-nav__link">
    <span class="md-ellipsis">
      七、获取证书列表信息
    </span>
  </a>
  
    <nav class="md-nav" aria-label="七、获取证书列表信息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1配置python脚本云服务器" class="md-nav__link">
    <span class="md-ellipsis">
      1.配置python脚本（云服务器）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.配置python脚本（云服务器）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-脚本功能说明" class="md-nav__link">
    <span class="md-ellipsis">
      1.1 脚本功能说明
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.1 脚本功能说明">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111-导入必要及可选的库" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.1 导入必要及可选的库
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112-定义登录信息和url" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.2 定义登录信息和URL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113-准备自动进行身份认证的信息可选" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.3 准备自动进行身份认证的信息（可选）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#114-准备登录请求的负载" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.4 准备登录请求的负载
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#115-发送登录请求并处理响应" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.5 发送登录请求并处理响应
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#116-设置请求头和准备获取域名列表的请求体" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.6 设置请求头和准备获取域名列表的请求体
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#117-发送获取域名列表的请求并处理响应" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.7 发送获取域名列表的请求并处理响应
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#118-循环处理每个域名获取其证书信息并写入文件" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.8 循环处理每个域名，获取其证书信息并写入文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#119-处理失败情况" class="md-nav__link">
    <span class="md-ellipsis">
      1.1.9 处理失败情况
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-脚本相关问题" class="md-nav__link">
    <span class="md-ellipsis">
      1.2 脚本相关问题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.2 脚本相关问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-如何查看后端登录的url" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.1 如何查看后端登录的URL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-如何查看后端登录后的域名列表url" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.2 如何查看后端登录后的域名列表URL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#123-如何查看后端登录后的获取证书信息url" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.3 如何查看后端登录后的获取证书信息URL
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#124-如何查看抓取到的token值" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.4 如何查看抓取到的token值
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#125-如何查看登录请求的负载" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.5 如何查看登录请求的负载
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#126-如何查看请求头和准备获取域名列表的请求体" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.6 如何查看请求头和准备获取域名列表的请求体
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#127-如何查看查询并获取证书信息的请求体" class="md-nav__link">
    <span class="md-ellipsis">
      1.2.7 如何查看查询并获取证书信息的请求体
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2运行python脚本云服务器" class="md-nav__link">
    <span class="md-ellipsis">
      2.运行python脚本（云服务器）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3配置python脚本sunline" class="md-nav__link">
    <span class="md-ellipsis">
      3.配置python脚本（sunline）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4运行python脚本sunline" class="md-nav__link">
    <span class="md-ellipsis">
      4.运行python脚本（sunline）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#八获取nginx配置" class="md-nav__link">
    <span class="md-ellipsis">
      八、获取nginx配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="八、获取nginx配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1导出域名信息" class="md-nav__link">
    <span class="md-ellipsis">
      1.导出域名信息
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2配置将域名解析为ip的脚本" class="md-nav__link">
    <span class="md-ellipsis">
      2.配置将域名解析为IP的脚本
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.配置将域名解析为IP的脚本">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-仅输出为ip信息且不重复" class="md-nav__link">
    <span class="md-ellipsis">
      2.1 仅输出为IP信息且不重复
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.1 仅输出为IP信息且不重复">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#211-配置shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.1 配置shell脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#212-运行shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      2.1.2 运行shell脚本
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-输出为域名ip信息" class="md-nav__link">
    <span class="md-ellipsis">
      2.2 输出为域名+IP信息
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.2 输出为域名+IP信息">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#221-配置shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.1 配置shell脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#222-运行shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      2.2.2 运行shell脚本
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3获取nginx配置" class="md-nav__link">
    <span class="md-ellipsis">
      3.获取nginx配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.获取nginx配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-配置主机清单文件" class="md-nav__link">
    <span class="md-ellipsis">
      3.1 配置主机清单文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-配置获取nginx配置和证书信息的脚本" class="md-nav__link">
    <span class="md-ellipsis">
      3.2 配置获取nginx配置和证书信息的脚本
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.2 配置获取nginx配置和证书信息的脚本">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#321-配置shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.1 配置shell脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#322-运行shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      3.2.2 运行shell脚本
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-配置提取nginx及证书信息的脚本" class="md-nav__link">
    <span class="md-ellipsis">
      3.3 配置提取nginx及证书信息的脚本
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.3 配置提取nginx及证书信息的脚本">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#331-配置shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.1 配置shell脚本
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#332-运行shell脚本" class="md-nav__link">
    <span class="md-ellipsis">
      3.3.2 运行shell脚本
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#九使用yunwei账号" class="md-nav__link">
    <span class="md-ellipsis">
      九、使用yunwei账号
    </span>
  </a>
  
    <nav class="md-nav" aria-label="九、使用yunwei账号">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1安装sshpass" class="md-nav__link">
    <span class="md-ellipsis">
      1.安装sshpass
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2修改主机清单文件" class="md-nav__link">
    <span class="md-ellipsis">
      2.修改主机清单文件
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  
    
      
    
    <a href="https://github.com/zyx3721/Jerion-MkDoc/raw/main/docs/linux/Ansible/Ansible安装部署使用.md" title="查看本页的源代码" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.15 8.15 0 0 1-1.23-2Z"/></svg>
    </a>
  


<h1 id="ansible安装部署使用">Ansible安装部署使用<a class="headerlink" href="#ansible安装部署使用" title="Permanent link">&para;</a></h1>
<h2 id="一ansible概念">一、Ansible概念<a class="headerlink" href="#一ansible概念" title="Permanent link">&para;</a></h2>
<h3 id="1参考文档">1.参考文档<a class="headerlink" href="#1参考文档" title="Permanent link">&para;</a></h3>
<p><a href="https://www.cnblogs.com/arnoLixi/p/10375245.html">ansible入门</a></p>
<h3 id="2ansible简介">2.Ansible简介<a class="headerlink" href="#2ansible简介" title="Permanent link">&para;</a></h3>
<p>Ansible是一个开源的自动化工具，用于配置管理、应用部署、任务自动化和多节点编排。它由Michael DeHaan创建，并于2015年被Red Hat公司收购。Ansible以其简单易用、无代理架构和基于SSH的通信而受到广泛欢迎。</p>
<p>它也是一个配置管理系统（configuration management system）。你只需要可以使用ssh访问你的服务器或设备就可以；它不同于其他工具，因为它使用的是推送的方式，而不像其他工具一样使用拉去安装agent。</p>
<p>Ansible 核心软件是一个命令行工具，它不运行作为后台服务或守护进程，所以它没有“启动”或“重启”服务的概念，Ansible 直接通过命令行执行操作，如运行 playbook、ad-hoc 命令等，要使用 Ansible 执行任务，需要创建 inventory 文件和 playbook。</p>
<p>Ansible 可以帮助我们完成一些批量任务，或者完成一些需要经常重复的工作；例如在多台服务器中同时部署一个服务，并且启动。</p>
<h3 id="3ansible组件">3.Ansible组件<a class="headerlink" href="#3ansible组件" title="Permanent link">&para;</a></h3>
<p>以下是Ansible的一些关键概念和组件：</p>
<ul>
<li><strong>Playbooks</strong>：Playbooks是Ansible的配置、部署和编排语言。它们可以描述你想在远程机器上执行的策略或环境。Playbooks使用YAML格式编写，易于阅读和编写。</li>
<li><strong>Modules</strong>：Ansible执行任务时使用模块。这些模块是独立的代码块，可以执行特定的任务，如安装软件包、复制文件或管理用户账户。</li>
<li><strong>Inventory</strong>：Inventory是一个配置文件，定义了Ansible管理的主机列表。它可以是静态的，也可以是动态生成的。</li>
<li><strong>Roles</strong>：Roles是一种组织Playbooks、模板、文件和Ansible其他元素的方式，以便于重用和共享。</li>
<li><strong>Ad-hoc Commands</strong>：除了Playbooks，Ansible还允许用户通过简单的命令行指令执行任务，这些被称为ad-hoc命令。</li>
<li><strong>Facts</strong>：Facts是Ansible从远程主机收集的信息，如操作系统版本、IP地址等。这些信息可以在Playbooks中使用。</li>
<li><strong>Handlers</strong>：Handlers是Ansible中的一种特殊任务，它们在发生特定事件（如文件更改）时被触发。</li>
<li><strong>Variables</strong>：Ansible允许在Playbooks中定义变量，以便于控制任务的行为。</li>
<li><strong>Templating</strong>：Ansible使用Jinja2模板引擎，允许在配置文件中使用变量和条件语句。</li>
<li><strong>Galaxy</strong>：Ansible Galaxy是一个社区平台，用户可以在这里分享和下载Ansible roles。</li>
</ul>
<p>Ansible的设计哲学是“简单、强大、无代理”，这意味着你不需要在远程主机上安装任何额外的软件来使用Ansible。它的主要优势在于其易用性、一致性和可扩展性，使得它成为自动化IT任务的流行选择。</p>
<h4 id="31-playbook编写">3.1 playbook编写<a class="headerlink" href="#31-playbook编写" title="Permanent link">&para;</a></h4>
<p>编写一个<code>test.yml</code>的测试文件：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><a href="#__codelineno-0-1"><span class="linenos" data-linenos=" 1 "></span></a>---
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><a href="#__codelineno-0-2"><span class="linenos" data-linenos=" 2 "></span></a>-<span class="w"> </span>name:<span class="w"> </span>Test<span class="w"> </span>SSH<span class="w"> </span>Connection
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><a href="#__codelineno-0-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">  </span>hosts:<span class="w"> </span>all
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><a href="#__codelineno-0-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">  </span>become:<span class="w"> </span>yes
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><a href="#__codelineno-0-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="w">  </span>tasks:<span class="w"> </span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><a href="#__codelineno-0-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="w">    </span>-<span class="w"> </span>name:<span class="w"> </span>Echo<span class="w"> </span>a<span class="w"> </span>message
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><a href="#__codelineno-0-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="w">      </span>shell:<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Hello, this is test.&quot;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><a href="#__codelineno-0-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">      </span>register:<span class="w"> </span>echo_output
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><a href="#__codelineno-0-9"><span class="linenos" data-linenos=" 9 "></span></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><a href="#__codelineno-0-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">    </span>-<span class="w"> </span>name:<span class="w"> </span>Print<span class="w"> </span>the<span class="w"> </span>output<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="nb">command</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><a href="#__codelineno-0-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">      </span>debug:
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><a href="#__codelineno-0-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">        </span>var:<span class="w"> </span>echo_output.stdout
</code></pre></div>
<p>playbook解释：</p>
<ul>
<li><code>---</code>：这是YAML文档的开始标记。</li>
<li><code>- name: Test SSH Connection</code>：这是Play的名称。它是一个描述性的标题，用于标识Play的目的。在这个例子中，Play的目的是测试SSH连接。</li>
<li><code>hosts: all</code>：这指定了Play将应用于哪些主机。<code>all</code>关键字意味着Play将应用于Inventory文件中定义的所有主机。你也可以指定一个主机组或单个主机。</li>
<li><code>become: yes</code>：这指示Ansible在执行任务时使用<code>become</code>（即<code>sudo</code>或类似权限提升命令）。<code>yes</code>表示对于这个Play中的所有任务，Ansible都将尝试提升权限。如果你不想提升权限，可以将<code>become</code>设置为<code>no</code>。</li>
<li><code>tasks:</code>：这标志着任务列表的开始。在Play中，你可以定义一个或多个任务。</li>
<li><code>- name: Echo a message</code>：这是第一个任务的名称。它描述了任务的目的，即在远程主机上执行<code>echo</code>命令。</li>
<li><code>shell: echo "Hello, this is test."</code>：这是任务的实际内容。<code>shell</code>模块用于执行命令，这里执行的是<code>echo "Hello, this is test."</code>。<code>shell</code>模块会捕获命令的输出，而<code>command</code>模块则不会。</li>
<li><code>register: echo_output</code>：这指示Ansible将<code>shell</code>任务的输出存储在名为<code>echo_output</code>的变量中。这样，你就可以在后续任务中引用这个变量。</li>
<li><code>- name: Print the output of the echo command</code>：这是第二个任务的名称。它的目的是打印之前<code>echo</code>命令的输出。</li>
<li><code>debug: var: echo_output.stdout</code>：这是第二个任务的内容。<code>debug</code>模块用于输出信息到Ansible控制台。<code>var: echo_output.stdout</code>指示<code>debug</code>模块输出<code>echo_output</code>变量的<code>stdout</code>属性，即<code>echo</code>命令的输出。</li>
</ul>
<p>这个Playbook的目的是在所有远程主机上执行一个简单的<code>echo</code>命令，并将输出存储在一个变量中，然后打印这个变量的内容。这样，你就可以验证Ansible是否能够成功地与远程主机通信，并且是否能够正确地捕获和处理命令的输出。</p>
<h4 id="32-playbook执行">3.2 playbook执行<a class="headerlink" href="#32-playbook执行" title="Permanent link">&para;</a></h4>
<p>使用<code>ansible-playbook</code>命令执行playbook文件，并指定主机<code>10.22.51.63</code>：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><a href="#__codelineno-1-1"><span class="linenos" data-linenos="1 "></span></a>ansible-playbook<span class="w"> </span>-i<span class="w"> </span><span class="m">10</span>.22.51.63,<span class="w"> </span>/data/ansible/playbook/test.yml
</code></pre></div>
<p>执行结果如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><a href="#__codelineno-2-1"><span class="linenos" data-linenos="1 "></span></a>TASK<span class="w"> </span><span class="o">[</span>Print<span class="w"> </span>the<span class="w"> </span>output<span class="w"> </span>of<span class="w"> </span>the<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>command<span class="o">]</span><span class="w"> </span>********************************************************************************
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><a href="#__codelineno-2-2"><span class="linenos" data-linenos="2 "></span></a>ok:<span class="w"> </span><span class="o">[</span><span class="m">10</span>.22.51.63<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><a href="#__codelineno-2-3"><span class="linenos" data-linenos="3 "></span></a><span class="w">    </span><span class="s2">&quot;echo_output.stdout&quot;</span>:<span class="w"> </span><span class="s2">&quot;Hello, this is test.&quot;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><a href="#__codelineno-2-4"><span class="linenos" data-linenos="4 "></span></a><span class="o">}</span>
</code></pre></div>
<h4 id="33-facts配置">3.3 Facts配置<a class="headerlink" href="#33-facts配置" title="Permanent link">&para;</a></h4>
<p>Facts是关于远程主机的信息，如网络接口、操作系统版本、IP地址等。你可以使用<code>setup</code>模块来收集这些信息。以下是一个简单的Ansible Playbook示例，它使用<code>setup</code>模块来收集Facts并将结果存储在一个变量中：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><a href="#__codelineno-3-1"><span class="linenos" data-linenos=" 1 "></span></a>---
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><a href="#__codelineno-3-2"><span class="linenos" data-linenos=" 2 "></span></a>-<span class="w">  </span>name:<span class="w"> </span>Collect<span class="w"> </span>facts<span class="w"> </span>from<span class="w"> </span>remote<span class="w"> </span>hosts
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><a href="#__codelineno-3-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">   </span>hosts:<span class="w"> </span>all
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><a href="#__codelineno-3-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">   </span>gather_facts:<span class="w"> </span>no
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><a href="#__codelineno-3-5"><span class="linenos" data-linenos=" 5 "></span></a>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><a href="#__codelineno-3-6"><span class="linenos" data-linenos=" 6 "></span></a>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><a href="#__codelineno-3-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="w">   </span>tasks:
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><a href="#__codelineno-3-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">     </span>-<span class="w"> </span>name:<span class="w"> </span>Gather<span class="w"> </span>facts
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><a href="#__codelineno-3-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">       </span>setup:
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><a href="#__codelineno-3-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">         </span>filter:<span class="w"> </span>ansible_hostname
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><a href="#__codelineno-3-11"><span class="linenos" data-linenos="11 "></span></a>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><a href="#__codelineno-3-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">     </span>-<span class="w"> </span>name:<span class="w"> </span>Store<span class="w"> </span>facts<span class="w"> </span><span class="k">in</span><span class="w"> </span>a<span class="w"> </span>variable
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><a href="#__codelineno-3-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">       </span>set_fact:
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><a href="#__codelineno-3-14"><span class="linenos" data-linenos="14 "></span></a><span class="w">         </span>gathered_facts:<span class="w"> </span><span class="s2">&quot;{{ ansible_facts }}&quot;</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><a href="#__codelineno-3-15"><span class="linenos" data-linenos="15 "></span></a>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><a href="#__codelineno-3-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">     </span>-<span class="w"> </span>name:<span class="w"> </span>Debug<span class="w"> </span>the<span class="w"> </span>gathered<span class="w"> </span>facts
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><a href="#__codelineno-3-17"><span class="linenos" data-linenos="17 "></span></a><span class="w">       </span>debug:<span class="w"> </span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a><a href="#__codelineno-3-18"><span class="linenos" data-linenos="18 "></span></a><span class="w">        </span>var:<span class="w"> </span>gathered_facts
</code></pre></div>
<p>部分解释：</p>
<ul>
<li><code>filter: ansible_hostname</code>：代表只收集主机名称。</li>
</ul>
<p>使用<code>ansible-playbook</code>命令执行playbook文件，并指定主机<code>10.22.51.63</code>：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><a href="#__codelineno-4-1"><span class="linenos" data-linenos="1 "></span></a>ansible-playbook<span class="w"> </span>-i<span class="w"> </span><span class="m">10</span>.22.51.63,<span class="w"> </span>/data/ansible/playbook/collect_facts.yml
</code></pre></div>
<p>执行结果如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><a href="#__codelineno-5-1"><span class="linenos" data-linenos="1 "></span></a>TASK<span class="w"> </span><span class="o">[</span>Debug<span class="w"> </span>the<span class="w"> </span>gathered<span class="w"> </span>facts<span class="o">]</span><span class="w"> </span>**************************************************************************************************************************************
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><a href="#__codelineno-5-2"><span class="linenos" data-linenos="2 "></span></a>ok:<span class="w"> </span><span class="o">[</span><span class="m">10</span>.22.51.63<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><a href="#__codelineno-5-3"><span class="linenos" data-linenos="3 "></span></a><span class="s2">&quot;gathered_facts&quot;</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><a href="#__codelineno-5-4"><span class="linenos" data-linenos="4 "></span></a><span class="w">   </span><span class="s2">&quot;discovered_interpreter_python&quot;</span>:<span class="w"> </span><span class="s2">&quot;/usr/libexec/platform-python&quot;</span>,
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><a href="#__codelineno-5-5"><span class="linenos" data-linenos="5 "></span></a><span class="w">   </span><span class="s2">&quot;hostname&quot;</span>:<span class="w"> </span><span class="s2">&quot;jerion&quot;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><a href="#__codelineno-5-6"><span class="linenos" data-linenos="6 "></span></a><span class="o">}</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><a href="#__codelineno-5-7"><span class="linenos" data-linenos="7 "></span></a><span class="o">}</span>
</code></pre></div>
<h2 id="二安装ansible">二、安装ansible<a class="headerlink" href="#二安装ansible" title="Permanent link">&para;</a></h2>
<p>这里安装用的是<code>yum安装脚本</code>。</p>
<h3 id="1手动安装">1.手动安装<a class="headerlink" href="#1手动安装" title="Permanent link">&para;</a></h3>
<p>暂无。</p>
<h3 id="2yum安装脚本">2.yum安装脚本<a class="headerlink" href="#2yum安装脚本" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><a href="#__codelineno-6-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><a href="#__codelineno-6-2"><span class="linenos" data-linenos=" 2 "></span></a>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><a href="#__codelineno-6-3"><span class="linenos" data-linenos=" 3 "></span></a>check_root<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><a href="#__codelineno-6-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>id<span class="w"> </span>-u<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><a href="#__codelineno-6-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;请以 root 用户运行此脚本。&quot;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><a href="#__codelineno-6-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><a href="#__codelineno-6-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="w">    </span><span class="k">fi</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><a href="#__codelineno-6-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="o">}</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><a href="#__codelineno-6-9"><span class="linenos" data-linenos=" 9 "></span></a>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><a href="#__codelineno-6-10"><span class="linenos" data-linenos="10 "></span></a>check_command<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><a href="#__codelineno-6-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><a href="#__codelineno-6-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$1</span><span class="s2"> 失败，请检查您的网络连接或软件源配置。&quot;</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><a href="#__codelineno-6-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a><a href="#__codelineno-6-14"><span class="linenos" data-linenos="14 "></span></a><span class="w">    </span><span class="k">fi</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a><a href="#__codelineno-6-15"><span class="linenos" data-linenos="15 "></span></a><span class="o">}</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a><a href="#__codelineno-6-16"><span class="linenos" data-linenos="16 "></span></a>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a><a href="#__codelineno-6-17"><span class="linenos" data-linenos="17 "></span></a>install_epel<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a><a href="#__codelineno-6-18"><span class="linenos" data-linenos="18 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;正在安装 EPEL 仓库...&quot;</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a><a href="#__codelineno-6-19"><span class="linenos" data-linenos="19 "></span></a><span class="w">    </span>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>epel-release
<a id="__codelineno-6-20" name="__codelineno-6-20"></a><a href="#__codelineno-6-20"><span class="linenos" data-linenos="20 "></span></a><span class="w">    </span>check_command<span class="w"> </span><span class="s2">&quot;安装 EPEL 仓库&quot;</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a><a href="#__codelineno-6-21"><span class="linenos" data-linenos="21 "></span></a><span class="o">}</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a><a href="#__codelineno-6-22"><span class="linenos" data-linenos="22 "></span></a>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a><a href="#__codelineno-6-23"><span class="linenos" data-linenos="23 "></span></a>install_ansible<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a><a href="#__codelineno-6-24"><span class="linenos" data-linenos="24 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;正在安装 Ansible...&quot;</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a><a href="#__codelineno-6-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">    </span>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>ansible
<a id="__codelineno-6-26" name="__codelineno-6-26"></a><a href="#__codelineno-6-26"><span class="linenos" data-linenos="26 "></span></a><span class="w">    </span>check_command<span class="w"> </span><span class="s2">&quot;安装 Ansible&quot;</span>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a><a href="#__codelineno-6-27"><span class="linenos" data-linenos="27 "></span></a><span class="o">}</span>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a><a href="#__codelineno-6-28"><span class="linenos" data-linenos="28 "></span></a>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a><a href="#__codelineno-6-29"><span class="linenos" data-linenos="29 "></span></a>check_ansible_installed<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a><a href="#__codelineno-6-30"><span class="linenos" data-linenos="30 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>ansible<span class="w"> </span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a><a href="#__codelineno-6-31"><span class="linenos" data-linenos="31 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Ansible 已安装，版本信息如下：&quot;</span>
<a id="__codelineno-6-32" name="__codelineno-6-32"></a><a href="#__codelineno-6-32"><span class="linenos" data-linenos="32 "></span></a><span class="w">        </span>ansible<span class="w"> </span>--version
<a id="__codelineno-6-33" name="__codelineno-6-33"></a><a href="#__codelineno-6-33"><span class="linenos" data-linenos="33 "></span></a><span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">0</span>
<a id="__codelineno-6-34" name="__codelineno-6-34"></a><a href="#__codelineno-6-34"><span class="linenos" data-linenos="34 "></span></a><span class="w">    </span><span class="k">fi</span>
<a id="__codelineno-6-35" name="__codelineno-6-35"></a><a href="#__codelineno-6-35"><span class="linenos" data-linenos="35 "></span></a><span class="o">}</span>
<a id="__codelineno-6-36" name="__codelineno-6-36"></a><a href="#__codelineno-6-36"><span class="linenos" data-linenos="36 "></span></a>
<a id="__codelineno-6-37" name="__codelineno-6-37"></a><a href="#__codelineno-6-37"><span class="linenos" data-linenos="37 "></span></a>main<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-6-38" name="__codelineno-6-38"></a><a href="#__codelineno-6-38"><span class="linenos" data-linenos="38 "></span></a><span class="w">    </span>check_root
<a id="__codelineno-6-39" name="__codelineno-6-39"></a><a href="#__codelineno-6-39"><span class="linenos" data-linenos="39 "></span></a><span class="w">    </span>check_ansible_installed
<a id="__codelineno-6-40" name="__codelineno-6-40"></a><a href="#__codelineno-6-40"><span class="linenos" data-linenos="40 "></span></a><span class="w">    </span>install_epel
<a id="__codelineno-6-41" name="__codelineno-6-41"></a><a href="#__codelineno-6-41"><span class="linenos" data-linenos="41 "></span></a><span class="w">    </span>install_ansible
<a id="__codelineno-6-42" name="__codelineno-6-42"></a><a href="#__codelineno-6-42"><span class="linenos" data-linenos="42 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Ansible 安装成功，版本信息如下：&quot;</span>
<a id="__codelineno-6-43" name="__codelineno-6-43"></a><a href="#__codelineno-6-43"><span class="linenos" data-linenos="43 "></span></a><span class="w">    </span>ansible<span class="w"> </span>--version
<a id="__codelineno-6-44" name="__codelineno-6-44"></a><a href="#__codelineno-6-44"><span class="linenos" data-linenos="44 "></span></a><span class="o">}</span>
<a id="__codelineno-6-45" name="__codelineno-6-45"></a><a href="#__codelineno-6-45"><span class="linenos" data-linenos="45 "></span></a>
<a id="__codelineno-6-46" name="__codelineno-6-46"></a><a href="#__codelineno-6-46"><span class="linenos" data-linenos="46 "></span></a>main
</code></pre></div>
<h3 id="3源码安装脚本">3.源码安装脚本<a class="headerlink" href="#3源码安装脚本" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><a href="#__codelineno-7-1"><span class="linenos" data-linenos="  1 "></span></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><a href="#__codelineno-7-2"><span class="linenos" data-linenos="  2 "></span></a>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><a href="#__codelineno-7-3"><span class="linenos" data-linenos="  3 "></span></a><span class="nv">PYTHON_VERSION</span><span class="o">=</span><span class="s2">&quot;3.10.0&quot;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><a href="#__codelineno-7-4"><span class="linenos" data-linenos="  4 "></span></a><span class="nv">VIRTUAL_ENV_NAME</span><span class="o">=</span><span class="s2">&quot;myenv&quot;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><a href="#__codelineno-7-5"><span class="linenos" data-linenos="  5 "></span></a><span class="nv">ANSIBLE_VERSION</span><span class="o">=</span><span class="s2">&quot;2.9.6&quot;</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><a href="#__codelineno-7-6"><span class="linenos" data-linenos="  6 "></span></a><span class="nv">REQUIRED_MODULES</span><span class="o">=</span><span class="s2">&quot;os sys json&quot;</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><a href="#__codelineno-7-7"><span class="linenos" data-linenos="  7 "></span></a>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><a href="#__codelineno-7-8"><span class="linenos" data-linenos="  8 "></span></a>install_dependencies<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><a href="#__codelineno-7-9"><span class="linenos" data-linenos="  9 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;正在安装所需依赖...&quot;</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><a href="#__codelineno-7-10"><span class="linenos" data-linenos=" 10 "></span></a><span class="w">    </span>yum<span class="w"> </span>update<span class="w"> </span>-y
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><a href="#__codelineno-7-11"><span class="linenos" data-linenos=" 11 "></span></a><span class="w">    </span>yum<span class="w"> </span>groupinstall<span class="w"> </span>-y<span class="w"> </span><span class="s2">&quot;Development Tools&quot;</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><a href="#__codelineno-7-12"><span class="linenos" data-linenos=" 12 "></span></a><span class="w">    </span>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>gcc<span class="w"> </span>openssl-devel<span class="w"> </span>bzip2-devel<span class="w"> </span>libffi-devel<span class="w"> </span>wget<span class="w"> </span>zlib-devel<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><a href="#__codelineno-7-13"><span class="linenos" data-linenos=" 13 "></span></a><span class="w">                   </span>libbz2-devel<span class="w"> </span>readline-devel<span class="w"> </span>sqlite-devel<span class="w"> </span>curl<span class="w"> </span>llvm<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><a href="#__codelineno-7-14"><span class="linenos" data-linenos=" 14 "></span></a><span class="w">                   </span>ncurses-devel<span class="w"> </span>ncurses-libs<span class="w"> </span>xz-devel<span class="w"> </span>tk-devel<span class="w"> </span>liblzma-devel<span class="w"> </span>gdbm-devel<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><a href="#__codelineno-7-15"><span class="linenos" data-linenos=" 15 "></span></a><span class="w">                   </span>db4-devel<span class="w"> </span>libpcap-devel<span class="w"> </span>expat-devel<span class="w"> </span>epel-release<span class="w"> </span>git<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><a href="#__codelineno-7-16"><span class="linenos" data-linenos=" 16 "></span></a><span class="w">                   </span>python3-devel
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><a href="#__codelineno-7-17"><span class="linenos" data-linenos=" 17 "></span></a><span class="o">}</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><a href="#__codelineno-7-18"><span class="linenos" data-linenos=" 18 "></span></a>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><a href="#__codelineno-7-19"><span class="linenos" data-linenos=" 19 "></span></a>clean_pyenv<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a><a href="#__codelineno-7-20"><span class="linenos" data-linenos=" 20 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;清理旧的 pyenv 安装...&quot;</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a><a href="#__codelineno-7-21"><span class="linenos" data-linenos=" 21 "></span></a><span class="w">    </span>rm<span class="w"> </span>-rf<span class="w"> </span>~/.pyenv
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><a href="#__codelineno-7-22"><span class="linenos" data-linenos=" 22 "></span></a><span class="o">}</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a><a href="#__codelineno-7-23"><span class="linenos" data-linenos=" 23 "></span></a>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a><a href="#__codelineno-7-24"><span class="linenos" data-linenos=" 24 "></span></a>install_pyenv<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a><a href="#__codelineno-7-25"><span class="linenos" data-linenos=" 25 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;正在安装 pyenv...&quot;</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a><a href="#__codelineno-7-26"><span class="linenos" data-linenos=" 26 "></span></a><span class="w">    </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/pyenv/pyenv.git<span class="w"> </span>~/.pyenv
<a id="__codelineno-7-27" name="__codelineno-7-27"></a><a href="#__codelineno-7-27"><span class="linenos" data-linenos=" 27 "></span></a><span class="w">    </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/pyenv/pyenv-virtualenv.git<span class="w"> </span>~/.pyenv/plugins/pyenv-virtualenv
<a id="__codelineno-7-28" name="__codelineno-7-28"></a><a href="#__codelineno-7-28"><span class="linenos" data-linenos=" 28 "></span></a>
<a id="__codelineno-7-29" name="__codelineno-7-29"></a><a href="#__codelineno-7-29"><span class="linenos" data-linenos=" 29 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;export PYENV_ROOT=&quot;$HOME/.pyenv&quot;&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc
<a id="__codelineno-7-30" name="__codelineno-7-30"></a><a href="#__codelineno-7-30"><span class="linenos" data-linenos=" 30 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;export PATH=&quot;$PYENV_ROOT/bin:$PATH&quot;&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc
<a id="__codelineno-7-31" name="__codelineno-7-31"></a><a href="#__codelineno-7-31"><span class="linenos" data-linenos=" 31 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;if command -v pyenv 1&gt;/dev/null 2&gt;&amp;1; then\n  eval &quot;$(pyenv init --path)&quot;\nfi&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc
<a id="__codelineno-7-32" name="__codelineno-7-32"></a><a href="#__codelineno-7-32"><span class="linenos" data-linenos=" 32 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s1">&#39;if command -v pyenv 1&gt;/dev/null 2&gt;&amp;1; then\n  eval &quot;$(pyenv init -)&quot;\nfi&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc
<a id="__codelineno-7-33" name="__codelineno-7-33"></a><a href="#__codelineno-7-33"><span class="linenos" data-linenos=" 33 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;eval &quot;$(pyenv virtualenv-init -)&quot;&#39;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.bashrc
<a id="__codelineno-7-34" name="__codelineno-7-34"></a><a href="#__codelineno-7-34"><span class="linenos" data-linenos=" 34 "></span></a><span class="w">    </span><span class="nb">source</span><span class="w"> </span>~/.bashrc
<a id="__codelineno-7-35" name="__codelineno-7-35"></a><a href="#__codelineno-7-35"><span class="linenos" data-linenos=" 35 "></span></a>
<a id="__codelineno-7-36" name="__codelineno-7-36"></a><a href="#__codelineno-7-36"><span class="linenos" data-linenos=" 36 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>pyenv<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-7-37" name="__codelineno-7-37"></a><a href="#__codelineno-7-37"><span class="linenos" data-linenos=" 37 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;pyenv 安装成功。&quot;</span>
<a id="__codelineno-7-38" name="__codelineno-7-38"></a><a href="#__codelineno-7-38"><span class="linenos" data-linenos=" 38 "></span></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-7-39" name="__codelineno-7-39"></a><a href="#__codelineno-7-39"><span class="linenos" data-linenos=" 39 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;pyenv 安装失败，正在退出...&quot;</span>
<a id="__codelineno-7-40" name="__codelineno-7-40"></a><a href="#__codelineno-7-40"><span class="linenos" data-linenos=" 40 "></span></a><span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-7-41" name="__codelineno-7-41"></a><a href="#__codelineno-7-41"><span class="linenos" data-linenos=" 41 "></span></a><span class="w">    </span><span class="k">fi</span>
<a id="__codelineno-7-42" name="__codelineno-7-42"></a><a href="#__codelineno-7-42"><span class="linenos" data-linenos=" 42 "></span></a><span class="o">}</span>
<a id="__codelineno-7-43" name="__codelineno-7-43"></a><a href="#__codelineno-7-43"><span class="linenos" data-linenos=" 43 "></span></a>
<a id="__codelineno-7-44" name="__codelineno-7-44"></a><a href="#__codelineno-7-44"><span class="linenos" data-linenos=" 44 "></span></a>install_python<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-45" name="__codelineno-7-45"></a><a href="#__codelineno-7-45"><span class="linenos" data-linenos=" 45 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">command</span><span class="w"> </span>-v<span class="w"> </span>pyenv<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-7-46" name="__codelineno-7-46"></a><a href="#__codelineno-7-46"><span class="linenos" data-linenos=" 46 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;正在使用 pyenv 安装 Python </span><span class="nv">$PYTHON_VERSION</span><span class="s2">...&quot;</span>
<a id="__codelineno-7-47" name="__codelineno-7-47"></a><a href="#__codelineno-7-47"><span class="linenos" data-linenos=" 47 "></span></a><span class="w">        </span>pyenv<span class="w"> </span>uninstall<span class="w"> </span>-f<span class="w"> </span><span class="nv">$PYTHON_VERSION</span>
<a id="__codelineno-7-48" name="__codelineno-7-48"></a><a href="#__codelineno-7-48"><span class="linenos" data-linenos=" 48 "></span></a><span class="w">        </span><span class="nv">CFLAGS</span><span class="o">=</span><span class="s2">&quot;-I/usr/include/ffi -I/usr/include/openssl&quot;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-7-49" name="__codelineno-7-49"></a><a href="#__codelineno-7-49"><span class="linenos" data-linenos=" 49 "></span></a><span class="w">        </span><span class="nv">LDFLAGS</span><span class="o">=</span><span class="s2">&quot;-L/usr/lib64 -L/usr/lib64/openssl&quot;</span><span class="w"> </span><span class="se">\</span>
<a id="__codelineno-7-50" name="__codelineno-7-50"></a><a href="#__codelineno-7-50"><span class="linenos" data-linenos=" 50 "></span></a><span class="w">        </span>pyenv<span class="w"> </span>install<span class="w"> </span><span class="nv">$PYTHON_VERSION</span>
<a id="__codelineno-7-51" name="__codelineno-7-51"></a><a href="#__codelineno-7-51"><span class="linenos" data-linenos=" 51 "></span></a><span class="w">        </span>pyenv<span class="w"> </span>global<span class="w"> </span><span class="nv">$PYTHON_VERSION</span>
<a id="__codelineno-7-52" name="__codelineno-7-52"></a><a href="#__codelineno-7-52"><span class="linenos" data-linenos=" 52 "></span></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-7-53" name="__codelineno-7-53"></a><a href="#__codelineno-7-53"><span class="linenos" data-linenos=" 53 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;pyenv 未安装，正在退出...&quot;</span>
<a id="__codelineno-7-54" name="__codelineno-7-54"></a><a href="#__codelineno-7-54"><span class="linenos" data-linenos=" 54 "></span></a><span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-7-55" name="__codelineno-7-55"></a><a href="#__codelineno-7-55"><span class="linenos" data-linenos=" 55 "></span></a><span class="w">    </span><span class="k">fi</span>
<a id="__codelineno-7-56" name="__codelineno-7-56"></a><a href="#__codelineno-7-56"><span class="linenos" data-linenos=" 56 "></span></a><span class="o">}</span>
<a id="__codelineno-7-57" name="__codelineno-7-57"></a><a href="#__codelineno-7-57"><span class="linenos" data-linenos=" 57 "></span></a>
<a id="__codelineno-7-58" name="__codelineno-7-58"></a><a href="#__codelineno-7-58"><span class="linenos" data-linenos=" 58 "></span></a>check_required_modules<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-59" name="__codelineno-7-59"></a><a href="#__codelineno-7-59"><span class="linenos" data-linenos=" 59 "></span></a><span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">python_path</span><span class="o">=</span><span class="k">$(</span>pyenv<span class="w"> </span>which<span class="w"> </span>python<span class="k">)</span>
<a id="__codelineno-7-60" name="__codelineno-7-60"></a><a href="#__codelineno-7-60"><span class="linenos" data-linenos=" 60 "></span></a><span class="w">    </span><span class="nb">local</span><span class="w"> </span><span class="nv">missing_module_flag</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-7-61" name="__codelineno-7-61"></a><a href="#__codelineno-7-61"><span class="linenos" data-linenos=" 61 "></span></a><span class="w">    </span><span class="k">for</span><span class="w"> </span>module<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$REQUIRED_MODULES</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-7-62" name="__codelineno-7-62"></a><a href="#__codelineno-7-62"><span class="linenos" data-linenos=" 62 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="nv">$python_path</span><span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;import </span><span class="nv">$module</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-7-63" name="__codelineno-7-63"></a><a href="#__codelineno-7-63"><span class="linenos" data-linenos=" 63 "></span></a><span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;缺少必需的 Python 模块: </span><span class="nv">$module</span><span class="s2">&quot;</span>
<a id="__codelineno-7-64" name="__codelineno-7-64"></a><a href="#__codelineno-7-64"><span class="linenos" data-linenos=" 64 "></span></a><span class="w">            </span><span class="nv">missing_module_flag</span><span class="o">=</span><span class="m">1</span>
<a id="__codelineno-7-65" name="__codelineno-7-65"></a><a href="#__codelineno-7-65"><span class="linenos" data-linenos=" 65 "></span></a><span class="w">        </span><span class="k">fi</span>
<a id="__codelineno-7-66" name="__codelineno-7-66"></a><a href="#__codelineno-7-66"><span class="linenos" data-linenos=" 66 "></span></a><span class="w">    </span><span class="k">done</span>
<a id="__codelineno-7-67" name="__codelineno-7-67"></a><a href="#__codelineno-7-67"><span class="linenos" data-linenos=" 67 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nv">$missing_module_flag</span>
<a id="__codelineno-7-68" name="__codelineno-7-68"></a><a href="#__codelineno-7-68"><span class="linenos" data-linenos=" 68 "></span></a><span class="o">}</span>
<a id="__codelineno-7-69" name="__codelineno-7-69"></a><a href="#__codelineno-7-69"><span class="linenos" data-linenos=" 69 "></span></a>
<a id="__codelineno-7-70" name="__codelineno-7-70"></a><a href="#__codelineno-7-70"><span class="linenos" data-linenos=" 70 "></span></a>create_virtualenv<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-71" name="__codelineno-7-71"></a><a href="#__codelineno-7-71"><span class="linenos" data-linenos=" 71 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;正在创建虚拟环境...&quot;</span>
<a id="__codelineno-7-72" name="__codelineno-7-72"></a><a href="#__codelineno-7-72"><span class="linenos" data-linenos=" 72 "></span></a><span class="w">    </span>pyenv<span class="w"> </span>virtualenv<span class="w"> </span><span class="nv">$PYTHON_VERSION</span><span class="w"> </span><span class="nv">$VIRTUAL_ENV_NAME</span>
<a id="__codelineno-7-73" name="__codelineno-7-73"></a><a href="#__codelineno-7-73"><span class="linenos" data-linenos=" 73 "></span></a><span class="w">    </span>pyenv<span class="w"> </span>activate<span class="w"> </span><span class="nv">$VIRTUAL_ENV_NAME</span>
<a id="__codelineno-7-74" name="__codelineno-7-74"></a><a href="#__codelineno-7-74"><span class="linenos" data-linenos=" 74 "></span></a><span class="o">}</span>
<a id="__codelineno-7-75" name="__codelineno-7-75"></a><a href="#__codelineno-7-75"><span class="linenos" data-linenos=" 75 "></span></a>
<a id="__codelineno-7-76" name="__codelineno-7-76"></a><a href="#__codelineno-7-76"><span class="linenos" data-linenos=" 76 "></span></a>install_ansible<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-77" name="__codelineno-7-77"></a><a href="#__codelineno-7-77"><span class="linenos" data-linenos=" 77 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;正在安装 Ansible...&quot;</span>
<a id="__codelineno-7-78" name="__codelineno-7-78"></a><a href="#__codelineno-7-78"><span class="linenos" data-linenos=" 78 "></span></a><span class="w">    </span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>pip<span class="w"> </span>setuptools<span class="w"> </span>wheel<span class="w"> </span>cython
<a id="__codelineno-7-79" name="__codelineno-7-79"></a><a href="#__codelineno-7-79"><span class="linenos" data-linenos=" 79 "></span></a><span class="w">    </span>pip<span class="w"> </span>install<span class="w"> </span><span class="s2">&quot;ansible==</span><span class="nv">$ANSIBLE_VERSION</span><span class="s2">&quot;</span><span class="w"> </span>--no-binary<span class="w"> </span>:all:
<a id="__codelineno-7-80" name="__codelineno-7-80"></a><a href="#__codelineno-7-80"><span class="linenos" data-linenos=" 80 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-7-81" name="__codelineno-7-81"></a><a href="#__codelineno-7-81"><span class="linenos" data-linenos=" 81 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Ansible 安装成功。&quot;</span>
<a id="__codelineno-7-82" name="__codelineno-7-82"></a><a href="#__codelineno-7-82"><span class="linenos" data-linenos=" 82 "></span></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-7-83" name="__codelineno-7-83"></a><a href="#__codelineno-7-83"><span class="linenos" data-linenos=" 83 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Ansible 安装失败。&quot;</span>
<a id="__codelineno-7-84" name="__codelineno-7-84"></a><a href="#__codelineno-7-84"><span class="linenos" data-linenos=" 84 "></span></a><span class="w">    </span><span class="k">fi</span>
<a id="__codelineno-7-85" name="__codelineno-7-85"></a><a href="#__codelineno-7-85"><span class="linenos" data-linenos=" 85 "></span></a><span class="o">}</span>
<a id="__codelineno-7-86" name="__codelineno-7-86"></a><a href="#__codelineno-7-86"><span class="linenos" data-linenos=" 86 "></span></a>
<a id="__codelineno-7-87" name="__codelineno-7-87"></a><a href="#__codelineno-7-87"><span class="linenos" data-linenos=" 87 "></span></a>main<span class="o">()</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-7-88" name="__codelineno-7-88"></a><a href="#__codelineno-7-88"><span class="linenos" data-linenos=" 88 "></span></a><span class="w">    </span>install_dependencies
<a id="__codelineno-7-89" name="__codelineno-7-89"></a><a href="#__codelineno-7-89"><span class="linenos" data-linenos=" 89 "></span></a><span class="w">    </span>clean_pyenv
<a id="__codelineno-7-90" name="__codelineno-7-90"></a><a href="#__codelineno-7-90"><span class="linenos" data-linenos=" 90 "></span></a><span class="w">    </span>install_pyenv
<a id="__codelineno-7-91" name="__codelineno-7-91"></a><a href="#__codelineno-7-91"><span class="linenos" data-linenos=" 91 "></span></a><span class="w">    </span>install_python
<a id="__codelineno-7-92" name="__codelineno-7-92"></a><a href="#__codelineno-7-92"><span class="linenos" data-linenos=" 92 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span>check_required_modules<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-7-93" name="__codelineno-7-93"></a><a href="#__codelineno-7-93"><span class="linenos" data-linenos=" 93 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;所有必需的模块已安装。&quot;</span>
<a id="__codelineno-7-94" name="__codelineno-7-94"></a><a href="#__codelineno-7-94"><span class="linenos" data-linenos=" 94 "></span></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-7-95" name="__codelineno-7-95"></a><a href="#__codelineno-7-95"><span class="linenos" data-linenos=" 95 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;有必需的模块未能安装，正在退出...&quot;</span>
<a id="__codelineno-7-96" name="__codelineno-7-96"></a><a href="#__codelineno-7-96"><span class="linenos" data-linenos=" 96 "></span></a><span class="w">        </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-7-97" name="__codelineno-7-97"></a><a href="#__codelineno-7-97"><span class="linenos" data-linenos=" 97 "></span></a><span class="w">    </span><span class="k">fi</span>
<a id="__codelineno-7-98" name="__codelineno-7-98"></a><a href="#__codelineno-7-98"><span class="linenos" data-linenos=" 98 "></span></a><span class="w">    </span>create_virtualenv
<a id="__codelineno-7-99" name="__codelineno-7-99"></a><a href="#__codelineno-7-99"><span class="linenos" data-linenos=" 99 "></span></a><span class="w">    </span>install_ansible
<a id="__codelineno-7-100" name="__codelineno-7-100"></a><a href="#__codelineno-7-100"><span class="linenos" data-linenos="100 "></span></a><span class="o">}</span>
<a id="__codelineno-7-101" name="__codelineno-7-101"></a><a href="#__codelineno-7-101"><span class="linenos" data-linenos="101 "></span></a>
<a id="__codelineno-7-102" name="__codelineno-7-102"></a><a href="#__codelineno-7-102"><span class="linenos" data-linenos="102 "></span></a>main
<a id="__codelineno-7-103" name="__codelineno-7-103"></a><a href="#__codelineno-7-103"><span class="linenos" data-linenos="103 "></span></a>
<a id="__codelineno-7-104" name="__codelineno-7-104"></a><a href="#__codelineno-7-104"><span class="linenos" data-linenos="104 "></span></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Python 3.10、虚拟环境及 Ansible 设置已完成。&quot;</span>
<a id="__codelineno-7-105" name="__codelineno-7-105"></a><a href="#__codelineno-7-105"><span class="linenos" data-linenos="105 "></span></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;要激活虚拟环境，请运行：pyenv activate </span><span class="nv">$VIRTUAL_ENV_NAME</span><span class="s2">&quot;</span>
<a id="__codelineno-7-106" name="__codelineno-7-106"></a><a href="#__codelineno-7-106"><span class="linenos" data-linenos="106 "></span></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;激活虚拟环境后，通过运行 &#39;ansible --version&#39; 来验证 Ansible 是否正确安装。&quot;</span>
</code></pre></div>
<h3 id="4查看ansible版本">4.查看ansible版本<a class="headerlink" href="#4查看ansible版本" title="Permanent link">&para;</a></h3>
<p>执行以下命令查看：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><a href="#__codelineno-8-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>tmp<span class="o">]</span><span class="c1"># ansible --version</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><a href="#__codelineno-8-2"><span class="linenos" data-linenos=" 2 "></span></a>ansible<span class="w"> </span><span class="o">[</span>core<span class="w"> </span><span class="m">2</span>.16.3<span class="o">]</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><a href="#__codelineno-8-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">  </span>config<span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/etc/ansible/ansible.cfg
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><a href="#__codelineno-8-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">  </span>configured<span class="w"> </span>module<span class="w"> </span>search<span class="w"> </span><span class="nv">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="s1">&#39;/root/.ansible/plugins/modules&#39;</span>,<span class="w"> </span><span class="s1">&#39;/usr/share/ansible/plugins/modules&#39;</span><span class="o">]</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><a href="#__codelineno-8-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="w">  </span>ansible<span class="w"> </span>python<span class="w"> </span>module<span class="w"> </span><span class="nv">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/usr/lib/python3.12/site-packages/ansible
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><a href="#__codelineno-8-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="w">  </span>ansible<span class="w"> </span>collection<span class="w"> </span><span class="nv">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/root/.ansible/collections:/usr/share/ansible/collections
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><a href="#__codelineno-8-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="w">  </span>executable<span class="w"> </span><span class="nv">location</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/usr/bin/ansible
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><a href="#__codelineno-8-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">  </span>python<span class="w"> </span><span class="nv">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>.12.1<span class="w"> </span><span class="o">(</span>main,<span class="w"> </span>Feb<span class="w"> </span><span class="m">21</span><span class="w"> </span><span class="m">2024</span>,<span class="w"> </span><span class="m">14</span>:18:26<span class="o">)</span><span class="w"> </span><span class="o">[</span>GCC<span class="w"> </span><span class="m">8</span>.5.0<span class="w"> </span><span class="m">20210514</span><span class="w"> </span><span class="o">(</span>Red<span class="w"> </span>Hat<span class="w"> </span><span class="m">8</span>.5.0-21<span class="o">)]</span><span class="w"> </span><span class="o">(</span>/usr/bin/python3.12<span class="o">)</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><a href="#__codelineno-8-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">  </span>jinja<span class="w"> </span><span class="nv">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>.1.2
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><a href="#__codelineno-8-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">  </span><span class="nv">libyaml</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>True
</code></pre></div>
<p><strong>解释说明：</strong></p>
<blockquote>
<ul>
<li><code>ansible [core 2.16.3]</code>：这是Ansible的核心版本号，表示当前安装的是2.16.3版本的Ansible。</li>
<li><code>config file</code>：配置文件路径。这表示Ansible的主要配置文件位于<code>/etc/ansible/ansible.cfg</code>。</li>
<li><code>configured module search path</code>：模块搜索路径，指明了 Ansible 查找模块的路径，可以在这些路径下添加自定义模块。Ansible会在这些目录中查找自定义模块。</li>
<li><code>ansible python module location</code>：Ansible的Python模块位置，这表示Ansible的Python模块安装在<code>/usr/lib/python3.12/site-packages/ansible</code>目录下。</li>
<li><code>ansible collection location</code>：集合（Collections）位置，Ansible会在这些路径下查找和使用集合。</li>
<li><code>executable location</code>：可执行文件位置，Ansible的可执行文件位于<code>/usr/bin/ansible</code>。</li>
<li><code>python version</code>：Ansible运行在Python 3.12.1环境中，编译器是GCC 8.5.0，具体编译时间是2024年2月21日，Python可执行文件位于<code>/usr/bin/python3.12</code>。</li>
<li><code>jinja version</code>：Jinja2模板引擎版本，Ansible使用的Jinja2版本是3.1.2。</li>
<li><code>libyaml = True</code>：AML库支持。表示Ansible支持libyaml，这可以提高处理YAML文件的性能。</li>
</ul>
</blockquote>
<h2 id="三ansible配置文件">三、Ansible配置文件<a class="headerlink" href="#三ansible配置文件" title="Permanent link">&para;</a></h2>
<p>Ansible 的常见和默认目录结构，用于组织 Ansible 的配置文件、主机清单（inventory）、以及角色（roles）。以下是对这些目录及其用途的详细说明：</p>
<p>ansible配置文件默认是在<code>/etc/ansible</code>目录下。</p>
<h3 id="1主配置文件">1.主配置文件<a class="headerlink" href="#1主配置文件" title="Permanent link">&para;</a></h3>
<p><code>/data/ansible/ansible.cfg</code> 是 Ansible 的主配置文件，用于定义全局设置，如何控制一些行为参数比如并发数、远程连接方式、默认的 inventory 文件位置等。</p>
<p>如果配置文件目录<strong>不存在</strong>或想<strong>更改路径</strong>，可按以下操作进行。</p>
<h4 id="11-创建配置文件目录">1.1 创建配置文件目录<a class="headerlink" href="#11-创建配置文件目录" title="Permanent link">&para;</a></h4>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><a href="#__codelineno-9-1"><span class="linenos" data-linenos="1 "></span></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/data/ansible
</code></pre></div>
<h4 id="12-配置ansiblecfg文件">1.2 配置ansible.cfg文件<a class="headerlink" href="#12-配置ansiblecfg文件" title="Permanent link">&para;</a></h4>
<p>创建<code>vim /data/ansible/ansible.cfg</code>配置文件：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><a href="#__codelineno-10-1"><span class="linenos" data-linenos="1 "></span></a>vim<span class="w"> </span>/data/ansible/ansible.cfg
</code></pre></div>
<p>编辑内容：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><a href="#__codelineno-11-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="o">[</span>defaults<span class="o">]</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><a href="#__codelineno-11-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="nv">inventory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/data/ansible/hosts
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><a href="#__codelineno-11-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="nv">remote_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>root
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><a href="#__codelineno-11-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="nv">host_key_checking</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>False
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><a href="#__codelineno-11-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="nv">retry_files_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>False
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><a href="#__codelineno-11-6"><span class="linenos" data-linenos=" 6 "></span></a>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><a href="#__codelineno-11-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="o">[</span>privilege_escalation<span class="o">]</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><a href="#__codelineno-11-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="nv">become</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>True
<a id="__codelineno-11-9" name="__codelineno-11-9"></a><a href="#__codelineno-11-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="nv">become_method</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>sudo
<a id="__codelineno-11-10" name="__codelineno-11-10"></a><a href="#__codelineno-11-10"><span class="linenos" data-linenos="10 "></span></a><span class="nv">become_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>root
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><a href="#__codelineno-11-11"><span class="linenos" data-linenos="11 "></span></a><span class="nv">become_ask_pass</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>False
<a id="__codelineno-11-12" name="__codelineno-11-12"></a><a href="#__codelineno-11-12"><span class="linenos" data-linenos="12 "></span></a>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><a href="#__codelineno-11-13"><span class="linenos" data-linenos="13 "></span></a><span class="o">[</span>inventory<span class="o">]</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><a href="#__codelineno-11-14"><span class="linenos" data-linenos="14 "></span></a><span class="nv">enable_plugins</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>host_list,<span class="w"> </span>script,<span class="w"> </span>yaml,<span class="w"> </span>ini
</code></pre></div>
<blockquote>
<p><strong><code>[defaults]</code> 部分：</strong></p>
<ul>
<li><code>inventory = /data/ansible/hosts</code>：指定默认的 inventory 文件路径。Ansible 将使用 <code>/data/ansible/hosts</code> 作为主机清单文件，列出所有被管理的主机。</li>
<li><code>remote_user = root</code>：设置默认远程用户为 <code>root</code>。除非在命令行或任务中另行指定，Ansible 会默认使用 <code>root</code> 用户进行连接。</li>
<li><code>host_key_checking = False</code>：关闭 SSH 主机密钥检查。这样可以避免在首次连接到新主机时要求确认其 SSH 密钥（但会降低安全性）。</li>
<li><code>retry_files_enabled = False</code>：禁用重试文件的创建。Ansible 默认在执行失败时生成重试文件，禁用此功能可以避免创建这些文件。</li>
</ul>
<p><strong><code>[privilege_escalation]</code> 部分：</strong></p>
<ul>
<li><code>become = True</code>：启用特权提升（权限提升）。允许在需要时切换到另一个用户（通常是 <code>root</code>）。</li>
<li><code>become_method = sudo</code>：设置特权提升的方法为 <code>sudo</code>。Ansible 将使用 <code>sudo</code> 命令来提升权限。</li>
<li><code>become_user = root</code>：设置特权提升后的目标用户为 <code>root</code>。Ansible 将尝试切换到 <code>root</code> 用户执行任务。</li>
<li><code>become_ask_pass = False</code>：禁用在使用 <code>sudo</code> 提升权限时询问密码。如果 <code>sudo</code> 配置为不需要密码，这项设置将很有用。</li>
</ul>
<p><strong><code>[inventory]</code> 部分：</strong></p>
<ul>
<li><code>enable_plugins</code>：启用指定的 inventory 插件。这些插件允许 Ansible 使用不同格式的主机清单文件：</li>
<li><code>host_list</code>: 处理由逗号分隔的主机列表。</li>
<li><code>script</code>: 允许使用动态 inventory 脚本。</li>
<li><code>yaml</code>: 处理 YAML 格式的 inventory 文件。</li>
<li><code>ini</code>: 处理 INI 格式的 inventory 文件。</li>
</ul>
</blockquote>
<h4 id="13-设置环境变量">1.3 设置环境变量<a class="headerlink" href="#13-设置环境变量" title="Permanent link">&para;</a></h4>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><a href="#__codelineno-12-1"><span class="linenos" data-linenos="1 "></span></a>vim<span class="w"> </span>~/.bashrc
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><a href="#__codelineno-12-2"><span class="linenos" data-linenos="2 "></span></a><span class="nb">export</span><span class="w"> </span><span class="nv">ANSIBLE_CONFIG</span><span class="o">=</span><span class="s2">&quot;/data/ansible/ansible.cfg&quot;</span>
</code></pre></div>
<h4 id="14-重新加载-shell-环境">1.4 重新加载 Shell 环境<a class="headerlink" href="#14-重新加载-shell-环境" title="Permanent link">&para;</a></h4>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><a href="#__codelineno-13-1"><span class="linenos" data-linenos="1 "></span></a><span class="nb">source</span><span class="w"> </span>~/.bashrc
</code></pre></div>
<p>执行<code>ansible --version</code>验证ansible变更，查看config file 是否变更：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><a href="#__codelineno-14-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>ansible<span class="o">]</span><span class="c1"># ansible --version</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><a href="#__codelineno-14-2"><span class="linenos" data-linenos="2 "></span></a>ansible<span class="w"> </span><span class="o">[</span>core<span class="w"> </span><span class="m">2</span>.16.3<span class="o">]</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><a href="#__codelineno-14-3"><span class="linenos" data-linenos="3 "></span></a><span class="w">  </span>config<span class="w"> </span><span class="nv">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>/data/ansible/ansible.cfg
</code></pre></div>
<h3 id="2主机清单">2.主机清单<a class="headerlink" href="#2主机清单" title="Permanent link">&para;</a></h3>
<p><code>/data/ansible/hosts</code> 是 Ansible 的主机清单，即<a href="https://ansible-tran.readthedocs.io/en/latest/docs/intro_inventory.html#id7">Inventory文件</a>。Ansible必须通过Inventory 来管理主机。Ansible 可同时操作属于一个组的多台主机，组和主机之间的关系通过 inventory 文件配置， 默认的文件路径为<code>/etc/ansible/hosts</code>，也可自定义。</p>
<p><strong>语法格式：</strong></p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><a href="#__codelineno-15-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1"># 单台主机</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><a href="#__codelineno-15-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="w">    </span>www.test.com<span class="w">     </span><span class="c1"># FQDN方式</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><a href="#__codelineno-15-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">    </span><span class="m">172</span>.16.1.100<span class="w">      </span><span class="c1"># IP地址</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><a href="#__codelineno-15-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">    </span><span class="m">172</span>.16.1.100:12222<span class="w">  </span><span class="c1"># SSH服务端口不是22时使用</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a><a href="#__codelineno-15-5"><span class="linenos" data-linenos=" 5 "></span></a>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a><a href="#__codelineno-15-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="c1"># 多台主机</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a><a href="#__codelineno-15-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="w">    </span><span class="o">[</span>mysqlServer<span class="o">]</span><span class="w">       </span><span class="c1"># 定义一个组名</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a><a href="#__codelineno-15-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">    </span>mysql.test.com<span class="w">     </span><span class="c1"># FQDN方式 【定义组内单台主机的地址】</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a><a href="#__codelineno-15-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">    </span><span class="m">172</span>.16.1.101<span class="w">        </span><span class="c1"># IP地址</span>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a><a href="#__codelineno-15-10"><span class="linenos" data-linenos="10 "></span></a>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a><a href="#__codelineno-15-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">    </span><span class="o">[</span>webServer<span class="o">]</span>
<a id="__codelineno-15-12" name="__codelineno-15-12"></a><a href="#__codelineno-15-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">    </span><span class="m">172</span>.16.1.100<span class="w">        </span><span class="c1"># 一台主机可以在不同的组内，它同时属于[mysqlServer]组</span>
<a id="__codelineno-15-13" name="__codelineno-15-13"></a><a href="#__codelineno-15-13"><span class="linenos" data-linenos="13 "></span></a>
<a id="__codelineno-15-14" name="__codelineno-15-14"></a><a href="#__codelineno-15-14"><span class="linenos" data-linenos="14 "></span></a><span class="c1"># 组嵌套组</span>
<a id="__codelineno-15-15" name="__codelineno-15-15"></a><a href="#__codelineno-15-15"><span class="linenos" data-linenos="15 "></span></a><span class="w">    </span><span class="o">[</span>group01:Server<span class="o">]</span><span class="w">   </span><span class="c1"># group01为自定义的组名，Server是关键字，固定语法必须填写；</span>
<a id="__codelineno-15-16" name="__codelineno-15-16"></a><a href="#__codelineno-15-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">    </span>mysqlServer<span class="w">          </span><span class="c1"># group01 组内包含的其他组名</span>
<a id="__codelineno-15-17" name="__codelineno-15-17"></a><a href="#__codelineno-15-17"><span class="linenos" data-linenos="17 "></span></a><span class="w">    </span>webServer<span class="w">             </span><span class="c1"># group01 组内包含的其他组名</span>
<a id="__codelineno-15-18" name="__codelineno-15-18"></a><a href="#__codelineno-15-18"><span class="linenos" data-linenos="18 "></span></a>
<a id="__codelineno-15-19" name="__codelineno-15-19"></a><a href="#__codelineno-15-19"><span class="linenos" data-linenos="19 "></span></a><span class="c1"># 有规律的主机地址</span>
<a id="__codelineno-15-20" name="__codelineno-15-20"></a><a href="#__codelineno-15-20"><span class="linenos" data-linenos="20 "></span></a><span class="w">    </span>www.wj<span class="o">[</span><span class="m">01</span>:06<span class="o">]</span>.test.com
<a id="__codelineno-15-21" name="__codelineno-15-21"></a><a href="#__codelineno-15-21"><span class="linenos" data-linenos="21 "></span></a><span class="w">    </span>//相当于：
<a id="__codelineno-15-22" name="__codelineno-15-22"></a><a href="#__codelineno-15-22"><span class="linenos" data-linenos="22 "></span></a><span class="w">    </span>www.wj01.test.com
<a id="__codelineno-15-23" name="__codelineno-15-23"></a><a href="#__codelineno-15-23"><span class="linenos" data-linenos="23 "></span></a><span class="w">    </span>www.wj02.test.com
<a id="__codelineno-15-24" name="__codelineno-15-24"></a><a href="#__codelineno-15-24"><span class="linenos" data-linenos="24 "></span></a><span class="w">    </span>........
<a id="__codelineno-15-25" name="__codelineno-15-25"></a><a href="#__codelineno-15-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">    </span>www.wj06.test.com
<a id="__codelineno-15-26" name="__codelineno-15-26"></a><a href="#__codelineno-15-26"><span class="linenos" data-linenos="26 "></span></a><span class="c1"># 可以定义有规律的ip地址，也可以定义 有规律的字母地址，例如 [a:f]</span>
<a id="__codelineno-15-27" name="__codelineno-15-27"></a><a href="#__codelineno-15-27"><span class="linenos" data-linenos="27 "></span></a>
<a id="__codelineno-15-28" name="__codelineno-15-28"></a><a href="#__codelineno-15-28"><span class="linenos" data-linenos="28 "></span></a><span class="c1"># 还有一个隐藏的组是 [all] 组，不指定机器或组，就默认主机列表中所有机器</span>
</code></pre></div>
<p>默认的主机清单文件，也称为 inventory 文件。它定义了 Ansible 可以管理的所有主机，并且可以将它们组织成不同的组，以便可以针对特定组执行任务。Inventory 文件支持 INI 和 YAML 两种格式，可以根据个人喜好选择编写方式。</p>
<ul>
<li>方括号[]中是组名,用于对系统进行分类,便于对不同系统进行个别的管理；</li>
<li>一个系统可以属于不同的组,比如一台服务器可以同时属于 webserver组 和 dbserver组.这时属于两个组的变量都可以为这台主机所用；</li>
<li>如果有主机的SSH端口不是标准的22端口,可在主机名之后加上端口号,用冒号分隔.SSH 配置文件中列出的端口号不会在 paramiko 连接中使用,会在 openssh 连接中使用；</li>
</ul>
<p>端口号不是默认时，可明确的表示：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><a href="#__codelineno-16-1"><span class="linenos" data-linenos="1 "></span></a>badwolf.example.com:5309
</code></pre></div>
<p><strong>主机列表中的参数说明：</strong></p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><a href="#__codelineno-17-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="w">    </span>ansible_ssh_host
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><a href="#__codelineno-17-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="w">    </span>//将要连接的远程主机名.与你想要设定的主机的别名不同的话,可通过此变量设置.
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><a href="#__codelineno-17-3"><span class="linenos" data-linenos=" 3 "></span></a>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><a href="#__codelineno-17-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">    </span>ansible_ssh_port
<a id="__codelineno-17-5" name="__codelineno-17-5"></a><a href="#__codelineno-17-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="w">    </span>//ssh端口号.如果不是默认的端口号,通过此变量设置.这种可以使用<span class="w"> </span>ip:端口<span class="w"> </span><span class="m">192</span>.168.1.100:2222
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><a href="#__codelineno-17-6"><span class="linenos" data-linenos=" 6 "></span></a>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a><a href="#__codelineno-17-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="w">    </span>ansible_ssh_user
<a id="__codelineno-17-8" name="__codelineno-17-8"></a><a href="#__codelineno-17-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">    </span>//默认的<span class="w"> </span>ssh<span class="w"> </span>用户名
<a id="__codelineno-17-9" name="__codelineno-17-9"></a><a href="#__codelineno-17-9"><span class="linenos" data-linenos=" 9 "></span></a>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a><a href="#__codelineno-17-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">    </span>ansible_ssh_pass
<a id="__codelineno-17-11" name="__codelineno-17-11"></a><a href="#__codelineno-17-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">    </span>//ssh<span class="w"> </span>密码<span class="o">(</span>这种方式并不安全,我们强烈建议使用<span class="w"> </span>--ask-pass<span class="w"> </span>或<span class="w"> </span>SSH<span class="w"> </span>密钥<span class="o">)</span>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a><a href="#__codelineno-17-12"><span class="linenos" data-linenos="12 "></span></a>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a><a href="#__codelineno-17-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">    </span>ansible_sudo_pass
<a id="__codelineno-17-14" name="__codelineno-17-14"></a><a href="#__codelineno-17-14"><span class="linenos" data-linenos="14 "></span></a><span class="w">    </span>//sudo<span class="w"> </span>密码<span class="o">(</span>这种方式并不安全,我们强烈建议使用<span class="w"> </span>--ask-sudo-pass<span class="o">)</span>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a><a href="#__codelineno-17-15"><span class="linenos" data-linenos="15 "></span></a>
<a id="__codelineno-17-16" name="__codelineno-17-16"></a><a href="#__codelineno-17-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">    </span>ansible_sudo_exe<span class="w"> </span><span class="o">(</span>new<span class="w"> </span><span class="k">in</span><span class="w"> </span>version<span class="w"> </span><span class="m">1</span>.8<span class="o">)</span>
<a id="__codelineno-17-17" name="__codelineno-17-17"></a><a href="#__codelineno-17-17"><span class="linenos" data-linenos="17 "></span></a><span class="w">    </span>//sudo<span class="w"> </span>命令路径<span class="o">(</span>适用于1.8及以上版本<span class="o">)</span>
<a id="__codelineno-17-18" name="__codelineno-17-18"></a><a href="#__codelineno-17-18"><span class="linenos" data-linenos="18 "></span></a>
<a id="__codelineno-17-19" name="__codelineno-17-19"></a><a href="#__codelineno-17-19"><span class="linenos" data-linenos="19 "></span></a><span class="w">    </span>ansible_connection
<a id="__codelineno-17-20" name="__codelineno-17-20"></a><a href="#__codelineno-17-20"><span class="linenos" data-linenos="20 "></span></a><span class="w">    </span>//与主机的连接类型.比如:local,<span class="w"> </span>ssh<span class="w"> </span>或者<span class="w"> </span>paramiko.<span class="w"> </span>Ansible<span class="w"> </span><span class="m">1</span>.2<span class="w"> </span>以前默认使用<span class="w"> </span>paramiko.1.2<span class="w"> </span>以后默认使用<span class="w"> </span><span class="s1">&#39;smart&#39;</span>,<span class="s1">&#39;smart&#39;</span><span class="w"> </span>方式会根据是否支持<span class="w"> </span>ControlPersist,<span class="w"> </span>来判断<span class="s1">&#39;ssh&#39;</span><span class="w"> </span>方式是否可行.
<a id="__codelineno-17-21" name="__codelineno-17-21"></a><a href="#__codelineno-17-21"><span class="linenos" data-linenos="21 "></span></a>
<a id="__codelineno-17-22" name="__codelineno-17-22"></a><a href="#__codelineno-17-22"><span class="linenos" data-linenos="22 "></span></a><span class="w">    </span>ansible_ssh_private_key_file
<a id="__codelineno-17-23" name="__codelineno-17-23"></a><a href="#__codelineno-17-23"><span class="linenos" data-linenos="23 "></span></a><span class="w">    </span>//ssh<span class="w"> </span>使用的私钥文件.适用于有多个密钥,而你不想使用<span class="w"> </span>SSH<span class="w"> </span>代理的情况.
<a id="__codelineno-17-24" name="__codelineno-17-24"></a><a href="#__codelineno-17-24"><span class="linenos" data-linenos="24 "></span></a>
<a id="__codelineno-17-25" name="__codelineno-17-25"></a><a href="#__codelineno-17-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">    </span>ansible_shell_type
<a id="__codelineno-17-26" name="__codelineno-17-26"></a><a href="#__codelineno-17-26"><span class="linenos" data-linenos="26 "></span></a><span class="w">    </span>//目标系统的shell类型.默认情况下,命令的执行使用<span class="w"> </span><span class="s1">&#39;sh&#39;</span><span class="w"> </span>语法,可设置为<span class="w"> </span><span class="s1">&#39;csh&#39;</span><span class="w"> </span>或<span class="w"> </span><span class="s1">&#39;fish&#39;</span>.
<a id="__codelineno-17-27" name="__codelineno-17-27"></a><a href="#__codelineno-17-27"><span class="linenos" data-linenos="27 "></span></a>
<a id="__codelineno-17-28" name="__codelineno-17-28"></a><a href="#__codelineno-17-28"><span class="linenos" data-linenos="28 "></span></a><span class="w">    </span>ansible_python_interpreter
<a id="__codelineno-17-29" name="__codelineno-17-29"></a><a href="#__codelineno-17-29"><span class="linenos" data-linenos="29 "></span></a><span class="w">    </span>//目标主机的<span class="w"> </span>python<span class="w"> </span>路径.适用于的情况:<span class="w"> </span>系统中有多个<span class="w"> </span>Python,<span class="w"> </span>或者命令路径不是<span class="s2">&quot;/usr/bin/python&quot;</span>,比如<span class="w">  </span><span class="se">\*</span>BSD,<span class="w"> </span>或者<span class="w"> </span>/usr/bin/python<span class="w"> </span>不是<span class="w"> </span><span class="m">2</span>.X<span class="w"> </span>版本的<span class="w"> </span>Python.
<a id="__codelineno-17-30" name="__codelineno-17-30"></a><a href="#__codelineno-17-30"><span class="linenos" data-linenos="30 "></span></a><span class="w">    </span>//我们不使用<span class="w"> </span><span class="s2">&quot;/usr/bin/env&quot;</span><span class="w"> </span>机制,因为这要求远程用户的路径设置正确,且要求<span class="w"> </span><span class="s2">&quot;python&quot;</span><span class="w"> </span>可执行程序名不可为<span class="w"> </span>python以外的名字<span class="o">(</span>实际有可能名为python26<span class="o">)</span>.
<a id="__codelineno-17-31" name="__codelineno-17-31"></a><a href="#__codelineno-17-31"><span class="linenos" data-linenos="31 "></span></a>
<a id="__codelineno-17-32" name="__codelineno-17-32"></a><a href="#__codelineno-17-32"><span class="linenos" data-linenos="32 "></span></a><span class="w">    </span>//与<span class="w"> </span>ansible_python_interpreter<span class="w"> </span>的工作方式相同,可设定如<span class="w"> </span>ruby<span class="w"> </span>或<span class="w"> </span>perl<span class="w"> </span>的路径....
</code></pre></div>
<h3 id="3存放角色的目录">3.存放角色的目录<a class="headerlink" href="#3存放角色的目录" title="Permanent link">&para;</a></h3>
<p><code>/data/ansible/roles/</code> 是Ansible用来存放角色的目录，角色是一种特殊类型的 Ansible 结构，允许您把复杂的任务分解成更小、更可重用的部分。每个角色通常包含其自己的任务、变量、文件、模板和模块等，这样可以在多个 playbook 中重用。</p>
<p>这些文件目录非必须的，特别是在有特定的文件结构或当 Ansible 安装非全局（例如，在用户级别或使用虚拟环境时）的情况下。但是，使用这些标准目录有助于保持项目的组织性和一致性，尤其是在协作环境中。</p>
<p>如果 Ansible 是通过系统包管理器安装的，通常这些目录会自动创建。如果没有，或者您需要自定义路径，可以手动创建这些目录，并在 <code>ansible.cfg</code> 配置文件中指定这些路径。</p>
<h2 id="四生成ssh密钥">四、生成ssh密钥<a class="headerlink" href="#四生成ssh密钥" title="Permanent link">&para;</a></h2>
<h3 id="1内网服务器">1.内网服务器<a class="headerlink" href="#1内网服务器" title="Permanent link">&para;</a></h3>
<h4 id="11-生成-ssh-密钥对">1.1 生成 SSH 密钥对<a class="headerlink" href="#11-生成-ssh-密钥对" title="Permanent link">&para;</a></h4>
<p>使用 <code>ssh-keygen</code> 工具生成一个新的 SSH 密钥对：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><a href="#__codelineno-18-1"><span class="linenos" data-linenos="1 "></span></a>ssh-keygen<span class="w"> </span>-t<span class="w"> </span>rsa<span class="w"> </span>-b<span class="w"> </span><span class="m">4096</span>
</code></pre></div>
<blockquote>
<ul>
<li><code>ssh-keygen</code>: 用于生成、管理和转换认证密钥的工具。</li>
<li><code>-t rsa</code>: 指定密钥类型为 RSA（Rivest-Shamir-Adleman），这是一种广泛使用的公钥加密算法。</li>
<li><code>-b 4096</code>: 指定密钥长度为 4096 比特，比默认的 2048 比特更安全。</li>
</ul>
</blockquote>
<h4 id="12-查看生成的密钥">1.2 查看生成的密钥<a class="headerlink" href="#12-查看生成的密钥" title="Permanent link">&para;</a></h4>
<p>生成后，有两个文件：一个私钥（默认为 <code>~/.ssh/id_rsa</code>）和一个公钥（默认为 <code>~/.ssh/id_rsa.pub</code>），路径为<code>/root/.ssh/</code>：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><a href="#__codelineno-19-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>.ssh<span class="o">]</span><span class="c1"># ll /root/.ssh/</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><a href="#__codelineno-19-2"><span class="linenos" data-linenos="2 "></span></a>总用量<span class="w"> </span><span class="m">16</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><a href="#__codelineno-19-3"><span class="linenos" data-linenos="3 "></span></a>-rw-------.<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w">  </span><span class="m">746</span><span class="w"> </span>6月<span class="w">   </span><span class="m">5</span><span class="w"> </span><span class="m">11</span>:45<span class="w"> </span>authorized_keys
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><a href="#__codelineno-19-4"><span class="linenos" data-linenos="4 "></span></a>-rw-------.<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w"> </span><span class="m">3381</span><span class="w"> </span>6月<span class="w">  </span><span class="m">14</span><span class="w"> </span><span class="m">14</span>:01<span class="w"> </span>id_rsa
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><a href="#__codelineno-19-5"><span class="linenos" data-linenos="5 "></span></a>-rw-r--r--.<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w">  </span><span class="m">737</span><span class="w"> </span>6月<span class="w">  </span><span class="m">14</span><span class="w"> </span><span class="m">14</span>:01<span class="w"> </span>id_rsa.pub
<a id="__codelineno-19-6" name="__codelineno-19-6"></a><a href="#__codelineno-19-6"><span class="linenos" data-linenos="6 "></span></a>-rw-r--r--.<span class="w"> </span><span class="m">1</span><span class="w"> </span>root<span class="w"> </span>root<span class="w">  </span><span class="m">173</span><span class="w"> </span>6月<span class="w">  </span><span class="m">13</span><span class="w"> </span><span class="m">23</span>:04<span class="w"> </span>known_hosts
</code></pre></div>
<h4 id="13-复制公钥到远程主机">1.3 复制公钥到远程主机<a class="headerlink" href="#13-复制公钥到远程主机" title="Permanent link">&para;</a></h4>
<p>使用<code>ssh-copy-id</code>工具将本地生成的 SSH 公钥复制到远程服务器：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><a href="#__codelineno-20-1"><span class="linenos" data-linenos="1 "></span></a>ssh-copy-id<span class="w"> </span>-i<span class="w"> </span>~/.ssh/id_rsa.pub<span class="w"> </span>root@10.22.51.65
</code></pre></div>
<blockquote>
<ul>
<li><code>ssh-copy-id</code>: 一个用于将本地 SSH 公钥复制到远程主机的工具。</li>
<li><code>-i ~/.ssh/id_rsa.pub</code>: 指定要复制的公钥文件。默认情况下，SSH 公钥文件存储在 <code>~/.ssh/id_rsa.pub</code>。</li>
</ul>
</blockquote>
<p>执行上述命令后，会有一些信息输出如下：</p>
<ul>
<li><strong>验证远程主机的真实性：</strong></li>
</ul>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><a href="#__codelineno-21-1"><span class="linenos" data-linenos="1 "></span></a>The<span class="w"> </span>authenticity<span class="w"> </span>of<span class="w"> </span>host<span class="w"> </span><span class="s1">&#39;10.22.51.65 (10.22.51.65)&#39;</span><span class="w"> </span>can<span class="err">&#39;</span>t<span class="w"> </span>be<span class="w"> </span>established.
<a id="__codelineno-21-2" name="__codelineno-21-2"></a><a href="#__codelineno-21-2"><span class="linenos" data-linenos="2 "></span></a>ECDSA<span class="w"> </span>key<span class="w"> </span>fingerprint<span class="w"> </span>is<span class="w"> </span>SHA256:ToyzHGYadimKzbP/giKpcaVr/U4F84WYc7e8y+yM6yw.
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><a href="#__codelineno-21-3"><span class="linenos" data-linenos="3 "></span></a>Are<span class="w"> </span>you<span class="w"> </span>sure<span class="w"> </span>you<span class="w"> </span>want<span class="w"> </span>to<span class="w"> </span><span class="k">continue</span><span class="w"> </span>connecting<span class="w"> </span><span class="o">(</span>yes/no/<span class="o">[</span>fingerprint<span class="o">])</span>?<span class="w"> </span>yes
</code></pre></div>
<p>系统提示你确认远程主机的真实性。这是因为这是你第一次连接到该主机，SSH 客户端无法验证其身份。输入 <code>yes</code> 继续连接。</p>
<ul>
<li><strong>安装公钥：</strong></li>
</ul>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><a href="#__codelineno-22-1"><span class="linenos" data-linenos="1 "></span></a>/usr/bin/ssh-copy-id:<span class="w"> </span>INFO:<span class="w"> </span>attempting<span class="w"> </span>to<span class="w"> </span>log<span class="w"> </span><span class="k">in</span><span class="w"> </span>with<span class="w"> </span>the<span class="w"> </span>new<span class="w"> </span>key<span class="o">(</span>s<span class="o">)</span>,<span class="w"> </span>to<span class="w"> </span>filter<span class="w"> </span>out<span class="w"> </span>any<span class="w"> </span>that<span class="w"> </span>are<span class="w"> </span>already<span class="w"> </span>installed
<a id="__codelineno-22-2" name="__codelineno-22-2"></a><a href="#__codelineno-22-2"><span class="linenos" data-linenos="2 "></span></a>/usr/bin/ssh-copy-id:<span class="w"> </span>INFO:<span class="w"> </span><span class="m">1</span><span class="w"> </span>key<span class="o">(</span>s<span class="o">)</span><span class="w"> </span>remain<span class="w"> </span>to<span class="w"> </span>be<span class="w"> </span>installed<span class="w"> </span>--<span class="w"> </span><span class="k">if</span><span class="w"> </span>you<span class="w"> </span>are<span class="w"> </span>prompted<span class="w"> </span>now<span class="w"> </span>it<span class="w"> </span>is<span class="w"> </span>to<span class="w"> </span>install<span class="w"> </span>the<span class="w"> </span>new<span class="w"> </span>keys
<a id="__codelineno-22-3" name="__codelineno-22-3"></a><a href="#__codelineno-22-3"><span class="linenos" data-linenos="3 "></span></a>Password:
</code></pre></div>
<p>系统尝试使用新密钥登录，并提示你输入远程服务器 <code>root</code> 用户的密码，以便将公钥安装到远程服务器。</p>
<ul>
<li><strong>成功添加公钥：</strong></li>
</ul>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><a href="#__codelineno-23-1"><span class="linenos" data-linenos="1 "></span></a>Number<span class="w"> </span>of<span class="w"> </span>key<span class="o">(</span>s<span class="o">)</span><span class="w"> </span>added:<span class="w"> </span><span class="m">1</span>
</code></pre></div>
<p>这表示公钥已成功添加到远程服务器的 <code>~/.ssh/authorized_keys</code> 文件中。</p>
<ul>
<li><strong>验证无密码登录：</strong></li>
</ul>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><a href="#__codelineno-24-1"><span class="linenos" data-linenos="1 "></span></a>Now<span class="w"> </span>try<span class="w"> </span>logging<span class="w"> </span>into<span class="w"> </span>the<span class="w"> </span>machine,<span class="w"> </span>with:<span class="w">   </span><span class="s2">&quot;ssh &#39;root@10.22.51.65&#39;&quot;</span>
</code></pre></div>
<p>现在可以尝试无密码登录远程服务器，以确保公钥认证配置正确。</p>
<h4 id="14-无密钥登录测试">1.4 无密钥登录测试<a class="headerlink" href="#14-无密钥登录测试" title="Permanent link">&para;</a></h4>
<p>使用<code>ssh</code>命令登录远程服务器：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><a href="#__codelineno-25-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>.ssh<span class="o">]</span><span class="c1"># ssh root@10.22.51.65</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a><a href="#__codelineno-25-2"><span class="linenos" data-linenos="2 "></span></a>Last<span class="w"> </span>login:<span class="w"> </span>Fri<span class="w"> </span>Jun<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">14</span>:07:35<span class="w"> </span><span class="m">2024</span><span class="w"> </span>from<span class="w"> </span><span class="m">10</span>.18.88.135
<a id="__codelineno-25-3" name="__codelineno-25-3"></a><a href="#__codelineno-25-3"><span class="linenos" data-linenos="3 "></span></a><span class="o">[</span>root@zhongjl-test-02<span class="w"> </span>/root<span class="o">]</span><span class="c1"># </span>
</code></pre></div>
<h3 id="2云服务器">2.云服务器<a class="headerlink" href="#2云服务器" title="Permanent link">&para;</a></h3>
<p>云服务器除了要复制公钥过来，还要配置一些权限。</p>
<blockquote>
<p>内网端：10.22.51.63</p>
<p>远端配置：120.78.156.217 &amp;&amp; 47.113.113.48</p>
</blockquote>
<h4 id="21-复制公钥到远程主机">2.1 复制公钥到远程主机<a class="headerlink" href="#21-复制公钥到远程主机" title="Permanent link">&para;</a></h4>
<p>使用<code>ssh-copy-id</code>工具将本地生成的 SSH 公钥复制到远程服务器：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><a href="#__codelineno-26-1"><span class="linenos" data-linenos="1 "></span></a>ssh-copy-id<span class="w"> </span>-i<span class="w"> </span>~/.ssh/id_rsa.pub<span class="w"> </span>root@120.78.156.217
<a id="__codelineno-26-2" name="__codelineno-26-2"></a><a href="#__codelineno-26-2"><span class="linenos" data-linenos="2 "></span></a>ssh-copy-id<span class="w"> </span>-i<span class="w"> </span>~/.ssh/id_rsa.pub<span class="w"> </span>root@47.113.113.48
</code></pre></div>
<h4 id="22-修改-sshd_config-配置文件">2.2 修改 sshd_config 配置文件<a class="headerlink" href="#22-修改-sshd_config-配置文件" title="Permanent link">&para;</a></h4>
<p>远程服务器的 SSH 配置允许使用密钥登录。查看 <code>/etc/ssh/sshd_config</code> 文件，确认以下设置：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><a href="#__codelineno-27-1"><span class="linenos" data-linenos="1 "></span></a>PubkeyAuthentication<span class="w"> </span>yes<span class="w">        </span><span class="c1">#权限给够，有些可以不用开启</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><a href="#__codelineno-27-2"><span class="linenos" data-linenos="2 "></span></a>AuthorizedKeysFile<span class="w"> </span>.ssh/authorized_keys
</code></pre></div>
<blockquote>
<ul>
<li><strong>启用公钥认证</strong>：这行配置确保 SSH 服务启用了公钥认证。</li>
<li><strong>指定授权密钥文件</strong>：这行配置指定了存放公钥的文件路径，相对于用户的主目录。</li>
</ul>
</blockquote>
<h4 id="23-重启-ssh-服务">2.3 重启 SSH 服务<a class="headerlink" href="#23-重启-ssh-服务" title="Permanent link">&para;</a></h4>
<p>进行了更改，需要重启 SSH 服务：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><a href="#__codelineno-28-1"><span class="linenos" data-linenos="1 "></span></a>systemctl<span class="w"> </span>restart<span class="w"> </span>sshd
</code></pre></div>
<h4 id="24-修改-root-目录及文件的权限">2.4 修改 root 目录及文件的权限<a class="headerlink" href="#24-修改-root-目录及文件的权限" title="Permanent link">&para;</a></h4>
<p>远程的服务器权限配置：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><a href="#__codelineno-29-1"><span class="linenos" data-linenos="1 "></span></a>chmod<span class="w"> </span><span class="m">700</span><span class="w"> </span>/root
<a id="__codelineno-29-2" name="__codelineno-29-2"></a><a href="#__codelineno-29-2"><span class="linenos" data-linenos="2 "></span></a>chmod<span class="w"> </span><span class="m">700</span><span class="w"> </span>/root/.ssh
<a id="__codelineno-29-3" name="__codelineno-29-3"></a><a href="#__codelineno-29-3"><span class="linenos" data-linenos="3 "></span></a>chmod<span class="w"> </span><span class="m">600</span><span class="w"> </span>/root/.ssh/authorized_keys
</code></pre></div>
<blockquote>
<ul>
<li><code>/root</code> 目录的权限应该足够严格。通常建议的权限是 <code>750</code> 或 <code>700</code>。</li>
<li><code>/root/.ssh</code> 目录应该有 <code>700</code> 的权限。</li>
<li><code>/root/.ssh/authorized_keys</code> 文件应该有 <code>600</code> 的权限。</li>
</ul>
</blockquote>
<p>如果仍然报错，监听ssh日志分析问题：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><a href="#__codelineno-30-1"><span class="linenos" data-linenos="1 "></span></a>tail<span class="w"> </span>-f<span class="w"> </span>/var/log/secure
</code></pre></div>
<h4 id="25-无密钥登录测试">2.5 无密钥登录测试<a class="headerlink" href="#25-无密钥登录测试" title="Permanent link">&para;</a></h4>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><a href="#__codelineno-31-1"><span class="linenos" data-linenos="1 "></span></a>ssh<span class="w"> </span>root@120.78.156.217
<a id="__codelineno-31-2" name="__codelineno-31-2"></a><a href="#__codelineno-31-2"><span class="linenos" data-linenos="2 "></span></a>ssh<span class="w"> </span>root@47.113.113.48
</code></pre></div>
<h2 id="五ansible使用">五、ansible使用<a class="headerlink" href="#五ansible使用" title="Permanent link">&para;</a></h2>
<h3 id="1创建ansible项目目录">1.创建ansible项目目录<a class="headerlink" href="#1创建ansible项目目录" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a><a href="#__codelineno-32-1"><span class="linenos" data-linenos="1 "></span></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/data/ansible/inventories
<a id="__codelineno-32-2" name="__codelineno-32-2"></a><a href="#__codelineno-32-2"><span class="linenos" data-linenos="2 "></span></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/data/ansible/playbooks
<a id="__codelineno-32-3" name="__codelineno-32-3"></a><a href="#__codelineno-32-3"><span class="linenos" data-linenos="3 "></span></a>mkdir<span class="w"> </span>-p<span class="w"> </span>/data/ansible/roles
</code></pre></div>
<p>查看目录结构：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><a href="#__codelineno-33-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># tree /data/ansible</span>
<a id="__codelineno-33-2" name="__codelineno-33-2"></a><a href="#__codelineno-33-2"><span class="linenos" data-linenos="2 "></span></a>/data/ansible
<a id="__codelineno-33-3" name="__codelineno-33-3"></a><a href="#__codelineno-33-3"><span class="linenos" data-linenos="3 "></span></a>├──<span class="w"> </span>ansible.cfg
<a id="__codelineno-33-4" name="__codelineno-33-4"></a><a href="#__codelineno-33-4"><span class="linenos" data-linenos="4 "></span></a>├──<span class="w"> </span>inventories
<a id="__codelineno-33-5" name="__codelineno-33-5"></a><a href="#__codelineno-33-5"><span class="linenos" data-linenos="5 "></span></a>├──<span class="w"> </span>playbooks
<a id="__codelineno-33-6" name="__codelineno-33-6"></a><a href="#__codelineno-33-6"><span class="linenos" data-linenos="6 "></span></a>└──<span class="w"> </span>roles
</code></pre></div>
<blockquote>
<ul>
<li><code>inventories/</code>：目录存放不同环境（如生产、预生产、开发）的 Inventory 文件。</li>
<li><code>playbooks/</code>：目录存放所有 Playbook 文件。</li>
</ul>
</blockquote>
<h3 id="2主机清单inventory">2.主机清单inventory<a class="headerlink" href="#2主机清单inventory" title="Permanent link">&para;</a></h3>
<h4 id="21-修改-hosts-文件">2.1 修改 hosts 文件<a class="headerlink" href="#21-修改-hosts-文件" title="Permanent link">&para;</a></h4>
<p>修改Ansible 的主机清单（inventory）文件的内容，编辑 <code>vim /data/ansible/hosts</code>文件：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><a href="#__codelineno-34-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>web_servers<span class="o">]</span>
<a id="__codelineno-34-2" name="__codelineno-34-2"></a><a href="#__codelineno-34-2"><span class="linenos" data-linenos="2 "></span></a><span class="m">10</span>.22.51.65
<a id="__codelineno-34-3" name="__codelineno-34-3"></a><a href="#__codelineno-34-3"><span class="linenos" data-linenos="3 "></span></a>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a><a href="#__codelineno-34-4"><span class="linenos" data-linenos="4 "></span></a><span class="o">[</span>database_servers<span class="o">]</span>
<a id="__codelineno-34-5" name="__codelineno-34-5"></a><a href="#__codelineno-34-5"><span class="linenos" data-linenos="5 "></span></a>db1.example.com
<a id="__codelineno-34-6" name="__codelineno-34-6"></a><a href="#__codelineno-34-6"><span class="linenos" data-linenos="6 "></span></a>
<a id="__codelineno-34-7" name="__codelineno-34-7"></a><a href="#__codelineno-34-7"><span class="linenos" data-linenos="7 "></span></a><span class="o">[</span>all:vars<span class="o">]</span>
<a id="__codelineno-34-8" name="__codelineno-34-8"></a><a href="#__codelineno-34-8"><span class="linenos" data-linenos="8 "></span></a><span class="nv">ansible_user</span><span class="o">=</span>root
<a id="__codelineno-34-9" name="__codelineno-34-9"></a><a href="#__codelineno-34-9"><span class="linenos" data-linenos="9 "></span></a><span class="nv">ansible_ssh_private_key_file</span><span class="o">=</span>/root/.ssh/id_rsa
</code></pre></div>
<p><strong>解释说明：</strong></p>
<ul>
<li><code>[web_servers]</code>：这一行定义了一个名为 <code>web_servers</code> 的组，该组用于存放所有的 Web 服务器。在这个例子中，<code>10.22.51.65</code> 是该组下唯一的成员。这意味着任何针对 <code>web_servers</code> 组的 Ansible 任务都将只对这个 IP 地址为 <code>10.22.51.65</code> 的服务器执行。</li>
<li><code>[database_servers]</code>：同样地，这一行定义了一个名为 <code>database_servers</code> 的组，用于分类所有数据库服务器。<code>db1.example.com</code> 是这个组的成员，表示任何针对 <code>database_servers</code> 组的任务将只对这个主机名为 <code>db1.example.com</code> 的服务器执行。</li>
<li><code>[all:vars]</code>：这部分定义了适用于所有主机的组变量。</li>
<li><code>ansible_user=root</code>：定义了连接到所有主机时使用的默认用户名为 <code>root</code>。</li>
<li><code>ansible_ssh_private_key_file=/root/.ssh/id_rsa</code>：指定了用于 SSH 连接的私钥文件路径。</li>
</ul>
<p><strong>使用场景：</strong></p>
<p>通过这样的组织方式，您可以针对不同类型的服务器执行特定的配置和管理任务。例如，您可能希望对所有 Web 服务器执行一些安全更新，而对数据库服务器执行不同的备份操作。这可以通过 Ansible playbooks 实现，其中您可以指定对哪个组执行哪些任务。</p>
<p><strong>组变量设置含义：</strong></p>
<ul>
<li>
<p>所有主机（无论是 <code>web_servers</code> 还是 <code>database_servers</code>）都将使用 <code>root</code> 用户和 <code>/root/.ssh/id_rsa</code> 作为 SSH 密钥文件。</p>
</li>
<li>
<p>不需要在每个主机项下重复这些 SSH 相关的设置。</p>
</li>
</ul>
<p>去除掉<code>[all:vars]</code>的另一种写法，编辑<code>vim /data/ansible/hosts</code>文件：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><a href="#__codelineno-35-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>web_servers<span class="o">]</span>
<a id="__codelineno-35-2" name="__codelineno-35-2"></a><a href="#__codelineno-35-2"><span class="linenos" data-linenos="2 "></span></a><span class="m">10</span>.22.51.65<span class="w"> </span><span class="nv">ansible_ssh_user</span><span class="o">=</span>root<span class="w"> </span><span class="nv">ansible_ssh_private_key_file</span><span class="o">=</span>/root/.ssh/id_rsa
<a id="__codelineno-35-3" name="__codelineno-35-3"></a><a href="#__codelineno-35-3"><span class="linenos" data-linenos="3 "></span></a>
<a id="__codelineno-35-4" name="__codelineno-35-4"></a><a href="#__codelineno-35-4"><span class="linenos" data-linenos="4 "></span></a><span class="o">[</span>database_servers<span class="o">]</span>
<a id="__codelineno-35-5" name="__codelineno-35-5"></a><a href="#__codelineno-35-5"><span class="linenos" data-linenos="5 "></span></a>db1.example.com<span class="w"> </span><span class="nv">ansible_ssh_user</span><span class="o">=</span>root<span class="w"> </span><span class="nv">ansible_ssh_private_key_file</span><span class="o">=</span>/root/.ssh/id_rsa
</code></pre></div>
<h4 id="22-测试-inventory-文件">2.2 测试 Inventory 文件<a class="headerlink" href="#22-测试-inventory-文件" title="Permanent link">&para;</a></h4>
<p>执行以下命令：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a><a href="#__codelineno-36-1"><span class="linenos" data-linenos="1 "></span></a>ansible-inventory<span class="w"> </span>--list
</code></pre></div>
<p>如果 inventory 正确无误，输出将类似于：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a><a href="#__codelineno-37-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="o">{</span>
<a id="__codelineno-37-2" name="__codelineno-37-2"></a><a href="#__codelineno-37-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="w">    </span><span class="s2">&quot;_meta&quot;</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-37-3" name="__codelineno-37-3"></a><a href="#__codelineno-37-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">        </span><span class="s2">&quot;hostvars&quot;</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-37-4" name="__codelineno-37-4"></a><a href="#__codelineno-37-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">            </span><span class="s2">&quot;10.22.51.65&quot;</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-37-5" name="__codelineno-37-5"></a><a href="#__codelineno-37-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="w">                </span><span class="s2">&quot;ansible_ssh_private_key_file&quot;</span>:<span class="w"> </span><span class="s2">&quot;/root/.ssh/id_rsa&quot;</span>,
<a id="__codelineno-37-6" name="__codelineno-37-6"></a><a href="#__codelineno-37-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="w">                </span><span class="s2">&quot;ansible_user&quot;</span>:<span class="w"> </span><span class="s2">&quot;root&quot;</span>
<a id="__codelineno-37-7" name="__codelineno-37-7"></a><a href="#__codelineno-37-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="w">            </span><span class="o">}</span>,
<a id="__codelineno-37-8" name="__codelineno-37-8"></a><a href="#__codelineno-37-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">            </span><span class="s2">&quot;db1.example.com&quot;</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-37-9" name="__codelineno-37-9"></a><a href="#__codelineno-37-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">                </span><span class="s2">&quot;ansible_ssh_private_key_file&quot;</span>:<span class="w"> </span><span class="s2">&quot;/root/.ssh/id_rsa&quot;</span>,
<a id="__codelineno-37-10" name="__codelineno-37-10"></a><a href="#__codelineno-37-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">                </span><span class="s2">&quot;ansible_user&quot;</span>:<span class="w"> </span><span class="s2">&quot;root&quot;</span>
<a id="__codelineno-37-11" name="__codelineno-37-11"></a><a href="#__codelineno-37-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">            </span><span class="o">}</span>
<a id="__codelineno-37-12" name="__codelineno-37-12"></a><a href="#__codelineno-37-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">        </span><span class="o">}</span>
<a id="__codelineno-37-13" name="__codelineno-37-13"></a><a href="#__codelineno-37-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">    </span><span class="o">}</span>,
<a id="__codelineno-37-14" name="__codelineno-37-14"></a><a href="#__codelineno-37-14"><span class="linenos" data-linenos="14 "></span></a><span class="w">    </span><span class="s2">&quot;all&quot;</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-37-15" name="__codelineno-37-15"></a><a href="#__codelineno-37-15"><span class="linenos" data-linenos="15 "></span></a><span class="w">        </span><span class="s2">&quot;children&quot;</span>:<span class="w"> </span><span class="o">[</span>
<a id="__codelineno-37-16" name="__codelineno-37-16"></a><a href="#__codelineno-37-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">            </span><span class="s2">&quot;database_servers&quot;</span>,
<a id="__codelineno-37-17" name="__codelineno-37-17"></a><a href="#__codelineno-37-17"><span class="linenos" data-linenos="17 "></span></a><span class="w">            </span><span class="s2">&quot;ungrouped&quot;</span>,
<a id="__codelineno-37-18" name="__codelineno-37-18"></a><a href="#__codelineno-37-18"><span class="linenos" data-linenos="18 "></span></a><span class="w">            </span><span class="s2">&quot;web_servers&quot;</span>
<a id="__codelineno-37-19" name="__codelineno-37-19"></a><a href="#__codelineno-37-19"><span class="linenos" data-linenos="19 "></span></a><span class="w">        </span><span class="o">]</span>
<a id="__codelineno-37-20" name="__codelineno-37-20"></a><a href="#__codelineno-37-20"><span class="linenos" data-linenos="20 "></span></a><span class="w">    </span><span class="o">}</span>,
<a id="__codelineno-37-21" name="__codelineno-37-21"></a><a href="#__codelineno-37-21"><span class="linenos" data-linenos="21 "></span></a><span class="w">    </span><span class="s2">&quot;database_servers&quot;</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-37-22" name="__codelineno-37-22"></a><a href="#__codelineno-37-22"><span class="linenos" data-linenos="22 "></span></a><span class="w">        </span><span class="s2">&quot;hosts&quot;</span>:<span class="w"> </span><span class="o">[</span>
<a id="__codelineno-37-23" name="__codelineno-37-23"></a><a href="#__codelineno-37-23"><span class="linenos" data-linenos="23 "></span></a><span class="w">            </span><span class="s2">&quot;db1.example.com&quot;</span>
<a id="__codelineno-37-24" name="__codelineno-37-24"></a><a href="#__codelineno-37-24"><span class="linenos" data-linenos="24 "></span></a><span class="w">        </span><span class="o">]</span>
<a id="__codelineno-37-25" name="__codelineno-37-25"></a><a href="#__codelineno-37-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">    </span><span class="o">}</span>,
<a id="__codelineno-37-26" name="__codelineno-37-26"></a><a href="#__codelineno-37-26"><span class="linenos" data-linenos="26 "></span></a><span class="w">    </span><span class="s2">&quot;web_servers&quot;</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-37-27" name="__codelineno-37-27"></a><a href="#__codelineno-37-27"><span class="linenos" data-linenos="27 "></span></a><span class="w">        </span><span class="s2">&quot;hosts&quot;</span>:<span class="w"> </span><span class="o">[</span>
<a id="__codelineno-37-28" name="__codelineno-37-28"></a><a href="#__codelineno-37-28"><span class="linenos" data-linenos="28 "></span></a><span class="w">            </span><span class="s2">&quot;10.22.51.65&quot;</span>
<a id="__codelineno-37-29" name="__codelineno-37-29"></a><a href="#__codelineno-37-29"><span class="linenos" data-linenos="29 "></span></a><span class="w">        </span><span class="o">]</span>
<a id="__codelineno-37-30" name="__codelineno-37-30"></a><a href="#__codelineno-37-30"><span class="linenos" data-linenos="30 "></span></a><span class="w">    </span><span class="o">}</span>
<a id="__codelineno-37-31" name="__codelineno-37-31"></a><a href="#__codelineno-37-31"><span class="linenos" data-linenos="31 "></span></a><span class="o">}</span>
</code></pre></div>
<h3 id="3ansible测试ping">3.ansible测试ping<a class="headerlink" href="#3ansible测试ping" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><a href="#__codelineno-38-1"><span class="linenos" data-linenos="1 "></span></a>ansible<span class="w"> </span><span class="m">10</span>.22.51.65<span class="w"> </span>-m<span class="w"> </span>ping<span class="w">         </span><span class="c1"># 单台执行</span>
<a id="__codelineno-38-2" name="__codelineno-38-2"></a><a href="#__codelineno-38-2"><span class="linenos" data-linenos="2 "></span></a>ansible<span class="w"> </span>web_servers<span class="w"> </span>-m<span class="w"> </span>ping<span class="w">         </span><span class="c1"># ping web_servers组</span>
<a id="__codelineno-38-3" name="__codelineno-38-3"></a><a href="#__codelineno-38-3"><span class="linenos" data-linenos="3 "></span></a>ansible<span class="w"> </span>all<span class="w"> </span>-m<span class="w"> </span>ping<span class="w">                 </span><span class="c1"># ping全部</span>
</code></pre></div>
<p>执行后输出信息如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1"></a><a href="#__codelineno-39-1"><span class="linenos" data-linenos="1 "></span></a><span class="m">10</span>.22.51.65<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">SUCCESS</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-39-2" name="__codelineno-39-2"></a><a href="#__codelineno-39-2"><span class="linenos" data-linenos="2 "></span></a><span class="w">    </span><span class="s2">&quot;ansible_facts&quot;</span>:<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-39-3" name="__codelineno-39-3"></a><a href="#__codelineno-39-3"><span class="linenos" data-linenos="3 "></span></a><span class="w">        </span><span class="s2">&quot;discovered_interpreter_python&quot;</span>:<span class="w"> </span><span class="s2">&quot;/usr/bin/python&quot;</span>
<a id="__codelineno-39-4" name="__codelineno-39-4"></a><a href="#__codelineno-39-4"><span class="linenos" data-linenos="4 "></span></a><span class="w">    </span><span class="o">}</span>,
<a id="__codelineno-39-5" name="__codelineno-39-5"></a><a href="#__codelineno-39-5"><span class="linenos" data-linenos="5 "></span></a><span class="w">    </span><span class="s2">&quot;changed&quot;</span>:<span class="w"> </span>false,
<a id="__codelineno-39-6" name="__codelineno-39-6"></a><a href="#__codelineno-39-6"><span class="linenos" data-linenos="6 "></span></a><span class="w">    </span><span class="s2">&quot;ping&quot;</span>:<span class="w"> </span><span class="s2">&quot;pong&quot;</span>
<a id="__codelineno-39-7" name="__codelineno-39-7"></a><a href="#__codelineno-39-7"><span class="linenos" data-linenos="7 "></span></a><span class="o">}</span>
</code></pre></div>
<p><strong>解释输出：</strong></p>
<p>Ansible 成功通过 SSH 连接到了位于 <code>10.22.51.65</code> 的服务器，并且执行了 <code>ping</code> 模块。这表示您的配置正确，Ansible 能够利用指定的 SSH 私钥和用户身份（在这里是 root 用户）顺利连接到远程主机。</p>
<blockquote>
<ul>
<li><code>"ansible_facts"</code>：包含 Ansible 自动发现的有关目标主机的各种信息。</li>
<li><code>"discovered_interpreter_python": "/usr/bin/python"</code>：这表示 Ansible 在远程主机上自动发现了 Python 解释器的路径。Ansible 使用 Python 来执行其模块，因此需要在目标机器上找到 Python 解释器。</li>
<li><code>"changed": false</code>：表示此次操作没有对目标主机做任何更改。<code>ping</code> 模块只是用于测试连接性，所以不会对主机进行更改。</li>
<li><code>"ping": "pong"</code>：表示 <code>ping</code> 模块的返回结果是 <code>pong</code>，这是 <code>ping</code> 模块的标准响应，表示远程主机可达并响应 Ansible 的请求。</li>
</ul>
</blockquote>
<h3 id="4编写playbook测试">4.编写Playbook测试<a class="headerlink" href="#4编写playbook测试" title="Permanent link">&para;</a></h3>
<h4 id="41-创建-playbook-文件">4.1 创建 Playbook 文件<a class="headerlink" href="#41-创建-playbook-文件" title="Permanent link">&para;</a></h4>
<p>创建一个<code>Playbook</code>文件，来检查远程服务器的磁盘空间：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1"></a><a href="#__codelineno-40-1"><span class="linenos" data-linenos="1 "></span></a>vim<span class="w"> </span>/data/ansible/playbooks/check_disk_space.yml
</code></pre></div>
<p>添加以下内容：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1"></a><a href="#__codelineno-41-1"><span class="linenos" data-linenos=" 1 "></span></a>-<span class="w"> </span>name:<span class="w"> </span>Check<span class="w"> </span>disk<span class="w"> </span>space
<a id="__codelineno-41-2" name="__codelineno-41-2"></a><a href="#__codelineno-41-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="w">  </span><span class="c1">#hosts: web_servers</span>
<a id="__codelineno-41-3" name="__codelineno-41-3"></a><a href="#__codelineno-41-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">  </span>hosts:<span class="w"> </span>all
<a id="__codelineno-41-4" name="__codelineno-41-4"></a><a href="#__codelineno-41-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">  </span>tasks:
<a id="__codelineno-41-5" name="__codelineno-41-5"></a><a href="#__codelineno-41-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="w">    </span>-<span class="w"> </span>name:<span class="w"> </span>Disk<span class="w"> </span>free<span class="w"> </span>space
<a id="__codelineno-41-6" name="__codelineno-41-6"></a><a href="#__codelineno-41-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="w">      </span>command:<span class="w"> </span>df<span class="w"> </span>-Th
<a id="__codelineno-41-7" name="__codelineno-41-7"></a><a href="#__codelineno-41-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="w">      </span>register:<span class="w"> </span>disk_space
<a id="__codelineno-41-8" name="__codelineno-41-8"></a><a href="#__codelineno-41-8"><span class="linenos" data-linenos=" 8 "></span></a>
<a id="__codelineno-41-9" name="__codelineno-41-9"></a><a href="#__codelineno-41-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">    </span>-<span class="w"> </span>name:<span class="w"> </span>Show<span class="w"> </span>disk<span class="w"> </span>space
<a id="__codelineno-41-10" name="__codelineno-41-10"></a><a href="#__codelineno-41-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">      </span>debug:
<a id="__codelineno-41-11" name="__codelineno-41-11"></a><a href="#__codelineno-41-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">        </span>msg:<span class="w"> </span><span class="s2">&quot;{{ disk_space.stdout }}&quot;</span>
</code></pre></div>
<p><strong>解释说明：</strong></p>
<blockquote>
<p>这个 Ansible Playbook 文件定义了一个名为“Check disk space”的任务，它执行两个具体的任务来检查并显示所有主机的磁盘空间。以下是每个部分的详细描述：</p>
<ul>
<li>
<p><strong>顶层定义：</strong></p>
</li>
<li>
<p><code>- name: Check disk space</code>：这是 Playbook 的名称，用于描述该 Playbook 的总体目的，即检查磁盘空间。</p>
</li>
<li>
<p><code>hosts: all</code>：指定此 Playbook 将应用到所有主机（<code>all</code>）。如果只需要应用于 <code>web_servers</code> 组，可以将这行改为 <code>hosts: web_servers</code>。</p>
</li>
<li>
<p><strong>任务列表（tasks）：</strong></p>
</li>
</ul>
<p>Playbook 包含两个任务：</p>
<ul>
<li><strong>检查磁盘空间：</strong><ul>
<li><code>name: Disk free space</code>：任务的名称，用于描述该任务的目的，即检查磁盘剩余空间。</li>
<li><code>command: df -Th</code>：使用 <code>command</code> 模块执行 <code>df -Th</code> 命令。<code>df -Th</code> 命令会以人类可读的格式显示文件系统的磁盘使用情况。</li>
<li><code>register: disk_space</code>：将命令的输出结果注册到变量 <code>disk_space</code> 中，以便在后续任务中使用。</li>
</ul>
</li>
<li><strong>显示磁盘空间：</strong><ul>
<li><code>name: Show disk space</code>：任务的名称，用于描述该任务的目的，即显示磁盘剩余空间。</li>
<li><code>debug</code>：使用 <code>debug</code> 模块显示信息。</li>
<li><code>msg: "{{ disk_space.stdout }}"</code>：显示 <code>disk_space</code> 变量的 <code>stdout</code> 属性，即 <code>df -Th</code> 命令的标准输出内容。</li>
</ul>
</li>
</ul>
</blockquote>
<h4 id="42-执行-playbook-文件">4.2 执行 Playbook 文件<a class="headerlink" href="#42-执行-playbook-文件" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>对所有服务器执行playbook：</strong></li>
</ul>
<p>使用<code>ansible-playbook</code>命令执行playbook文件，并指定主机清单文件的路径<code>/data/ansible/hosts</code>：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1"></a><a href="#__codelineno-42-1"><span class="linenos" data-linenos="1 "></span></a>ansible-playbook<span class="w"> </span>-i<span class="w"> </span>/data/ansible/hosts<span class="w"> </span>/data/ansible/playbooks/check_disk_space.yml
</code></pre></div>
<p>输出内容如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1"></a><a href="#__codelineno-43-1"><span class="linenos" data-linenos=" 1 "></span></a>PLAY<span class="w"> </span><span class="o">[</span>Check<span class="w"> </span>disk<span class="w"> </span>space<span class="o">]</span><span class="w"> </span>*********************************************************************************************
<a id="__codelineno-43-2" name="__codelineno-43-2"></a><a href="#__codelineno-43-2"><span class="linenos" data-linenos=" 2 "></span></a>
<a id="__codelineno-43-3" name="__codelineno-43-3"></a><a href="#__codelineno-43-3"><span class="linenos" data-linenos=" 3 "></span></a>TASK<span class="w"> </span><span class="o">[</span>Gathering<span class="w"> </span>Facts<span class="o">]</span><span class="w"> </span>**********************************************************************************************
<a id="__codelineno-43-4" name="__codelineno-43-4"></a><a href="#__codelineno-43-4"><span class="linenos" data-linenos=" 4 "></span></a>ok:<span class="w"> </span><span class="o">[</span><span class="m">10</span>.22.51.65<span class="o">]</span>
<a id="__codelineno-43-5" name="__codelineno-43-5"></a><a href="#__codelineno-43-5"><span class="linenos" data-linenos=" 5 "></span></a>ok:<span class="w"> </span><span class="o">[</span>db1.example.com<span class="o">]</span>
<a id="__codelineno-43-6" name="__codelineno-43-6"></a><a href="#__codelineno-43-6"><span class="linenos" data-linenos=" 6 "></span></a>
<a id="__codelineno-43-7" name="__codelineno-43-7"></a><a href="#__codelineno-43-7"><span class="linenos" data-linenos=" 7 "></span></a>TASK<span class="w"> </span><span class="o">[</span>Disk<span class="w"> </span>free<span class="w"> </span>space<span class="o">]</span><span class="w"> </span>**********************************************************************************************
<a id="__codelineno-43-8" name="__codelineno-43-8"></a><a href="#__codelineno-43-8"><span class="linenos" data-linenos=" 8 "></span></a>changed:<span class="w"> </span><span class="o">[</span><span class="m">10</span>.22.51.65<span class="o">]</span>
<a id="__codelineno-43-9" name="__codelineno-43-9"></a><a href="#__codelineno-43-9"><span class="linenos" data-linenos=" 9 "></span></a>changed:<span class="w"> </span><span class="o">[</span>db1.example.com<span class="o">]</span>
<a id="__codelineno-43-10" name="__codelineno-43-10"></a><a href="#__codelineno-43-10"><span class="linenos" data-linenos="10 "></span></a>
<a id="__codelineno-43-11" name="__codelineno-43-11"></a><a href="#__codelineno-43-11"><span class="linenos" data-linenos="11 "></span></a>TASK<span class="w"> </span><span class="o">[</span>Show<span class="w"> </span>disk<span class="w"> </span>space<span class="o">]</span><span class="w"> </span>**********************************************************************************************
<a id="__codelineno-43-12" name="__codelineno-43-12"></a><a href="#__codelineno-43-12"><span class="linenos" data-linenos="12 "></span></a>ok:<span class="w"> </span><span class="o">[</span><span class="m">10</span>.22.51.65<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-43-13" name="__codelineno-43-13"></a><a href="#__codelineno-43-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">    </span><span class="s2">&quot;msg&quot;</span>:<span class="w"> </span><span class="s2">&quot;文件系统                 类型      容量  已用  可用 已用% 挂载点\ndevtmpfs                 devtmpfs  3.9G     0  3.9G    0% /dev\ntmpfs                    tmpfs     3.9G   12K  3.9G    1% /dev/shm\ntmpfs                    tmpfs     3.9G   42M  3.8G    2% /run\ntmpfs                    tmpfs     3.9G     0  3.9G    0% /sys/fs/cgroup\n/dev/mapper/sys-root     xfs        39G   29G   11G   73% /\n/dev/sda2                xfs      1014M  150M  865M   15% /boot\ntmpfs                    tmpfs     783M     0  783M    0% /run/user/0\n10.22.51.63:/data/public nfs4       35G  7.7G   27G   23% /mnt/nsd\noverlay                  overlay    39G   29G   11G   73% /var/lib/docker/overlay2/5ac739315d94fc3a467fbb4d2653911baf7044b73de383aca2d524207222a763/merged\noverlay                  overlay    39G   29G   11G   73% /var/lib/docker/overlay2/87ac405f7fe63b7ea890519121dc58a0435cad4559ddc826e2c84794112bfa74/merged\noverlay                  overlay    39G   29G   11G   73% /var/lib/docker/overlay2/8c5e044076ac652e5ba953a7b81d6b170a0c6cafb2fc35e7f4ba9f1d24cf53a1/merged&quot;</span>
<a id="__codelineno-43-14" name="__codelineno-43-14"></a><a href="#__codelineno-43-14"><span class="linenos" data-linenos="14 "></span></a><span class="o">}</span>
<a id="__codelineno-43-15" name="__codelineno-43-15"></a><a href="#__codelineno-43-15"><span class="linenos" data-linenos="15 "></span></a>ok:<span class="w"> </span><span class="o">[</span>db1.example.com<span class="o">]</span><span class="w"> </span><span class="o">=</span>&gt;<span class="w"> </span><span class="o">{</span>
<a id="__codelineno-43-16" name="__codelineno-43-16"></a><a href="#__codelineno-43-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">    </span><span class="s2">&quot;msg&quot;</span>:<span class="w"> </span><span class="s2">&quot;文件系统                 类型      容量  已用  可用 已用% 挂载点\ndevtmpfs                 devtmpfs  3.9G     0  3.9G    0% /dev\ntmpfs                    tmpfs     3.9G   12K  3.9G    1% /dev/shm\ntmpfs                    tmpfs     3.9G   42M  3.8G    2% /run\ntmpfs                    tmpfs     3.9G     0  3.9G    0% /sys/fs/cgroup\n/dev/mapper/sys-root     xfs        39G   29G   11G   73% /\n/dev/sda2                xfs      1014M  150M  865M   15% /boot\ntmpfs                    tmpfs     783M     0  783M    0% /run/user/0\n10.22.51.63:/data/public nfs4       35G  7.7G   27G   23% /mnt/nsd\noverlay                  overlay    39G   29G   11G   73% /var/lib/docker/overlay2/5ac739315d94fc3a467fbb4d2653911baf7044b73de383aca2d524207222a763/merged\noverlay                  overlay    39G   29G   11G   73% /var/lib/docker/overlay2/87ac405f7fe63b7ea890519121dc58a0435cad4559ddc826e2c84794112bfa74/merged\noverlay                  overlay    39G   29G   11G   73% /var/lib/docker/overlay2/8c5e044076ac652e5ba953a7b81d6b170a0c6cafb2fc35e7f4ba9f1d24cf53a1/merged&quot;</span>
<a id="__codelineno-43-17" name="__codelineno-43-17"></a><a href="#__codelineno-43-17"><span class="linenos" data-linenos="17 "></span></a><span class="o">}</span>
<a id="__codelineno-43-18" name="__codelineno-43-18"></a><a href="#__codelineno-43-18"><span class="linenos" data-linenos="18 "></span></a>
<a id="__codelineno-43-19" name="__codelineno-43-19"></a><a href="#__codelineno-43-19"><span class="linenos" data-linenos="19 "></span></a>PLAY<span class="w"> </span>RECAP<span class="w"> </span>**********************************************************************************************************
<a id="__codelineno-43-20" name="__codelineno-43-20"></a><a href="#__codelineno-43-20"><span class="linenos" data-linenos="20 "></span></a><span class="m">10</span>.22.51.65<span class="w">                </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">3</span><span class="w">    </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w">    </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">rescued</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">ignored</span><span class="o">=</span><span class="m">0</span><span class="w">   </span>
<a id="__codelineno-43-21" name="__codelineno-43-21"></a><a href="#__codelineno-43-21"><span class="linenos" data-linenos="21 "></span></a>db1.example.com<span class="w">            </span>:<span class="w"> </span><span class="nv">ok</span><span class="o">=</span><span class="m">3</span><span class="w">    </span><span class="nv">changed</span><span class="o">=</span><span class="m">1</span><span class="w">    </span><span class="nv">unreachable</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">failed</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">rescued</span><span class="o">=</span><span class="m">0</span><span class="w">    </span><span class="nv">ignored</span><span class="o">=</span><span class="m">0</span><span class="w">   </span>
</code></pre></div>
<p><strong>解释输出：</strong></p>
<blockquote>
<ul>
<li><code>PLAY [Check disk space]</code>：Playbook 名称。</li>
<li><code>TASK [Gathering Facts]</code>：Ansible 收集目标主机的基本信息（facts）。</li>
<li><code>TASK [Disk free space]</code>：执行 <code>df -Th</code> 命令并注册输出到变量 <code>disk_space</code>。</li>
<li><code>TASK [Show disk space]</code>：使用 <code>debug</code> 模块显示 <code>df -Th</code> 命令的输出。</li>
<li><code>PLAY RECAP</code>：Playbook 执行摘要，包括各主机的执行状态。</li>
</ul>
</blockquote>
<ul>
<li><strong>对单台服务器执行playbook：</strong></li>
</ul>
<blockquote>
<p>当在命令行中直接指定单个主机时，<code>hosts</code>属性必须存在，且<code>hosts</code> 属性应该设置为 <code>all</code> 或者主机的具体IP，以确保它能匹配任何传入的主机，即使 <code>hosts</code> 设置为 <code>all</code>，Ansible 只会对指定的主机执行操作。</p>
</blockquote>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1"></a><a href="#__codelineno-44-1"><span class="linenos" data-linenos="1 "></span></a>ansible-playbook<span class="w"> </span>-i<span class="w"> </span><span class="m">10</span>.22.51.65,<span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;ansible_user=root ansible_ssh_private_key_file=/root/.ssh/id_rsa&quot;</span><span class="w"> </span>/data/ansible/playbooks/check_disk_space.yml
</code></pre></div>
<blockquote>
<ul>
<li><code>-i 10.22.51.65,</code> ：指定目标主机为 <code>10.22.51.65</code>。逗号（<code>,</code>）确保 Ansible 将其识别为主机列表，即使只有一台主机。</li>
<li><code>-e</code> ：通过命令行传递额外的变量，指定使用 <code>root</code> 用户和 <code>/root/.ssh/id_rsa</code> 私钥文件进行连接。</li>
</ul>
</blockquote>
<ul>
<li><strong>发现问题：</strong>指定目标主机时，无论hosts文件内是否有配置该主机，也能成功。</li>
</ul>
<p><strong>原因：</strong>使用命令行参数指定目标主机时，Ansible 会优先使用命令行中指定的主机信息，而不是 Playbook 文件中 <code>hosts</code> 属性或清单文件中的定义。</p>
<ul>
<li>
<p><strong>清单文件的作用：</strong>在这种情况下，清单文件 <code>/data/ansible/hosts</code> 不会被使用，因为已经在命令行中指定了要连接的单个主机 IP 地址。</p>
</li>
<li>
<p><strong><code>hosts</code> 属性在 Playbook 中的作用：</strong>在 Playbook 中定义的 <code>hosts</code> 属性主要用于指定 Playbook 应该在哪些主机上运行任务。当你在命令行中指定主机时，Playbook 中的 <code>hosts</code> 属性不再被使用。</p>
</li>
</ul>
<h4 id="43-注意事项">4.3 注意事项<a class="headerlink" href="#43-注意事项" title="Permanent link">&para;</a></h4>
<p>在 Ansible 的工作流程中，<code>hosts</code> 属性在 Playbook 中设置的主要目的是为了定义任务的目标主机集。尽管在命令行中指定了主机，Playbook 文件中的 <code>hosts</code> 属性仍然需要存在，具体原因如下：</p>
<ul>
<li><strong>定义任务目标</strong>：<code>hosts</code> 属性告诉 Ansible 哪些主机应该执行该 Playbook 的任务。即使在命令行中指定了主机，Playbook 中的 <code>hosts</code> 属性仍然是任务选择的基础。</li>
<li><strong>清单文件的接口</strong>：当你不在命令行中指定主机时，Ansible 会从清单文件中读取目标主机。<code>hosts</code> 属性提供了一个接口，允许你在 Playbook 内部指定任务应该在哪些主机上执行。</li>
</ul>
<p><strong>命令行与 Playbook 的关系：</strong></p>
<ul>
<li><strong>命令行优先</strong>：当你在命令行中指定主机时，这些指定会覆盖 Playbook 中的 <code>hosts</code> 设置。这是因为命令行参数通常具有更高的优先级。</li>
<li><strong>Playbook 中的配置</strong>：即使你在命令行中指定了主机，Playbook 中的 <code>hosts</code> 属性依然存在，主要是为了在没有命令行指定主机时使用，以及为清单文件提供接口。</li>
</ul>
<h2 id="六ansible获取nginx信息">六、ansible获取nginx信息<a class="headerlink" href="#六ansible获取nginx信息" title="Permanent link">&para;</a></h2>
<blockquote>
<p>在对单个服务器执行<code>ansible</code>命令前，需要确保该服务器IP地址存在于<code>inventory</code>文件中，即<code>/data/ansible/hosts</code>文件，无论在哪个组里都行。</p>
<p>这里假设添加了如下IP地址到组里：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1"></a><a href="#__codelineno-45-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>servers<span class="o">]</span>
<a id="__codelineno-45-2" name="__codelineno-45-2"></a><a href="#__codelineno-45-2"><span class="linenos" data-linenos="2 "></span></a><span class="m">172</span>.18.0.161
<a id="__codelineno-45-3" name="__codelineno-45-3"></a><a href="#__codelineno-45-3"><span class="linenos" data-linenos="3 "></span></a><span class="m">172</span>.18.0.78
</code></pre></div>
</blockquote>
<h3 id="1检查nginx路径">1.检查nginx路径<a class="headerlink" href="#1检查nginx路径" title="Permanent link">&para;</a></h3>
<p>使用<code>ansible</code>命令来在远程<code>172.18.0.161</code>主机上运行 <code>which nginx</code> 命令：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1"></a><a href="#__codelineno-46-1"><span class="linenos" data-linenos="1 "></span></a>ansible<span class="w"> </span><span class="m">172</span>.18.0.161<span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;which nginx&#39;</span>
</code></pre></div>
<blockquote>
<p><code>which nginx</code> 命令可以查看 Nginx 的可执行文件的安装路径。</p>
</blockquote>
<p>执行结果如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1"></a><a href="#__codelineno-47-1"><span class="linenos" data-linenos="1 "></span></a><span class="m">172</span>.18.0.161<span class="w"> </span><span class="p">|</span><span class="w"> </span>CHANGED<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">rc</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>&gt;&gt;
<a id="__codelineno-47-2" name="__codelineno-47-2"></a><a href="#__codelineno-47-2"><span class="linenos" data-linenos="2 "></span></a>/bin/nginx
</code></pre></div>
<h3 id="2查看nginx配置文件所在">2.查看nginx配置文件所在<a class="headerlink" href="#2查看nginx配置文件所在" title="Permanent link">&para;</a></h3>
<p>使用<code>ansible</code>命令来在远程<code>172.18.0.161</code>主机上运行 <code>nginx -V</code> 命令：</p>
<div class="language-text highlight"><span class="filename">Text Only</span><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1"></a><a href="#__codelineno-48-1"><span class="linenos" data-linenos="1 "></span></a>ansible 172.18.0.78 -m shell -a &#39;nginx -V&#39;
</code></pre></div>
<blockquote>
<p><code>nginx -V</code> 命令可以显示 Nginx 的编译器版本和编译时配置选项等详细信息。</p>
</blockquote>
<p>执行结果如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1"></a><a href="#__codelineno-49-1"><span class="linenos" data-linenos="1 "></span></a><span class="m">172</span>.18.0.78<span class="w"> </span><span class="p">|</span><span class="w"> </span>CHANGED<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">rc</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>&gt;&gt;
<a id="__codelineno-49-2" name="__codelineno-49-2"></a><a href="#__codelineno-49-2"><span class="linenos" data-linenos="2 "></span></a>nginx<span class="w"> </span>version:<span class="w"> </span>nginx/1.18.0
<a id="__codelineno-49-3" name="__codelineno-49-3"></a><a href="#__codelineno-49-3"><span class="linenos" data-linenos="3 "></span></a>built<span class="w"> </span>by<span class="w"> </span>gcc<span class="w"> </span><span class="m">4</span>.8.5<span class="w"> </span><span class="m">20150623</span><span class="w"> </span><span class="o">(</span>Red<span class="w"> </span>Hat<span class="w"> </span><span class="m">4</span>.8.5-44<span class="o">)</span><span class="w"> </span><span class="o">(</span>GCC<span class="o">)</span><span class="w"> </span>
<a id="__codelineno-49-4" name="__codelineno-49-4"></a><a href="#__codelineno-49-4"><span class="linenos" data-linenos="4 "></span></a>built<span class="w"> </span>with<span class="w"> </span>OpenSSL<span class="w"> </span><span class="m">1</span>.0.2k-fips<span class="w">  </span><span class="m">26</span><span class="w"> </span>Jan<span class="w"> </span><span class="m">2017</span>
<a id="__codelineno-49-5" name="__codelineno-49-5"></a><a href="#__codelineno-49-5"><span class="linenos" data-linenos="5 "></span></a>TLS<span class="w"> </span>SNI<span class="w"> </span>support<span class="w"> </span>enabled
<a id="__codelineno-49-6" name="__codelineno-49-6"></a><a href="#__codelineno-49-6"><span class="linenos" data-linenos="6 "></span></a>configure<span class="w"> </span>arguments:<span class="w"> </span>--prefix<span class="o">=</span>/usr/local/nginx<span class="w"> </span>--user<span class="o">=</span>nginx<span class="w"> </span>--group<span class="o">=</span>nginx<span class="w"> </span>--with-http_stub_status_module<span class="w"> </span>--with-http_ssl_module<span class="w"> </span>--with-http_gzip_static_module<span class="w"> </span>--with-http_gunzip_module<span class="w"> </span>--with-http_v2_module
</code></pre></div>
<h3 id="3查看nginx配置文件内容">3.查看nginx配置文件内容<a class="headerlink" href="#3查看nginx配置文件内容" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1"></a><a href="#__codelineno-50-1"><span class="linenos" data-linenos="1 "></span></a>ansible<span class="w"> </span><span class="m">172</span>.18.0.78<span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;cat /usr/local/nginx/conf/nginx.conf&#39;</span>
</code></pre></div>
<p>如确定了nginx配置目录，可以查看conf目录下<code>ssl_certificate</code>。</p>
<h3 id="4查找服务器上所有的ssl证书">4.查找服务器上所有的ssl证书<a class="headerlink" href="#4查找服务器上所有的ssl证书" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1"></a><a href="#__codelineno-51-1"><span class="linenos" data-linenos="1 "></span></a>ansible<span class="w"> </span><span class="m">172</span>.18.0.161<span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;grep -r &quot;ssl_certificate&quot; /data/nginx/conf/conf.d/&#39;</span>
</code></pre></div>
<blockquote>
<p><code>grep -r</code>命令可以递归搜索目录<code>/data/nginx/conf/conf.d/</code>中是否有文件包含其内容<code>ssl_certificate</code>。</p>
</blockquote>
<p>执行结果如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1"></a><a href="#__codelineno-52-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="m">172</span>.18.0.161<span class="w"> </span><span class="p">|</span><span class="w"> </span>CHANGED<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">rc</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>&gt;&gt;
<a id="__codelineno-52-2" name="__codelineno-52-2"></a><a href="#__codelineno-52-2"><span class="linenos" data-linenos=" 2 "></span></a>/data/nginx/conf/conf.d/wecom.iboss.sunline.cn.conf:<span class="w">  </span>ssl_certificate<span class="w"> </span>cert/wecom.iboss.sunline.cn.pem<span class="p">;</span>
<a id="__codelineno-52-3" name="__codelineno-52-3"></a><a href="#__codelineno-52-3"><span class="linenos" data-linenos=" 3 "></span></a>/data/nginx/conf/conf.d/wecom.iboss.sunline.cn.conf:<span class="w">  </span>ssl_certificate_key<span class="w"> </span>cert/wecom.iboss.sunline.cn.key<span class="p">;</span>
<a id="__codelineno-52-4" name="__codelineno-52-4"></a><a href="#__codelineno-52-4"><span class="linenos" data-linenos=" 4 "></span></a>/data/nginx/conf/conf.d/iboss.sunline.cn-8443.conf:<span class="w">  </span>ssl_certificate<span class="w"> </span>cert/iboss.sunline.cn.pem<span class="p">;</span>
<a id="__codelineno-52-5" name="__codelineno-52-5"></a><a href="#__codelineno-52-5"><span class="linenos" data-linenos=" 5 "></span></a>/data/nginx/conf/conf.d/iboss.sunline.cn-8443.conf:<span class="w">  </span>ssl_certificate_key<span class="w"> </span>cert/iboss.sunline.cn.key<span class="p">;</span>
<a id="__codelineno-52-6" name="__codelineno-52-6"></a><a href="#__codelineno-52-6"><span class="linenos" data-linenos=" 6 "></span></a>/data/nginx/conf/conf.d/hr.iboss.sunline.cn-9443.conf:<span class="w">  </span>ssl_certificate<span class="w"> </span>cert/hr.iboss.sunline.cn_bundle.pem<span class="p">;</span>
<a id="__codelineno-52-7" name="__codelineno-52-7"></a><a href="#__codelineno-52-7"><span class="linenos" data-linenos=" 7 "></span></a>/data/nginx/conf/conf.d/hr.iboss.sunline.cn-9443.conf:<span class="w">  </span>ssl_certificate_key<span class="w"> </span>cert/hr.iboss.sunline.cn.key<span class="p">;</span>
<a id="__codelineno-52-8" name="__codelineno-52-8"></a><a href="#__codelineno-52-8"><span class="linenos" data-linenos=" 8 "></span></a>/data/nginx/conf/conf.d/iboss.sunline.cn.conf:<span class="w">  </span>ssl_certificate<span class="w"> </span>cert/iboss.sunline.cn.pem<span class="p">;</span>
<a id="__codelineno-52-9" name="__codelineno-52-9"></a><a href="#__codelineno-52-9"><span class="linenos" data-linenos=" 9 "></span></a>/data/nginx/conf/conf.d/iboss.sunline.cn.conf:<span class="w">  </span>ssl_certificate_key<span class="w"> </span>cert/iboss.sunline.cn.key<span class="p">;</span>
<a id="__codelineno-52-10" name="__codelineno-52-10"></a><a href="#__codelineno-52-10"><span class="linenos" data-linenos="10 "></span></a>/data/nginx/conf/conf.d/none.conf:<span class="w">  </span>ssl_certificate<span class="w"> </span>cert/none-ca.crt<span class="p">;</span>
<a id="__codelineno-52-11" name="__codelineno-52-11"></a><a href="#__codelineno-52-11"><span class="linenos" data-linenos="11 "></span></a>/data/nginx/conf/conf.d/none.conf:<span class="w">  </span>ssl_certificate_key<span class="w"> </span>cert/none-ca.key<span class="p">;</span>
</code></pre></div>
<h3 id="5搜索证书的确切路径">5.搜索证书的确切路径<a class="headerlink" href="#5搜索证书的确切路径" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1"></a><a href="#__codelineno-53-1"><span class="linenos" data-linenos="1 "></span></a>ansible<span class="w"> </span><span class="m">172</span>.18.0.161<span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;find / -name &quot;wecom.iboss.sunline.cn.pem&quot;&#39;</span>
</code></pre></div>
<p>执行结果如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1"></a><a href="#__codelineno-54-1"><span class="linenos" data-linenos="1 "></span></a><span class="m">172</span>.18.0.161<span class="w"> </span><span class="p">|</span><span class="w"> </span>CHANGED<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">rc</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>&gt;&gt;
<a id="__codelineno-54-2" name="__codelineno-54-2"></a><a href="#__codelineno-54-2"><span class="linenos" data-linenos="2 "></span></a>/data/nginx/conf/cert/wecom.iboss.sunline.cn.pem
</code></pre></div>
<h3 id="6查看证书所在目录">6.查看证书所在目录<a class="headerlink" href="#6查看证书所在目录" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1"></a><a href="#__codelineno-55-1"><span class="linenos" data-linenos="1 "></span></a>ansible<span class="w"> </span><span class="m">172</span>.18.0.161<span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;ls -l /data/nginx/conf/cert&#39;</span>
</code></pre></div>
<h2 id="七获取证书列表信息">七、获取证书列表信息<a class="headerlink" href="#七获取证书列表信息" title="Permanent link">&para;</a></h2>
<p>缺陷：API调用可能存在限制，非443端口的域名无法获取。</p>
<blockquote>
<p>例如：</p>
<p>wecom.iboss.sunline.cn:6443</p>
<p><div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1"></a><a href="#__codelineno-56-1"><span class="linenos" data-linenos="1 "></span></a><span class="c1"># 暂时不使用api查询</span>
</code></pre></div>
</p>
</blockquote>
<h3 id="1配置python脚本云服务器">1.配置python脚本（云服务器）<a class="headerlink" href="#1配置python脚本云服务器" title="Permanent link">&para;</a></h3>
<p>这里以自己的云服务器上的证书为例，配置的脚本文件存放在<code>/usr/local/scripts</code>目录下，脚本内容如下：</p>
<div class="language-python highlight"><span class="filename">Python</span><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1"></a><a href="#__codelineno-57-1"><span class="linenos" data-linenos="  1 "></span></a><span class="ch">#!/usr/bin/python3</span>
<a id="__codelineno-57-2" name="__codelineno-57-2"></a><a href="#__codelineno-57-2"><span class="linenos" data-linenos="  2 "></span></a>
<a id="__codelineno-57-3" name="__codelineno-57-3"></a><a href="#__codelineno-57-3"><span class="linenos" data-linenos="  3 "></span></a><span class="c1"># 导入必要的库</span>
<a id="__codelineno-57-4" name="__codelineno-57-4"></a><a href="#__codelineno-57-4"><span class="linenos" data-linenos="  4 "></span></a><span class="kn">import</span> <span class="nn">time</span>
<a id="__codelineno-57-5" name="__codelineno-57-5"></a><a href="#__codelineno-57-5"><span class="linenos" data-linenos="  5 "></span></a><span class="kn">import</span> <span class="nn">requests</span>
<a id="__codelineno-57-6" name="__codelineno-57-6"></a><a href="#__codelineno-57-6"><span class="linenos" data-linenos="  6 "></span></a><span class="kn">from</span> <span class="nn">requests.auth</span> <span class="kn">import</span> <span class="n">HTTPBasicAuth</span>
<a id="__codelineno-57-7" name="__codelineno-57-7"></a><a href="#__codelineno-57-7"><span class="linenos" data-linenos="  7 "></span></a>
<a id="__codelineno-57-8" name="__codelineno-57-8"></a><a href="#__codelineno-57-8"><span class="linenos" data-linenos="  8 "></span></a><span class="c1"># 登录时先进行身份认证的账号密码</span>
<a id="__codelineno-57-9" name="__codelineno-57-9"></a><a href="#__codelineno-57-9"><span class="linenos" data-linenos="  9 "></span></a><span class="n">auth_username</span> <span class="o">=</span> <span class="s2">&quot;sunline&quot;</span>
<a id="__codelineno-57-10" name="__codelineno-57-10"></a><a href="#__codelineno-57-10"><span class="linenos" data-linenos=" 10 "></span></a><span class="n">auth_password</span> <span class="o">=</span> <span class="s2">&quot;sunline&quot;</span>
<a id="__codelineno-57-11" name="__codelineno-57-11"></a><a href="#__codelineno-57-11"><span class="linenos" data-linenos=" 11 "></span></a>
<a id="__codelineno-57-12" name="__codelineno-57-12"></a><a href="#__codelineno-57-12"><span class="linenos" data-linenos=" 12 "></span></a><span class="c1"># 登录域名和SSL证书监控系统的账号密码</span>
<a id="__codelineno-57-13" name="__codelineno-57-13"></a><a href="#__codelineno-57-13"><span class="linenos" data-linenos=" 13 "></span></a><span class="n">admin_username</span> <span class="o">=</span> <span class="s2">&quot;admin&quot;</span>
<a id="__codelineno-57-14" name="__codelineno-57-14"></a><a href="#__codelineno-57-14"><span class="linenos" data-linenos=" 14 "></span></a><span class="n">admin_password</span> <span class="o">=</span> <span class="s2">&quot;dream13889&quot;</span>
<a id="__codelineno-57-15" name="__codelineno-57-15"></a><a href="#__codelineno-57-15"><span class="linenos" data-linenos=" 15 "></span></a>
<a id="__codelineno-57-16" name="__codelineno-57-16"></a><a href="#__codelineno-57-16"><span class="linenos" data-linenos=" 16 "></span></a><span class="c1"># 系统的登录URL和域名列表URL</span>
<a id="__codelineno-57-17" name="__codelineno-57-17"></a><a href="#__codelineno-57-17"><span class="linenos" data-linenos=" 17 "></span></a><span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;https://domain.jerion.cn/api/login&#39;</span>
<a id="__codelineno-57-18" name="__codelineno-57-18"></a><a href="#__codelineno-57-18"><span class="linenos" data-linenos=" 18 "></span></a><span class="n">domain_list_url</span> <span class="o">=</span> <span class="s1">&#39;https://domain.jerion.cn/api/getDomainList&#39;</span>
<a id="__codelineno-57-19" name="__codelineno-57-19"></a><a href="#__codelineno-57-19"><span class="linenos" data-linenos=" 19 "></span></a><span class="n">cert_info_url</span> <span class="o">=</span> <span class="s1">&#39;https://domain.jerion.cn/api/getCertInformation&#39;</span>
<a id="__codelineno-57-20" name="__codelineno-57-20"></a><a href="#__codelineno-57-20"><span class="linenos" data-linenos=" 20 "></span></a>
<a id="__codelineno-57-21" name="__codelineno-57-21"></a><a href="#__codelineno-57-21"><span class="linenos" data-linenos=" 21 "></span></a><span class="c1"># 创建认证对象</span>
<a id="__codelineno-57-22" name="__codelineno-57-22"></a><a href="#__codelineno-57-22"><span class="linenos" data-linenos=" 22 "></span></a><span class="n">auth</span> <span class="o">=</span> <span class="n">HTTPBasicAuth</span><span class="p">(</span><span class="n">auth_username</span><span class="p">,</span> <span class="n">auth_password</span><span class="p">)</span>
<a id="__codelineno-57-23" name="__codelineno-57-23"></a><a href="#__codelineno-57-23"><span class="linenos" data-linenos=" 23 "></span></a>
<a id="__codelineno-57-24" name="__codelineno-57-24"></a><a href="#__codelineno-57-24"><span class="linenos" data-linenos=" 24 "></span></a><span class="c1"># 准备登录请求的负载</span>
<a id="__codelineno-57-25" name="__codelineno-57-25"></a><a href="#__codelineno-57-25"><span class="linenos" data-linenos=" 25 "></span></a><span class="n">login_payload</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-57-26" name="__codelineno-57-26"></a><a href="#__codelineno-57-26"><span class="linenos" data-linenos=" 26 "></span></a>    <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">admin_username</span><span class="p">,</span>
<a id="__codelineno-57-27" name="__codelineno-57-27"></a><a href="#__codelineno-57-27"><span class="linenos" data-linenos=" 27 "></span></a>    <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="n">admin_password</span>
<a id="__codelineno-57-28" name="__codelineno-57-28"></a><a href="#__codelineno-57-28"><span class="linenos" data-linenos=" 28 "></span></a><span class="p">}</span>
<a id="__codelineno-57-29" name="__codelineno-57-29"></a><a href="#__codelineno-57-29"><span class="linenos" data-linenos=" 29 "></span></a>
<a id="__codelineno-57-30" name="__codelineno-57-30"></a><a href="#__codelineno-57-30"><span class="linenos" data-linenos=" 30 "></span></a><span class="c1"># 发送登录请求并处理响应</span>
<a id="__codelineno-57-31" name="__codelineno-57-31"></a><a href="#__codelineno-57-31"><span class="linenos" data-linenos=" 31 "></span></a><span class="n">login_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">login_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">login_payload</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span>
<a id="__codelineno-57-32" name="__codelineno-57-32"></a><a href="#__codelineno-57-32"><span class="linenos" data-linenos=" 32 "></span></a><span class="k">if</span> <span class="n">login_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<a id="__codelineno-57-33" name="__codelineno-57-33"></a><a href="#__codelineno-57-33"><span class="linenos" data-linenos=" 33 "></span></a>    <span class="n">login_data</span> <span class="o">=</span> <span class="n">login_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-57-34" name="__codelineno-57-34"></a><a href="#__codelineno-57-34"><span class="linenos" data-linenos=" 34 "></span></a>    <span class="n">token</span> <span class="o">=</span> <span class="n">login_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
<a id="__codelineno-57-35" name="__codelineno-57-35"></a><a href="#__codelineno-57-35"><span class="linenos" data-linenos=" 35 "></span></a>    <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
<a id="__codelineno-57-36" name="__codelineno-57-36"></a><a href="#__codelineno-57-36"><span class="linenos" data-linenos=" 36 "></span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;登录成功，获取到 Token&quot;</span><span class="p">)</span>
<a id="__codelineno-57-37" name="__codelineno-57-37"></a><a href="#__codelineno-57-37"><span class="linenos" data-linenos=" 37 "></span></a>
<a id="__codelineno-57-38" name="__codelineno-57-38"></a><a href="#__codelineno-57-38"><span class="linenos" data-linenos=" 38 "></span></a>        <span class="c1"># 设置请求头和准备获取域名列表的请求体</span>
<a id="__codelineno-57-39" name="__codelineno-57-39"></a><a href="#__codelineno-57-39"><span class="linenos" data-linenos=" 39 "></span></a>        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-57-40" name="__codelineno-57-40"></a><a href="#__codelineno-57-40"><span class="linenos" data-linenos=" 40 "></span></a>            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
<a id="__codelineno-57-41" name="__codelineno-57-41"></a><a href="#__codelineno-57-41"><span class="linenos" data-linenos=" 41 "></span></a>            <span class="s2">&quot;X-TOKEN&quot;</span><span class="p">:</span> <span class="n">token</span>
<a id="__codelineno-57-42" name="__codelineno-57-42"></a><a href="#__codelineno-57-42"><span class="linenos" data-linenos=" 42 "></span></a>        <span class="p">}</span>
<a id="__codelineno-57-43" name="__codelineno-57-43"></a><a href="#__codelineno-57-43"><span class="linenos" data-linenos=" 43 "></span></a>        <span class="n">domain_list_payload</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-57-44" name="__codelineno-57-44"></a><a href="#__codelineno-57-44"><span class="linenos" data-linenos=" 44 "></span></a>            <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-57-45" name="__codelineno-57-45"></a><a href="#__codelineno-57-45"><span class="linenos" data-linenos=" 45 "></span></a>            <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">10</span>  <span class="c1"># 可调整获取更多域名</span>
<a id="__codelineno-57-46" name="__codelineno-57-46"></a><a href="#__codelineno-57-46"><span class="linenos" data-linenos=" 46 "></span></a>        <span class="p">}</span>
<a id="__codelineno-57-47" name="__codelineno-57-47"></a><a href="#__codelineno-57-47"><span class="linenos" data-linenos=" 47 "></span></a>
<a id="__codelineno-57-48" name="__codelineno-57-48"></a><a href="#__codelineno-57-48"><span class="linenos" data-linenos=" 48 "></span></a>        <span class="c1"># 发送获取域名列表的请求并处理响应</span>
<a id="__codelineno-57-49" name="__codelineno-57-49"></a><a href="#__codelineno-57-49"><span class="linenos" data-linenos=" 49 "></span></a>        <span class="n">domain_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">domain_list_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">domain_list_payload</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span>
<a id="__codelineno-57-50" name="__codelineno-57-50"></a><a href="#__codelineno-57-50"><span class="linenos" data-linenos=" 50 "></span></a>        <span class="k">if</span> <span class="n">domain_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<a id="__codelineno-57-51" name="__codelineno-57-51"></a><a href="#__codelineno-57-51"><span class="linenos" data-linenos=" 51 "></span></a>            <span class="n">domain_data</span> <span class="o">=</span> <span class="n">domain_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-57-52" name="__codelineno-57-52"></a><a href="#__codelineno-57-52"><span class="linenos" data-linenos=" 52 "></span></a>            <span class="n">domain_list</span> <span class="o">=</span> <span class="n">domain_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-57-53" name="__codelineno-57-53"></a><a href="#__codelineno-57-53"><span class="linenos" data-linenos=" 53 "></span></a>            <span class="k">if</span> <span class="n">domain_list</span><span class="p">:</span>
<a id="__codelineno-57-54" name="__codelineno-57-54"></a><a href="#__codelineno-57-54"><span class="linenos" data-linenos=" 54 "></span></a>                <span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;/tmp/certificates_jerion.txt&#39;</span>
<a id="__codelineno-57-55" name="__codelineno-57-55"></a><a href="#__codelineno-57-55"><span class="linenos" data-linenos=" 55 "></span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
<a id="__codelineno-57-56" name="__codelineno-57-56"></a><a href="#__codelineno-57-56"><span class="linenos" data-linenos=" 56 "></span></a>                    <span class="k">for</span> <span class="n">domain_info</span> <span class="ow">in</span> <span class="n">domain_list</span><span class="p">:</span>
<a id="__codelineno-57-57" name="__codelineno-57-57"></a><a href="#__codelineno-57-57"><span class="linenos" data-linenos=" 57 "></span></a>                        <span class="n">domain</span> <span class="o">=</span> <span class="n">domain_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;domain&#39;</span><span class="p">)</span>
<a id="__codelineno-57-58" name="__codelineno-57-58"></a><a href="#__codelineno-57-58"><span class="linenos" data-linenos=" 58 "></span></a>                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;获取域名: </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-59" name="__codelineno-57-59"></a><a href="#__codelineno-57-59"><span class="linenos" data-linenos=" 59 "></span></a>                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-57-60" name="__codelineno-57-60"></a><a href="#__codelineno-57-60"><span class="linenos" data-linenos=" 60 "></span></a>
<a id="__codelineno-57-61" name="__codelineno-57-61"></a><a href="#__codelineno-57-61"><span class="linenos" data-linenos=" 61 "></span></a>                        <span class="c1"># 循环处理每个域名，获取其证书信息并写入文件</span>
<a id="__codelineno-57-62" name="__codelineno-57-62"></a><a href="#__codelineno-57-62"><span class="linenos" data-linenos=" 62 "></span></a>                        <span class="n">cert_payload</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-57-63" name="__codelineno-57-63"></a><a href="#__codelineno-57-63"><span class="linenos" data-linenos=" 63 "></span></a>                            <span class="s2">&quot;domain&quot;</span><span class="p">:</span> <span class="n">domain</span>
<a id="__codelineno-57-64" name="__codelineno-57-64"></a><a href="#__codelineno-57-64"><span class="linenos" data-linenos=" 64 "></span></a>                        <span class="p">}</span>
<a id="__codelineno-57-65" name="__codelineno-57-65"></a><a href="#__codelineno-57-65"><span class="linenos" data-linenos=" 65 "></span></a>                        <span class="n">cert_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">cert_info_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">cert_payload</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span>
<a id="__codelineno-57-66" name="__codelineno-57-66"></a><a href="#__codelineno-57-66"><span class="linenos" data-linenos=" 66 "></span></a>
<a id="__codelineno-57-67" name="__codelineno-57-67"></a><a href="#__codelineno-57-67"><span class="linenos" data-linenos=" 67 "></span></a>                        <span class="k">if</span> <span class="n">cert_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<a id="__codelineno-57-68" name="__codelineno-57-68"></a><a href="#__codelineno-57-68"><span class="linenos" data-linenos=" 68 "></span></a>                            <span class="n">data</span> <span class="o">=</span> <span class="n">cert_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-57-69" name="__codelineno-57-69"></a><a href="#__codelineno-57-69"><span class="linenos" data-linenos=" 69 "></span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;证书响应: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-70" name="__codelineno-57-70"></a><a href="#__codelineno-57-70"><span class="linenos" data-linenos=" 70 "></span></a>                            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-57-71" name="__codelineno-57-71"></a><a href="#__codelineno-57-71"><span class="linenos" data-linenos=" 71 "></span></a>
<a id="__codelineno-57-72" name="__codelineno-57-72"></a><a href="#__codelineno-57-72"><span class="linenos" data-linenos=" 72 "></span></a>                            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-57-73" name="__codelineno-57-73"></a><a href="#__codelineno-57-73"><span class="linenos" data-linenos=" 73 "></span></a>                                <span class="n">cert_info</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-57-74" name="__codelineno-57-74"></a><a href="#__codelineno-57-74"><span class="linenos" data-linenos=" 74 "></span></a>                                <span class="n">parsed_cert</span> <span class="o">=</span> <span class="n">cert_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parsed_cert&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-57-75" name="__codelineno-57-75"></a><a href="#__codelineno-57-75"><span class="linenos" data-linenos=" 75 "></span></a>                                <span class="n">domain_name</span> <span class="o">=</span> <span class="n">cert_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolve_domain&#39;</span><span class="p">)</span>
<a id="__codelineno-57-76" name="__codelineno-57-76"></a><a href="#__codelineno-57-76"><span class="linenos" data-linenos=" 76 "></span></a>                                <span class="n">issuer</span> <span class="o">=</span> <span class="n">parsed_cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;issuer&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-57-77" name="__codelineno-57-77"></a><a href="#__codelineno-57-77"><span class="linenos" data-linenos=" 77 "></span></a>                                <span class="n">start_date</span> <span class="o">=</span> <span class="n">parsed_cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notBefore&#39;</span><span class="p">)</span>
<a id="__codelineno-57-78" name="__codelineno-57-78"></a><a href="#__codelineno-57-78"><span class="linenos" data-linenos=" 78 "></span></a>                                <span class="n">expire_date</span> <span class="o">=</span> <span class="n">parsed_cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notAfter&#39;</span><span class="p">)</span>
<a id="__codelineno-57-79" name="__codelineno-57-79"></a><a href="#__codelineno-57-79"><span class="linenos" data-linenos=" 79 "></span></a>                                <span class="n">subject</span> <span class="o">=</span> <span class="n">parsed_cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-57-80" name="__codelineno-57-80"></a><a href="#__codelineno-57-80"><span class="linenos" data-linenos=" 80 "></span></a>
<a id="__codelineno-57-81" name="__codelineno-57-81"></a><a href="#__codelineno-57-81"><span class="linenos" data-linenos=" 81 "></span></a>                                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-57-82" name="__codelineno-57-82"></a><a href="#__codelineno-57-82"><span class="linenos" data-linenos=" 82 "></span></a>                                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Domain: </span><span class="si">{</span><span class="n">domain_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-83" name="__codelineno-57-83"></a><a href="#__codelineno-57-83"><span class="linenos" data-linenos=" 83 "></span></a>                                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Issuer: </span><span class="si">{</span><span class="n">issuer</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-84" name="__codelineno-57-84"></a><a href="#__codelineno-57-84"><span class="linenos" data-linenos=" 84 "></span></a>                                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start Date: </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-85" name="__codelineno-57-85"></a><a href="#__codelineno-57-85"><span class="linenos" data-linenos=" 85 "></span></a>                                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expire Date: </span><span class="si">{</span><span class="n">expire_date</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-86" name="__codelineno-57-86"></a><a href="#__codelineno-57-86"><span class="linenos" data-linenos=" 86 "></span></a>                                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject: </span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-87" name="__codelineno-57-87"></a><a href="#__codelineno-57-87"><span class="linenos" data-linenos=" 87 "></span></a>                                    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-88" name="__codelineno-57-88"></a><a href="#__codelineno-57-88"><span class="linenos" data-linenos=" 88 "></span></a>                                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;写入文件: Domain: </span><span class="si">{</span><span class="n">domain_name</span><span class="si">}</span><span class="s2">, Issuer: </span><span class="si">{</span><span class="n">issuer</span><span class="si">}</span><span class="s2">, Start Date: </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s2">, Expire Date: </span><span class="si">{</span><span class="n">expire_date</span><span class="si">}</span><span class="s2">, Subject: </span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-89" name="__codelineno-57-89"></a><a href="#__codelineno-57-89"><span class="linenos" data-linenos=" 89 "></span></a>                                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-57-90" name="__codelineno-57-90"></a><a href="#__codelineno-57-90"><span class="linenos" data-linenos=" 90 "></span></a>                                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;写入文件失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-91" name="__codelineno-57-91"></a><a href="#__codelineno-57-91"><span class="linenos" data-linenos=" 91 "></span></a>                            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-57-92" name="__codelineno-57-92"></a><a href="#__codelineno-57-92"><span class="linenos" data-linenos=" 92 "></span></a>                                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;获取 </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2"> 的证书信息失败。返回消息: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;msg&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-93" name="__codelineno-57-93"></a><a href="#__codelineno-57-93"><span class="linenos" data-linenos=" 93 "></span></a>                        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-57-94" name="__codelineno-57-94"></a><a href="#__codelineno-57-94"><span class="linenos" data-linenos=" 94 "></span></a>                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;获取 </span><span class="si">{</span><span class="n">domain</span><span class="si">}</span><span class="s2"> 的证书信息失败。状态码: </span><span class="si">{</span><span class="n">cert_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">, 响应: </span><span class="si">{</span><span class="n">cert_response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-95" name="__codelineno-57-95"></a><a href="#__codelineno-57-95"><span class="linenos" data-linenos=" 95 "></span></a>                        <span class="nb">print</span><span class="p">()</span>
<a id="__codelineno-57-96" name="__codelineno-57-96"></a><a href="#__codelineno-57-96"><span class="linenos" data-linenos=" 96 "></span></a>                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-57-97" name="__codelineno-57-97"></a><a href="#__codelineno-57-97"><span class="linenos" data-linenos=" 97 "></span></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-57-98" name="__codelineno-57-98"></a><a href="#__codelineno-57-98"><span class="linenos" data-linenos=" 98 "></span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;未找到任何域名。&quot;</span><span class="p">)</span>
<a id="__codelineno-57-99" name="__codelineno-57-99"></a><a href="#__codelineno-57-99"><span class="linenos" data-linenos=" 99 "></span></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-57-100" name="__codelineno-57-100"></a><a href="#__codelineno-57-100"><span class="linenos" data-linenos="100 "></span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;获取域名列表失败。状态码: </span><span class="si">{</span><span class="n">domain_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">, 响应: </span><span class="si">{</span><span class="n">domain_response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-101" name="__codelineno-57-101"></a><a href="#__codelineno-57-101"><span class="linenos" data-linenos="101 "></span></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-57-102" name="__codelineno-57-102"></a><a href="#__codelineno-57-102"><span class="linenos" data-linenos="102 "></span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;登录失败，未能获取到 Token&quot;</span><span class="p">)</span>
<a id="__codelineno-57-103" name="__codelineno-57-103"></a><a href="#__codelineno-57-103"><span class="linenos" data-linenos="103 "></span></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-57-104" name="__codelineno-57-104"></a><a href="#__codelineno-57-104"><span class="linenos" data-linenos="104 "></span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;登录失败。状态码: </span><span class="si">{</span><span class="n">login_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">, 响应: </span><span class="si">{</span><span class="n">login_response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-57-105" name="__codelineno-57-105"></a><a href="#__codelineno-57-105"><span class="linenos" data-linenos="105 "></span></a>
<a id="__codelineno-57-106" name="__codelineno-57-106"></a><a href="#__codelineno-57-106"><span class="linenos" data-linenos="106 "></span></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;获取证书信息执行结束！&quot;</span><span class="p">)</span>
</code></pre></div>
<h4 id="11-脚本功能说明">1.1 脚本功能说明<a class="headerlink" href="#11-脚本功能说明" title="Permanent link">&para;</a></h4>
<p>这个脚本的功能是登录一个域名和SSL证书监控系统，获取域名列表，并且获取每个域名的证书信息，最后将这些信息写入到一个文件中。</p>
<h5 id="111-导入必要及可选的库">1.1.1 导入必要及可选的库<a class="headerlink" href="#111-导入必要及可选的库" title="Permanent link">&para;</a></h5>
<ul>
<li><code>requests</code> ：该库用于发送HTTP请求。</li>
<li><code>from requests.auth import HTTPBasicAuth</code>：使用 <code>requests</code> 库中的 <code>HTTPBasicAuth</code> 类来提供认证信息。</li>
</ul>
<h5 id="112-定义登录信息和url">1.1.2 定义登录信息和URL<a class="headerlink" href="#112-定义登录信息和url" title="Permanent link">&para;</a></h5>
<ul>
<li><code>auth_username</code>：登录系统前进行身份认证的账号。</li>
<li><code>auth_password</code>：登录系统前进行身份认证的密码。</li>
<li><code>admin_username</code> ：存储登录所需的账号。</li>
<li><code>admin_password</code>：存储登录所需的密码。</li>
<li><code>login_url</code>：登录API的URL。</li>
<li><code>domain_list_url</code>：是获取域名列表的API的URL。</li>
<li><code>cert_info_url</code>：是获取证书信息的API的URL。</li>
</ul>
<h5 id="113-准备自动进行身份认证的信息可选">1.1.3 准备自动进行身份认证的信息（可选）<a class="headerlink" href="#113-准备自动进行身份认证的信息可选" title="Permanent link">&para;</a></h5>
<ul>
<li><code>HTTPBasicAuth(admin_username, admin_password)</code>：创建一个认证对象，用于在HTTP请求中实现基本认证，基本认证是一种通过在HTTP请求头中添加用户名和密码进行身份验证的方式，这里是因为在<code>NginxwebUI</code>中配置了<code>htpasswd</code>身份认证，将用户名和密码传递给<code>auth</code>。</li>
</ul>
<h5 id="114-准备登录请求的负载">1.1.4 准备登录请求的负载<a class="headerlink" href="#114-准备登录请求的负载" title="Permanent link">&para;</a></h5>
<ul>
<li><code>login_payload</code> ：发送到登录API的请求体，包含用户名和密码。</li>
</ul>
<h5 id="115-发送登录请求并处理响应">1.1.5 发送登录请求并处理响应<a class="headerlink" href="#115-发送登录请求并处理响应" title="Permanent link">&para;</a></h5>
<div class="language-python highlight"><span class="filename">Python</span><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1"></a><a href="#__codelineno-58-1"><span class="linenos" data-linenos="1 "></span></a><span class="n">login_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">login_url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">login_payload</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="n">auth</span><span class="p">)</span>
<a id="__codelineno-58-2" name="__codelineno-58-2"></a><a href="#__codelineno-58-2"><span class="linenos" data-linenos="2 "></span></a><span class="k">if</span> <span class="n">login_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<a id="__codelineno-58-3" name="__codelineno-58-3"></a><a href="#__codelineno-58-3"><span class="linenos" data-linenos="3 "></span></a>    <span class="n">login_data</span> <span class="o">=</span> <span class="n">login_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-58-4" name="__codelineno-58-4"></a><a href="#__codelineno-58-4"><span class="linenos" data-linenos="4 "></span></a>    <span class="n">token</span> <span class="o">=</span> <span class="n">login_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
<a id="__codelineno-58-5" name="__codelineno-58-5"></a><a href="#__codelineno-58-5"><span class="linenos" data-linenos="5 "></span></a>    <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
<a id="__codelineno-58-6" name="__codelineno-58-6"></a><a href="#__codelineno-58-6"><span class="linenos" data-linenos="6 "></span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;登录成功，获取到 Token&quot;</span><span class="p">)</span>
</code></pre></div>
<ul>
<li><code>requests.post()</code>：是 <code>requests</code> 库中的一个方法，用于发送HTTP POST请求。</li>
<li><code>login_url</code>: 目标API的URL地址。</li>
<li><code>json=login_payload</code>: 请求的JSON数据。<code>login_payload</code> 是一个字典，包含了要发送的登录信息（用户名和密码），该参数会将字典 <code>login_payload</code> 自动转换为JSON格式并设置合适的 <code>Content-Type</code> 头。</li>
<li><code>auth=auth</code>: 使用创建的 <code>HTTPBasicAuth</code> 对象进行身份认证。</li>
<li><code>login_response.status_code</code>：检查响应状态码是否为200（表示请求成功）。</li>
<li><code>login_response.json()</code>：用于将HTTP响应的内容解析为JSON格式的Python对象，通常是一个字典。</li>
<li><code>login_data.get('data', {})</code>：从 <code>login_data</code> 字典中获取键 <code>'data'</code> 的值，如果 <code>'data'</code> 键存在，则返回其对应的值（这里是一个嵌套的字典），如果 <code>'data'</code> 键不存在，则返回一个默认的空字典 <code>{}</code>，避免抛出 <code>KeyError</code> 异常。</li>
<li><code>.get('token')</code>：对于外层 <code>get</code> 方法返回的字典（可能是嵌套的字典，或者是空字典），获取键 <code>'token'</code> 的值。</li>
<li>如果获取到<code>Token</code>，则打印成功消息。</li>
</ul>
<h5 id="116-设置请求头和准备获取域名列表的请求体">1.1.6 设置请求头和准备获取域名列表的请求体<a class="headerlink" href="#116-设置请求头和准备获取域名列表的请求体" title="Permanent link">&para;</a></h5>
<div class="language-python highlight"><span class="filename">Python</span><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1"></a><a href="#__codelineno-59-1"><span class="linenos" data-linenos="1 "></span></a><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-59-2" name="__codelineno-59-2"></a><a href="#__codelineno-59-2"><span class="linenos" data-linenos="2 "></span></a>    <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
<a id="__codelineno-59-3" name="__codelineno-59-3"></a><a href="#__codelineno-59-3"><span class="linenos" data-linenos="3 "></span></a>    <span class="s2">&quot;X-TOKEN&quot;</span><span class="p">:</span> <span class="n">token</span>
<a id="__codelineno-59-4" name="__codelineno-59-4"></a><a href="#__codelineno-59-4"><span class="linenos" data-linenos="4 "></span></a><span class="p">}</span>
<a id="__codelineno-59-5" name="__codelineno-59-5"></a><a href="#__codelineno-59-5"><span class="linenos" data-linenos="5 "></span></a><span class="n">domain_list_payload</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-59-6" name="__codelineno-59-6"></a><a href="#__codelineno-59-6"><span class="linenos" data-linenos="6 "></span></a>    <span class="s2">&quot;page&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-59-7" name="__codelineno-59-7"></a><a href="#__codelineno-59-7"><span class="linenos" data-linenos="7 "></span></a>    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">10</span>  <span class="c1"># 可调整获取更多域名</span>
<a id="__codelineno-59-8" name="__codelineno-59-8"></a><a href="#__codelineno-59-8"><span class="linenos" data-linenos="8 "></span></a><span class="p">}</span>
</code></pre></div>
<ul>
<li><code>headers</code> ：包含请求头，其中 <code>X-TOKEN</code> 用于认证。</li>
<li><code>domain_list_payload</code> ：获取域名列表的请求体，指定分页参数。</li>
</ul>
<h5 id="117-发送获取域名列表的请求并处理响应">1.1.7 发送获取域名列表的请求并处理响应<a class="headerlink" href="#117-发送获取域名列表的请求并处理响应" title="Permanent link">&para;</a></h5>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1"></a><a href="#__codelineno-60-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="nv">domain_response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>requests.post<span class="o">(</span>domain_list_url,<span class="w"> </span><span class="nv">headers</span><span class="o">=</span>headers,<span class="w"> </span><span class="nv">json</span><span class="o">=</span>domain_list_payload<span class="o">)</span>
<a id="__codelineno-60-2" name="__codelineno-60-2"></a><a href="#__codelineno-60-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="k">if</span><span class="w"> </span>domain_response.status_code<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">200</span>:
<a id="__codelineno-60-3" name="__codelineno-60-3"></a><a href="#__codelineno-60-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">    </span><span class="nv">domain_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>domain_response.json<span class="o">()</span>
<a id="__codelineno-60-4" name="__codelineno-60-4"></a><a href="#__codelineno-60-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">    </span><span class="nv">domain_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>domain_data.get<span class="o">(</span><span class="s1">&#39;data&#39;</span>,<span class="w"> </span><span class="o">{})</span>.get<span class="o">(</span><span class="s1">&#39;list&#39;</span>,<span class="w"> </span><span class="o">[])</span>
<a id="__codelineno-60-5" name="__codelineno-60-5"></a><a href="#__codelineno-60-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span>domain_list:
<a id="__codelineno-60-6" name="__codelineno-60-6"></a><a href="#__codelineno-60-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="w">        </span><span class="nv">file_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/tmp/certificates_jerion.txt&#39;</span>
<a id="__codelineno-60-7" name="__codelineno-60-7"></a><a href="#__codelineno-60-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="w">        </span>with<span class="w"> </span>open<span class="o">(</span>file_path,<span class="w"> </span><span class="s1">&#39;w&#39;</span><span class="o">)</span><span class="w"> </span>as<span class="w"> </span>file:
<a id="__codelineno-60-8" name="__codelineno-60-8"></a><a href="#__codelineno-60-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">            </span><span class="k">for</span><span class="w"> </span>domain_info<span class="w"> </span><span class="k">in</span><span class="w"> </span>domain_list:
<a id="__codelineno-60-9" name="__codelineno-60-9"></a><a href="#__codelineno-60-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">                </span><span class="nv">domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>domain_info.get<span class="o">(</span><span class="s1">&#39;domain&#39;</span><span class="o">)</span>
<a id="__codelineno-60-10" name="__codelineno-60-10"></a><a href="#__codelineno-60-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">                </span>print<span class="o">(</span>f<span class="s2">&quot;获取域名: {domain}&quot;</span><span class="o">)</span>
</code></pre></div>
<ul>
<li><code>requests.post()</code>：发送一个HTTP POST请求到 <code>domain_list_url</code> 以获取域名列表。</li>
<li><code>domain_list_url</code>: 请求的URL（获取域名列表的API端点）；</li>
<li><code>headers</code>: 包含HTTP头信息的字典，这里包括认证所需的Token；</li>
<li><code>json=domain_list_payload</code>: 请求体，包含分页参数（如第几页，每页多少条记录）；</li>
<li><code>auth=auth</code>: 使用创建的 <code>HTTPBasicAuth</code> 对象进行身份认证。</li>
<li><code>domain_response.status_code</code>：检查响应状态码是否为200（表示请求成功）。</li>
<li><code>domain_response.json()</code>：用于将HTTP响应的内容解析为JSON格式的Python对象，通常是一个字典。</li>
<li><code>domain_data.get('data', {})</code>：从 <code>domain_data</code> 字典中获取键 <code>'data'</code> 的值，如果不存在则返回空字典 <code>{}</code>。</li>
<li><code>.get('list', [])</code>：从嵌套的字典中获取键 <code>'list'</code> 的值，如果不存在则返回空列表 <code>[]</code>，<code>domain_list</code> 是一个包含域名信息的列表。</li>
<li><code>file_path</code>：定义一个文件路径变量 <code>file_path</code>，用于存储证书信息。</li>
<li><code>with open(file_path, 'w') as file</code>：打开（或创建）一个文件，以写模式(<code>'w'</code>)打开，并将文件对象赋值给 <code>file</code>。</li>
<li><code>open(file_path, 'w')</code>：打开 <code>file_path</code> 指定的文件，如果文件不存在则创建它，如果存在则清空其内容；</li>
<li><code>as file</code>：将文件对象赋值给变量 <code>file</code>，以便在 <code>with</code> 语句块中使用。</li>
<li><code>for domain_info in domain_list</code>：对 <code>domain_list</code> 列表中的每个元素（域名信息字典）进行迭代。</li>
<li><code>domain_info.get('domain')</code>：获取 <code>domain_info</code> 字典中键 <code>'domain'</code> 的值（即域名）。</li>
</ul>
<h5 id="118-循环处理每个域名获取其证书信息并写入文件">1.1.8 循环处理每个域名，获取其证书信息并写入文件<a class="headerlink" href="#118-循环处理每个域名获取其证书信息并写入文件" title="Permanent link">&para;</a></h5>
<div class="language-python highlight"><span class="filename">Python</span><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1"></a><a href="#__codelineno-61-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="n">cert_payload</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-61-2" name="__codelineno-61-2"></a><a href="#__codelineno-61-2"><span class="linenos" data-linenos=" 2 "></span></a>    <span class="s2">&quot;domain&quot;</span><span class="p">:</span> <span class="n">domain</span>
<a id="__codelineno-61-3" name="__codelineno-61-3"></a><a href="#__codelineno-61-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="p">}</span>
<a id="__codelineno-61-4" name="__codelineno-61-4"></a><a href="#__codelineno-61-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="n">cert_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">cert_info_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">cert_payload</span><span class="p">)</span>
<a id="__codelineno-61-5" name="__codelineno-61-5"></a><a href="#__codelineno-61-5"><span class="linenos" data-linenos=" 5 "></span></a>
<a id="__codelineno-61-6" name="__codelineno-61-6"></a><a href="#__codelineno-61-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="k">if</span> <span class="n">cert_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<a id="__codelineno-61-7" name="__codelineno-61-7"></a><a href="#__codelineno-61-7"><span class="linenos" data-linenos=" 7 "></span></a>    <span class="n">data</span> <span class="o">=</span> <span class="n">cert_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a id="__codelineno-61-8" name="__codelineno-61-8"></a><a href="#__codelineno-61-8"><span class="linenos" data-linenos=" 8 "></span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;证书响应: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-61-9" name="__codelineno-61-9"></a><a href="#__codelineno-61-9"><span class="linenos" data-linenos=" 9 "></span></a>    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-61-10" name="__codelineno-61-10"></a><a href="#__codelineno-61-10"><span class="linenos" data-linenos="10 "></span></a>        <span class="n">cert_info</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-61-11" name="__codelineno-61-11"></a><a href="#__codelineno-61-11"><span class="linenos" data-linenos="11 "></span></a>        <span class="n">parsed_cert</span> <span class="o">=</span> <span class="n">cert_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parsed_cert&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-61-12" name="__codelineno-61-12"></a><a href="#__codelineno-61-12"><span class="linenos" data-linenos="12 "></span></a>        <span class="n">domain_name</span> <span class="o">=</span> <span class="n">cert_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolve_domain&#39;</span><span class="p">)</span>
<a id="__codelineno-61-13" name="__codelineno-61-13"></a><a href="#__codelineno-61-13"><span class="linenos" data-linenos="13 "></span></a>        <span class="n">issuer</span> <span class="o">=</span> <span class="n">parsed_cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;issuer&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-61-14" name="__codelineno-61-14"></a><a href="#__codelineno-61-14"><span class="linenos" data-linenos="14 "></span></a>        <span class="n">start_date</span> <span class="o">=</span> <span class="n">parsed_cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notBefore&#39;</span><span class="p">)</span>
<a id="__codelineno-61-15" name="__codelineno-61-15"></a><a href="#__codelineno-61-15"><span class="linenos" data-linenos="15 "></span></a>        <span class="n">expire_date</span> <span class="o">=</span> <span class="n">parsed_cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;notAfter&#39;</span><span class="p">)</span>
<a id="__codelineno-61-16" name="__codelineno-61-16"></a><a href="#__codelineno-61-16"><span class="linenos" data-linenos="16 "></span></a>        <span class="n">subject</span> <span class="o">=</span> <span class="n">parsed_cert</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-61-17" name="__codelineno-61-17"></a><a href="#__codelineno-61-17"><span class="linenos" data-linenos="17 "></span></a>
<a id="__codelineno-61-18" name="__codelineno-61-18"></a><a href="#__codelineno-61-18"><span class="linenos" data-linenos="18 "></span></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-61-19" name="__codelineno-61-19"></a><a href="#__codelineno-61-19"><span class="linenos" data-linenos="19 "></span></a>            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Domain: </span><span class="si">{</span><span class="n">domain_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-61-20" name="__codelineno-61-20"></a><a href="#__codelineno-61-20"><span class="linenos" data-linenos="20 "></span></a>            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Issuer: </span><span class="si">{</span><span class="n">issuer</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-61-21" name="__codelineno-61-21"></a><a href="#__codelineno-61-21"><span class="linenos" data-linenos="21 "></span></a>            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Start Date: </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-61-22" name="__codelineno-61-22"></a><a href="#__codelineno-61-22"><span class="linenos" data-linenos="22 "></span></a>            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Expire Date: </span><span class="si">{</span><span class="n">expire_date</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-61-23" name="__codelineno-61-23"></a><a href="#__codelineno-61-23"><span class="linenos" data-linenos="23 "></span></a>            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Subject: </span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-61-24" name="__codelineno-61-24"></a><a href="#__codelineno-61-24"><span class="linenos" data-linenos="24 "></span></a>            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-61-25" name="__codelineno-61-25"></a><a href="#__codelineno-61-25"><span class="linenos" data-linenos="25 "></span></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;写入文件: Domain: </span><span class="si">{</span><span class="n">domain_name</span><span class="si">}</span><span class="s2">, Issuer: </span><span class="si">{</span><span class="n">issuer</span><span class="si">}</span><span class="s2">, Start Date: </span><span class="si">{</span><span class="n">start_date</span><span class="si">}</span><span class="s2">, Expire Date: </span><span class="si">{</span><span class="n">expire_date</span><span class="si">}</span><span class="s2">, Subject: </span><span class="si">{</span><span class="n">subject</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<ul>
<li><code>cert_payload</code>：创建一个字典 <code>cert_payload</code>，包含的是获取域名信息的请求体。</li>
<li><code>requests.post()</code>：发送一个HTTP POST请求到 <code>cert_info_url</code>，请求头包含认证信息，请求体包含查询的域名。</li>
<li><code>cert_info_url</code>: 证书信息API的URL；</li>
<li><code>headers</code>: 请求头，包含认证Token等信息；</li>
<li><code>json=cert_payload</code>: 请求体，包含查询的域名；</li>
<li><code>auth=auth</code>: 使用创建的 <code>HTTPBasicAuth</code> 对象进行身份认证。</li>
<li><code>cert_response.status_code</code>：检查证书请求的HTTP状态码是否为200，表示请求成功。</li>
<li><code>cert_response.json()</code>：将响应内容解析为JSON格式的字典。</li>
<li><code>data.get('code')</code>：检查响应数据中的 <code>code</code> 字段是否为0，表示请求成功。</li>
<li><code>data.get('data', {})</code>：从 <code>data</code> 字典中获取 <code>data</code> 键的值，即证书信息，如果不存在，则返回空字典 <code>{}</code>。</li>
<li><code>cert_info.get('parsed_cert', {})</code>：从 <code>cert_info</code> 字典中获取 <code>parsed_cert</code> 键的值，即解析后的证书信息，如果不存在，则返回空字典 <code>{}</code>。</li>
<li><code>cert_info.get('resolve_domain')</code>: 从 <code>cert_info</code> 获取 <code>resolve_domain</code> 键的值，即域名。</li>
<li><code>parsed_cert.get('issuer', {})</code>: 从 <code>parsed_cert</code> 获取 <code>issuer</code> 键的值，即颁发者，如果不存在，则返回空字典 <code>{}</code>。</li>
<li><code>parsed_cert.get('notBefore')</code>: 从 <code>parsed_cert</code> 获取证书的开始日期。</li>
<li><code>parsed_cert.get('notAfter')</code>: 从 <code>parsed_cert</code> 获取证书的过期日期。</li>
<li><code>parsed_cert.get('subject', {})</code>: 从 <code>parsed_cert</code> 获取 <code>subject</code> 键的值，即主题，如果不存在，则返回空字典 <code>{}</code>。</li>
<li><code>file.write()</code>：向文件中写入证书信息。</li>
</ul>
<h5 id="119-处理失败情况">1.1.9 处理失败情况<a class="headerlink" href="#119-处理失败情况" title="Permanent link">&para;</a></h5>
<div class="language-python highlight"><span class="filename">Python</span><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1"></a><a href="#__codelineno-62-1"><span class="linenos" data-linenos="1 "></span></a>    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-62-2" name="__codelineno-62-2"></a><a href="#__codelineno-62-2"><span class="linenos" data-linenos="2 "></span></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;未找到任何域名。&quot;</span><span class="p">)</span>
<a id="__codelineno-62-3" name="__codelineno-62-3"></a><a href="#__codelineno-62-3"><span class="linenos" data-linenos="3 "></span></a><span class="o">......</span>
<a id="__codelineno-62-4" name="__codelineno-62-4"></a><a href="#__codelineno-62-4"><span class="linenos" data-linenos="4 "></span></a><span class="k">else</span><span class="p">:</span>
<a id="__codelineno-62-5" name="__codelineno-62-5"></a><a href="#__codelineno-62-5"><span class="linenos" data-linenos="5 "></span></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;登录失败。状态码: </span><span class="si">{</span><span class="n">login_response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">, 响应: </span><span class="si">{</span><span class="n">login_response</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>
<ul>
<li>如果未找到任何域名，打印相应消息。</li>
<li>如果获取域名列表失败，打印状态码和响应内容。</li>
<li>如果登录失败且未获取到Token，打印相应消息。</li>
<li>如果登录请求失败，打印状态码和响应内容。</li>
</ul>
<h4 id="12-脚本相关问题">1.2 脚本相关问题<a class="headerlink" href="#12-脚本相关问题" title="Permanent link">&para;</a></h4>
<h5 id="121-如何查看后端登录的url">1.2.1 如何查看后端登录的URL<a class="headerlink" href="#121-如何查看后端登录的url" title="Permanent link">&para;</a></h5>
<ul>
<li><strong>打开登录系统：</strong> <code>https://domain.jerion.cn</code>；</li>
<li><strong>打开浏览器开发者工具：</strong>在浏览器中按 <code>F12</code> 或右键点击页面，然后选择“检查”或“检查元素”；</li>
<li><strong>切换到“网络”标签：</strong>在网络标签中，可以看到页面加载时发起的所有网络请求；</li>
<li><strong>进行登录操作：</strong></li>
<li>在登录页面输入用户名和密码，然后点击登录按钮；</li>
<li>在网络标签中查找类型为 <code>POST</code> 的请求，就可以看到看看后端登录的URL。</li>
</ul>
<p><a class="glightbox" href="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/c19b03695cb8491fe9b5de5c2cb821a6-image-20240616194906976-a9b68b.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/c19b03695cb8491fe9b5de5c2cb821a6-image-20240616194906976-a9b68b.png" alt="image-20240616194906976" style="zoom:50%;" /></a></p>
<h5 id="122-如何查看后端登录后的域名列表url">1.2.2 如何查看后端登录后的域名列表URL<a class="headerlink" href="#122-如何查看后端登录后的域名列表url" title="Permanent link">&para;</a></h5>
<p>登录系统后，打开【证书监控】——【域名列表】，在网络标签中找到名称为<code>getDomainList</code>的请求，在“标头”栏可以看到请求URL：</p>
<p><a class="glightbox" href="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/a7f94eabdfdc1791a58ddf7ee472e55c-image-20240616200813941-722f1c.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240616200813941" src="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/a7f94eabdfdc1791a58ddf7ee472e55c-image-20240616200813941-722f1c.png" /></a></p>
<h5 id="123-如何查看后端登录后的获取证书信息url">1.2.3 如何查看后端登录后的获取证书信息URL<a class="headerlink" href="#123-如何查看后端登录后的获取证书信息url" title="Permanent link">&para;</a></h5>
<p>登录系统后，打开【工具箱】——【证书信息查询】，假设这里查询<code>domain.jerion.cn</code>域名，点击“查询”后，在网络标签中找到名称为<code>getCertInformation</code>的请求，在“标头”栏可以看到请求URL：</p>
<p><a class="glightbox" href="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/35dce0e17305e9679908372cf3fefceb-image-20240616224150221-31e5b1.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="image-20240616224150221" src="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/35dce0e17305e9679908372cf3fefceb-image-20240616224150221-31e5b1.png" /></a></p>
<h5 id="124-如何查看抓取到的token值">1.2.4 如何查看抓取到的token值<a class="headerlink" href="#124-如何查看抓取到的token值" title="Permanent link">&para;</a></h5>
<p>登录系统后，在网络标签中找到名称为<code>login</code>的请求，点击“响应”栏，可以看到<code>token</code>值：</p>
<p><a class="glightbox" href="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/abbc3f20c0b9efbd197a486072ad1d80-image-20240616212749123-5b9afc.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/abbc3f20c0b9efbd197a486072ad1d80-image-20240616212749123-5b9afc.png" alt="image-20240616212749123" style="zoom:50%;" /></a></p>
<h5 id="125-如何查看登录请求的负载">1.2.5 如何查看登录请求的负载<a class="headerlink" href="#125-如何查看登录请求的负载" title="Permanent link">&para;</a></h5>
<p>登录系统后，在网络标签中找到名称为<code>login</code>的请求，点击“负载”栏，可以看到json格式信息包含的账号密码：</p>
<p><a class="glightbox" href="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/c7c61ef4a10eb2777ad66b27d3c44d57-image-20240616213807957-cf080b.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/c7c61ef4a10eb2777ad66b27d3c44d57-image-20240616213807957-cf080b.png" alt="image-20240616213807957" style="zoom:50%;" /></a></p>
<h5 id="126-如何查看请求头和准备获取域名列表的请求体">1.2.6 如何查看请求头和准备获取域名列表的请求体<a class="headerlink" href="#126-如何查看请求头和准备获取域名列表的请求体" title="Permanent link">&para;</a></h5>
<p>登录系统后，打开【证书监控】——【证书列表】，在网络标签中找到名称为<code>getDomainList</code>的请求，在“标头”栏，往下拉可以看到请求表头中包含的<code>Content-Type</code>值和<code>X-Token</code>值：</p>
<p><a class="glightbox" href="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/f7d92943c92d3244a535c6ad64423c63-image-20240616214122424-e0f864.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/f7d92943c92d3244a535c6ad64423c63-image-20240616214122424-e0f864.png" alt="image-20240616214122424" style="zoom:50%;" /></a></p>
<p>点击“负载”栏，查看获取域名列表的请求负载，可以看到包含了<code>page</code>和<code>size</code>属性值：</p>
<p><a class="glightbox" href="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/2bebca786410b173e43936b96a38c768-image-20240616214303999-be013c.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/2bebca786410b173e43936b96a38c768-image-20240616214303999-be013c.png" alt="image-20240616214303999" style="zoom:50%;" /></a></p>
<h5 id="127-如何查看查询并获取证书信息的请求体">1.2.7 如何查看查询并获取证书信息的请求体<a class="headerlink" href="#127-如何查看查询并获取证书信息的请求体" title="Permanent link">&para;</a></h5>
<p>登录系统后，打开【工具箱】——【证书信息查询】，假设这里查询<code>domain.jerion.cn</code>域名，点击“查询”后，在网络标签中找到名称为<code>getCertInformation</code>的请求，点击“负载”栏，查看获取域名列表的请求负载，可以看到包含了<code>domain</code>属性值：</p>
<p><a class="glightbox" href="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/59fc9e90cf49a614047daabe28ee0fd7-image-20240616225512560-d2c86e.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/59fc9e90cf49a614047daabe28ee0fd7-image-20240616225512560-d2c86e.png" alt="image-20240616225512560" style="zoom:50%;" /></a></p>
<p>点击“响应”栏，可以看到域名的一些证书信息的属性及属性值：</p>
<p><a class="glightbox" href="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/35fe0b8e1f4fe80de155a377312ec0c1-image-20240616225529867-5d7ab1.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img src="https://raw.githubusercontent.com/zyx3721/Picbed/main/blog-images/2024/06/16/35fe0b8e1f4fe80de155a377312ec0c1-image-20240616225529867-5d7ab1.png" alt="image-20240616225529867" style="zoom:50%;" /></a></p>
<h3 id="2运行python脚本云服务器">2.运行python脚本（云服务器）<a class="headerlink" href="#2运行python脚本云服务器" title="Permanent link">&para;</a></h3>
<p>使用<code>python3</code>命令执行脚本<code>get_domain_info_jerion.py</code>：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-63-1" name="__codelineno-63-1"></a><a href="#__codelineno-63-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1">#查找python3的路径</span>
<a id="__codelineno-63-2" name="__codelineno-63-2"></a><a href="#__codelineno-63-2"><span class="linenos" data-linenos=" 2 "></span></a>which<span class="w"> </span>python3
<a id="__codelineno-63-3" name="__codelineno-63-3"></a><a href="#__codelineno-63-3"><span class="linenos" data-linenos=" 3 "></span></a>
<a id="__codelineno-63-4" name="__codelineno-63-4"></a><a href="#__codelineno-63-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="c1">#指定Python3的路径</span>
<a id="__codelineno-63-5" name="__codelineno-63-5"></a><a href="#__codelineno-63-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="c1">#!/usr/bin/python3</span>
<a id="__codelineno-63-6" name="__codelineno-63-6"></a><a href="#__codelineno-63-6"><span class="linenos" data-linenos=" 6 "></span></a>
<a id="__codelineno-63-7" name="__codelineno-63-7"></a><a href="#__codelineno-63-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="c1">#使用python解释器执行python脚本</span>
<a id="__codelineno-63-8" name="__codelineno-63-8"></a><a href="#__codelineno-63-8"><span class="linenos" data-linenos=" 8 "></span></a>python3<span class="w"> </span>get_domain_info.py<span class="w"> </span>
<a id="__codelineno-63-9" name="__codelineno-63-9"></a><a href="#__codelineno-63-9"><span class="linenos" data-linenos=" 9 "></span></a>
<a id="__codelineno-63-10" name="__codelineno-63-10"></a><a href="#__codelineno-63-10"><span class="linenos" data-linenos="10 "></span></a><span class="c1">#安装依赖</span>
<a id="__codelineno-63-11" name="__codelineno-63-11"></a><a href="#__codelineno-63-11"><span class="linenos" data-linenos="11 "></span></a>pip3<span class="w"> </span>install<span class="w"> </span>requests
<a id="__codelineno-63-12" name="__codelineno-63-12"></a><a href="#__codelineno-63-12"><span class="linenos" data-linenos="12 "></span></a>pip3<span class="w"> </span>uninstall<span class="w"> </span>urllib3<span class="w">      </span><span class="c1">#如果已存在其它版本，卸载</span>
<a id="__codelineno-63-13" name="__codelineno-63-13"></a><a href="#__codelineno-63-13"><span class="linenos" data-linenos="13 "></span></a>pip3<span class="w"> </span>install<span class="w"> </span><span class="nv">urllib3</span><span class="o">==</span><span class="m">1</span>.26.16
</code></pre></div>
<p>可通过执行<code>cat /tmp/certificates_jerion.txt</code>命令，查看执行结果如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-64-1" name="__codelineno-64-1"></a><a href="#__codelineno-64-1"><span class="linenos" data-linenos="1 "></span></a>Domain:<span class="w"> </span>domain.jerion.cn
<a id="__codelineno-64-2" name="__codelineno-64-2"></a><a href="#__codelineno-64-2"><span class="linenos" data-linenos="2 "></span></a>Issuer:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;C&#39;</span>:<span class="w"> </span><span class="s1">&#39;CN&#39;</span>,<span class="w"> </span><span class="s1">&#39;O&#39;</span>:<span class="w"> </span><span class="s1">&#39;TrustAsia Technologies, Inc.&#39;</span>,<span class="w"> </span><span class="s1">&#39;CN&#39;</span>:<span class="w"> </span><span class="s1">&#39;TrustAsia RSA DV TLS CA G3&#39;</span><span class="o">}</span>
<a id="__codelineno-64-3" name="__codelineno-64-3"></a><a href="#__codelineno-64-3"><span class="linenos" data-linenos="3 "></span></a>Start<span class="w"> </span>Date:<span class="w"> </span><span class="m">2024</span>-05-27<span class="w"> </span><span class="m">08</span>:00:00
<a id="__codelineno-64-4" name="__codelineno-64-4"></a><a href="#__codelineno-64-4"><span class="linenos" data-linenos="4 "></span></a>Expire<span class="w"> </span>Date:<span class="w"> </span><span class="m">2024</span>-08-26<span class="w"> </span><span class="m">07</span>:59:59
<a id="__codelineno-64-5" name="__codelineno-64-5"></a><a href="#__codelineno-64-5"><span class="linenos" data-linenos="5 "></span></a>Subject:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;CN&#39;</span>:<span class="w"> </span><span class="s1">&#39;domain.jerion.cn&#39;</span><span class="o">}</span>
<a id="__codelineno-64-6" name="__codelineno-64-6"></a><a href="#__codelineno-64-6"><span class="linenos" data-linenos="6 "></span></a>
<a id="__codelineno-64-7" name="__codelineno-64-7"></a><a href="#__codelineno-64-7"><span class="linenos" data-linenos="7 "></span></a>......
</code></pre></div>
<h3 id="3配置python脚本sunline">3.配置python脚本（sunline）<a class="headerlink" href="#3配置python脚本sunline" title="Permanent link">&para;</a></h3>
<p>这里以公司sunline的证书为例，配置的脚本文件存放在<code>/usr/local/scripts</code>目录下，脚本内容如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-65-1" name="__codelineno-65-1"></a><a href="#__codelineno-65-1"><span class="linenos" data-linenos="  1 "></span></a><span class="ch">#!/usr/bin/python3</span>
<a id="__codelineno-65-2" name="__codelineno-65-2"></a><a href="#__codelineno-65-2"><span class="linenos" data-linenos="  2 "></span></a>
<a id="__codelineno-65-3" name="__codelineno-65-3"></a><a href="#__codelineno-65-3"><span class="linenos" data-linenos="  3 "></span></a><span class="c1"># 导入必要的库</span>
<a id="__codelineno-65-4" name="__codelineno-65-4"></a><a href="#__codelineno-65-4"><span class="linenos" data-linenos="  4 "></span></a>import<span class="w"> </span><span class="nb">time</span>
<a id="__codelineno-65-5" name="__codelineno-65-5"></a><a href="#__codelineno-65-5"><span class="linenos" data-linenos="  5 "></span></a>import<span class="w"> </span>requests
<a id="__codelineno-65-6" name="__codelineno-65-6"></a><a href="#__codelineno-65-6"><span class="linenos" data-linenos="  6 "></span></a>
<a id="__codelineno-65-7" name="__codelineno-65-7"></a><a href="#__codelineno-65-7"><span class="linenos" data-linenos="  7 "></span></a><span class="c1"># 登录域名和SSL证书监控系统的账号密码</span>
<a id="__codelineno-65-8" name="__codelineno-65-8"></a><a href="#__codelineno-65-8"><span class="linenos" data-linenos="  8 "></span></a><span class="nv">admin_username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span>
<a id="__codelineno-65-9" name="__codelineno-65-9"></a><a href="#__codelineno-65-9"><span class="linenos" data-linenos="  9 "></span></a><span class="nv">admin_password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Sunline11&quot;</span>
<a id="__codelineno-65-10" name="__codelineno-65-10"></a><a href="#__codelineno-65-10"><span class="linenos" data-linenos=" 10 "></span></a>
<a id="__codelineno-65-11" name="__codelineno-65-11"></a><a href="#__codelineno-65-11"><span class="linenos" data-linenos=" 11 "></span></a><span class="c1"># 系统的登录URL和域名列表URL</span>
<a id="__codelineno-65-12" name="__codelineno-65-12"></a><a href="#__codelineno-65-12"><span class="linenos" data-linenos=" 12 "></span></a><span class="nv">login_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;http://domain.its.sunline.cn/api/login&#39;</span>
<a id="__codelineno-65-13" name="__codelineno-65-13"></a><a href="#__codelineno-65-13"><span class="linenos" data-linenos=" 13 "></span></a><span class="nv">domain_list_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;http://domain.its.sunline.cn/api/getDomainList&#39;</span>
<a id="__codelineno-65-14" name="__codelineno-65-14"></a><a href="#__codelineno-65-14"><span class="linenos" data-linenos=" 14 "></span></a><span class="nv">cert_info_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;http://domain.its.sunline.cn/api/getCertInformation&#39;</span>
<a id="__codelineno-65-15" name="__codelineno-65-15"></a><a href="#__codelineno-65-15"><span class="linenos" data-linenos=" 15 "></span></a>
<a id="__codelineno-65-16" name="__codelineno-65-16"></a><a href="#__codelineno-65-16"><span class="linenos" data-linenos=" 16 "></span></a><span class="c1"># 准备登录请求的负载</span>
<a id="__codelineno-65-17" name="__codelineno-65-17"></a><a href="#__codelineno-65-17"><span class="linenos" data-linenos=" 17 "></span></a><span class="nv">login_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-65-18" name="__codelineno-65-18"></a><a href="#__codelineno-65-18"><span class="linenos" data-linenos=" 18 "></span></a><span class="w">    </span><span class="s2">&quot;username&quot;</span>:<span class="w"> </span>admin_username,
<a id="__codelineno-65-19" name="__codelineno-65-19"></a><a href="#__codelineno-65-19"><span class="linenos" data-linenos=" 19 "></span></a><span class="w">    </span><span class="s2">&quot;password&quot;</span>:<span class="w"> </span>admin_password
<a id="__codelineno-65-20" name="__codelineno-65-20"></a><a href="#__codelineno-65-20"><span class="linenos" data-linenos=" 20 "></span></a><span class="o">}</span>
<a id="__codelineno-65-21" name="__codelineno-65-21"></a><a href="#__codelineno-65-21"><span class="linenos" data-linenos=" 21 "></span></a>
<a id="__codelineno-65-22" name="__codelineno-65-22"></a><a href="#__codelineno-65-22"><span class="linenos" data-linenos=" 22 "></span></a><span class="c1"># 发送登录请求并处理响应</span>
<a id="__codelineno-65-23" name="__codelineno-65-23"></a><a href="#__codelineno-65-23"><span class="linenos" data-linenos=" 23 "></span></a><span class="nv">login_response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>requests.post<span class="o">(</span>login_url,<span class="w"> </span><span class="nv">json</span><span class="o">=</span>login_payload<span class="o">)</span>
<a id="__codelineno-65-24" name="__codelineno-65-24"></a><a href="#__codelineno-65-24"><span class="linenos" data-linenos=" 24 "></span></a><span class="k">if</span><span class="w"> </span>login_response.status_code<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">200</span>:
<a id="__codelineno-65-25" name="__codelineno-65-25"></a><a href="#__codelineno-65-25"><span class="linenos" data-linenos=" 25 "></span></a><span class="w">    </span><span class="nv">login_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>login_response.json<span class="o">()</span>
<a id="__codelineno-65-26" name="__codelineno-65-26"></a><a href="#__codelineno-65-26"><span class="linenos" data-linenos=" 26 "></span></a><span class="w">    </span><span class="nv">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>login_data.get<span class="o">(</span><span class="s1">&#39;data&#39;</span>,<span class="w"> </span><span class="o">{})</span>.get<span class="o">(</span><span class="s1">&#39;token&#39;</span><span class="o">)</span>
<a id="__codelineno-65-27" name="__codelineno-65-27"></a><a href="#__codelineno-65-27"><span class="linenos" data-linenos=" 27 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span>token:
<a id="__codelineno-65-28" name="__codelineno-65-28"></a><a href="#__codelineno-65-28"><span class="linenos" data-linenos=" 28 "></span></a><span class="w">        </span>print<span class="o">(</span><span class="s2">&quot;登录成功，获取到 Token&quot;</span><span class="o">)</span>
<a id="__codelineno-65-29" name="__codelineno-65-29"></a><a href="#__codelineno-65-29"><span class="linenos" data-linenos=" 29 "></span></a>
<a id="__codelineno-65-30" name="__codelineno-65-30"></a><a href="#__codelineno-65-30"><span class="linenos" data-linenos=" 30 "></span></a><span class="w">        </span><span class="c1"># 设置请求头和准备获取域名列表的请求体</span>
<a id="__codelineno-65-31" name="__codelineno-65-31"></a><a href="#__codelineno-65-31"><span class="linenos" data-linenos=" 31 "></span></a><span class="w">        </span><span class="nv">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-65-32" name="__codelineno-65-32"></a><a href="#__codelineno-65-32"><span class="linenos" data-linenos=" 32 "></span></a><span class="w">            </span><span class="s2">&quot;Content-Type&quot;</span>:<span class="w"> </span><span class="s2">&quot;application/json&quot;</span>,
<a id="__codelineno-65-33" name="__codelineno-65-33"></a><a href="#__codelineno-65-33"><span class="linenos" data-linenos=" 33 "></span></a><span class="w">            </span><span class="s2">&quot;X-TOKEN&quot;</span>:<span class="w"> </span>token
<a id="__codelineno-65-34" name="__codelineno-65-34"></a><a href="#__codelineno-65-34"><span class="linenos" data-linenos=" 34 "></span></a><span class="w">        </span><span class="o">}</span>
<a id="__codelineno-65-35" name="__codelineno-65-35"></a><a href="#__codelineno-65-35"><span class="linenos" data-linenos=" 35 "></span></a>
<a id="__codelineno-65-36" name="__codelineno-65-36"></a><a href="#__codelineno-65-36"><span class="linenos" data-linenos=" 36 "></span></a><span class="w">        </span><span class="nv">all_domains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[]</span>
<a id="__codelineno-65-37" name="__codelineno-65-37"></a><a href="#__codelineno-65-37"><span class="linenos" data-linenos=" 37 "></span></a><span class="w">        </span><span class="nv">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-65-38" name="__codelineno-65-38"></a><a href="#__codelineno-65-38"><span class="linenos" data-linenos=" 38 "></span></a><span class="w">        </span><span class="nv">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="w">  </span><span class="c1"># 可调整获取更多域名</span>
<a id="__codelineno-65-39" name="__codelineno-65-39"></a><a href="#__codelineno-65-39"><span class="linenos" data-linenos=" 39 "></span></a>
<a id="__codelineno-65-40" name="__codelineno-65-40"></a><a href="#__codelineno-65-40"><span class="linenos" data-linenos=" 40 "></span></a><span class="w">        </span><span class="k">while</span><span class="w"> </span>True:
<a id="__codelineno-65-41" name="__codelineno-65-41"></a><a href="#__codelineno-65-41"><span class="linenos" data-linenos=" 41 "></span></a><span class="w">            </span><span class="nv">domain_list_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-65-42" name="__codelineno-65-42"></a><a href="#__codelineno-65-42"><span class="linenos" data-linenos=" 42 "></span></a><span class="w">                </span><span class="s2">&quot;page&quot;</span>:<span class="w"> </span>page,
<a id="__codelineno-65-43" name="__codelineno-65-43"></a><a href="#__codelineno-65-43"><span class="linenos" data-linenos=" 43 "></span></a><span class="w">                </span><span class="s2">&quot;size&quot;</span>:<span class="w"> </span>size
<a id="__codelineno-65-44" name="__codelineno-65-44"></a><a href="#__codelineno-65-44"><span class="linenos" data-linenos=" 44 "></span></a><span class="w">            </span><span class="o">}</span>
<a id="__codelineno-65-45" name="__codelineno-65-45"></a><a href="#__codelineno-65-45"><span class="linenos" data-linenos=" 45 "></span></a>
<a id="__codelineno-65-46" name="__codelineno-65-46"></a><a href="#__codelineno-65-46"><span class="linenos" data-linenos=" 46 "></span></a><span class="w">            </span><span class="nv">domain_response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>requests.post<span class="o">(</span>domain_list_url,<span class="w"> </span><span class="nv">headers</span><span class="o">=</span>headers,<span class="w"> </span><span class="nv">json</span><span class="o">=</span>domain_list_payload<span class="o">)</span>
<a id="__codelineno-65-47" name="__codelineno-65-47"></a><a href="#__codelineno-65-47"><span class="linenos" data-linenos=" 47 "></span></a><span class="w">            </span><span class="k">if</span><span class="w"> </span>domain_response.status_code<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">200</span>:
<a id="__codelineno-65-48" name="__codelineno-65-48"></a><a href="#__codelineno-65-48"><span class="linenos" data-linenos=" 48 "></span></a><span class="w">                </span><span class="nv">domain_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>domain_response.json<span class="o">()</span>
<a id="__codelineno-65-49" name="__codelineno-65-49"></a><a href="#__codelineno-65-49"><span class="linenos" data-linenos=" 49 "></span></a><span class="w">                </span><span class="nv">domain_list</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>domain_data.get<span class="o">(</span><span class="s1">&#39;data&#39;</span>,<span class="w"> </span><span class="o">{})</span>.get<span class="o">(</span><span class="s1">&#39;list&#39;</span>,<span class="w"> </span><span class="o">[])</span>
<a id="__codelineno-65-50" name="__codelineno-65-50"></a><a href="#__codelineno-65-50"><span class="linenos" data-linenos=" 50 "></span></a><span class="w">                </span><span class="k">if</span><span class="w"> </span>not<span class="w"> </span>domain_list:
<a id="__codelineno-65-51" name="__codelineno-65-51"></a><a href="#__codelineno-65-51"><span class="linenos" data-linenos=" 51 "></span></a><span class="w">                    </span><span class="k">break</span><span class="w">  </span><span class="c1"># 没有更多域名时退出循环</span>
<a id="__codelineno-65-52" name="__codelineno-65-52"></a><a href="#__codelineno-65-52"><span class="linenos" data-linenos=" 52 "></span></a>
<a id="__codelineno-65-53" name="__codelineno-65-53"></a><a href="#__codelineno-65-53"><span class="linenos" data-linenos=" 53 "></span></a><span class="w">                </span>all_domains.extend<span class="o">(</span>domain_list<span class="o">)</span>
<a id="__codelineno-65-54" name="__codelineno-65-54"></a><a href="#__codelineno-65-54"><span class="linenos" data-linenos=" 54 "></span></a><span class="w">                </span><span class="nv">page</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-65-55" name="__codelineno-65-55"></a><a href="#__codelineno-65-55"><span class="linenos" data-linenos=" 55 "></span></a><span class="w">            </span><span class="k">else</span>:
<a id="__codelineno-65-56" name="__codelineno-65-56"></a><a href="#__codelineno-65-56"><span class="linenos" data-linenos=" 56 "></span></a><span class="w">                </span>print<span class="o">(</span>f<span class="s2">&quot;获取域名列表失败。状态码: {domain_response.status_code}, 响应: {domain_response.text}&quot;</span><span class="o">)</span>
<a id="__codelineno-65-57" name="__codelineno-65-57"></a><a href="#__codelineno-65-57"><span class="linenos" data-linenos=" 57 "></span></a><span class="w">                </span><span class="k">break</span>
<a id="__codelineno-65-58" name="__codelineno-65-58"></a><a href="#__codelineno-65-58"><span class="linenos" data-linenos=" 58 "></span></a>
<a id="__codelineno-65-59" name="__codelineno-65-59"></a><a href="#__codelineno-65-59"><span class="linenos" data-linenos=" 59 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span>all_domains:
<a id="__codelineno-65-60" name="__codelineno-65-60"></a><a href="#__codelineno-65-60"><span class="linenos" data-linenos=" 60 "></span></a><span class="w">            </span><span class="nv">file_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;/tmp/certificates_sunline.txt&#39;</span>
<a id="__codelineno-65-61" name="__codelineno-65-61"></a><a href="#__codelineno-65-61"><span class="linenos" data-linenos=" 61 "></span></a><span class="w">            </span>with<span class="w"> </span>open<span class="o">(</span>file_path,<span class="w"> </span><span class="s1">&#39;w&#39;</span><span class="o">)</span><span class="w"> </span>as<span class="w"> </span>file:
<a id="__codelineno-65-62" name="__codelineno-65-62"></a><a href="#__codelineno-65-62"><span class="linenos" data-linenos=" 62 "></span></a><span class="w">                </span><span class="k">for</span><span class="w"> </span>domain_info<span class="w"> </span><span class="k">in</span><span class="w"> </span>all_domains:
<a id="__codelineno-65-63" name="__codelineno-65-63"></a><a href="#__codelineno-65-63"><span class="linenos" data-linenos=" 63 "></span></a><span class="w">                    </span><span class="nv">domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>domain_info.get<span class="o">(</span><span class="s1">&#39;domain&#39;</span><span class="o">)</span>
<a id="__codelineno-65-64" name="__codelineno-65-64"></a><a href="#__codelineno-65-64"><span class="linenos" data-linenos=" 64 "></span></a><span class="w">                    </span>print<span class="o">(</span>f<span class="s2">&quot;获取域名: {domain}&quot;</span><span class="o">)</span>
<a id="__codelineno-65-65" name="__codelineno-65-65"></a><a href="#__codelineno-65-65"><span class="linenos" data-linenos=" 65 "></span></a><span class="w">                    </span>time.sleep<span class="o">(</span><span class="m">1</span><span class="o">)</span>
<a id="__codelineno-65-66" name="__codelineno-65-66"></a><a href="#__codelineno-65-66"><span class="linenos" data-linenos=" 66 "></span></a>
<a id="__codelineno-65-67" name="__codelineno-65-67"></a><a href="#__codelineno-65-67"><span class="linenos" data-linenos=" 67 "></span></a><span class="w">                    </span><span class="c1"># 循环处理每个域名，获取其证书信息并写入文件</span>
<a id="__codelineno-65-68" name="__codelineno-65-68"></a><a href="#__codelineno-65-68"><span class="linenos" data-linenos=" 68 "></span></a><span class="w">                    </span><span class="nv">cert_payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">{</span>
<a id="__codelineno-65-69" name="__codelineno-65-69"></a><a href="#__codelineno-65-69"><span class="linenos" data-linenos=" 69 "></span></a><span class="w">                        </span><span class="s2">&quot;domain&quot;</span>:<span class="w"> </span>domain
<a id="__codelineno-65-70" name="__codelineno-65-70"></a><a href="#__codelineno-65-70"><span class="linenos" data-linenos=" 70 "></span></a><span class="w">                    </span><span class="o">}</span>
<a id="__codelineno-65-71" name="__codelineno-65-71"></a><a href="#__codelineno-65-71"><span class="linenos" data-linenos=" 71 "></span></a><span class="w">                    </span><span class="nv">cert_response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>requests.post<span class="o">(</span>cert_info_url,<span class="w"> </span><span class="nv">headers</span><span class="o">=</span>headers,<span class="w"> </span><span class="nv">json</span><span class="o">=</span>cert_payload<span class="o">)</span>
<a id="__codelineno-65-72" name="__codelineno-65-72"></a><a href="#__codelineno-65-72"><span class="linenos" data-linenos=" 72 "></span></a>
<a id="__codelineno-65-73" name="__codelineno-65-73"></a><a href="#__codelineno-65-73"><span class="linenos" data-linenos=" 73 "></span></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span>cert_response.status_code<span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">200</span>:
<a id="__codelineno-65-74" name="__codelineno-65-74"></a><a href="#__codelineno-65-74"><span class="linenos" data-linenos=" 74 "></span></a><span class="w">                        </span><span class="nv">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>cert_response.json<span class="o">()</span>
<a id="__codelineno-65-75" name="__codelineno-65-75"></a><a href="#__codelineno-65-75"><span class="linenos" data-linenos=" 75 "></span></a><span class="w">                        </span>print<span class="o">(</span>f<span class="s2">&quot;证书响应: {data}&quot;</span><span class="o">)</span>
<a id="__codelineno-65-76" name="__codelineno-65-76"></a><a href="#__codelineno-65-76"><span class="linenos" data-linenos=" 76 "></span></a><span class="w">                        </span>time.sleep<span class="o">(</span><span class="m">1</span><span class="o">)</span>
<a id="__codelineno-65-77" name="__codelineno-65-77"></a><a href="#__codelineno-65-77"><span class="linenos" data-linenos=" 77 "></span></a>
<a id="__codelineno-65-78" name="__codelineno-65-78"></a><a href="#__codelineno-65-78"><span class="linenos" data-linenos=" 78 "></span></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span>data.get<span class="o">(</span><span class="s1">&#39;code&#39;</span><span class="o">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span>:
<a id="__codelineno-65-79" name="__codelineno-65-79"></a><a href="#__codelineno-65-79"><span class="linenos" data-linenos=" 79 "></span></a><span class="w">                            </span><span class="nv">cert_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>data.get<span class="o">(</span><span class="s1">&#39;data&#39;</span>,<span class="w"> </span><span class="o">{})</span>
<a id="__codelineno-65-80" name="__codelineno-65-80"></a><a href="#__codelineno-65-80"><span class="linenos" data-linenos=" 80 "></span></a><span class="w">                            </span><span class="nv">parsed_cert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>cert_info.get<span class="o">(</span><span class="s1">&#39;parsed_cert&#39;</span>,<span class="w"> </span><span class="o">{})</span>
<a id="__codelineno-65-81" name="__codelineno-65-81"></a><a href="#__codelineno-65-81"><span class="linenos" data-linenos=" 81 "></span></a><span class="w">                            </span><span class="nv">domain_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>cert_info.get<span class="o">(</span><span class="s1">&#39;resolve_domain&#39;</span><span class="o">)</span>
<a id="__codelineno-65-82" name="__codelineno-65-82"></a><a href="#__codelineno-65-82"><span class="linenos" data-linenos=" 82 "></span></a><span class="w">                            </span><span class="nv">issuer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>parsed_cert.get<span class="o">(</span><span class="s1">&#39;issuer&#39;</span>,<span class="w"> </span><span class="o">{})</span>
<a id="__codelineno-65-83" name="__codelineno-65-83"></a><a href="#__codelineno-65-83"><span class="linenos" data-linenos=" 83 "></span></a><span class="w">                            </span><span class="nv">start_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>parsed_cert.get<span class="o">(</span><span class="s1">&#39;notBefore&#39;</span><span class="o">)</span>
<a id="__codelineno-65-84" name="__codelineno-65-84"></a><a href="#__codelineno-65-84"><span class="linenos" data-linenos=" 84 "></span></a><span class="w">                            </span><span class="nv">expire_date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>parsed_cert.get<span class="o">(</span><span class="s1">&#39;notAfter&#39;</span><span class="o">)</span>
<a id="__codelineno-65-85" name="__codelineno-65-85"></a><a href="#__codelineno-65-85"><span class="linenos" data-linenos=" 85 "></span></a><span class="w">                            </span><span class="nv">subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>parsed_cert.get<span class="o">(</span><span class="s1">&#39;subject&#39;</span>,<span class="w"> </span><span class="o">{})</span>
<a id="__codelineno-65-86" name="__codelineno-65-86"></a><a href="#__codelineno-65-86"><span class="linenos" data-linenos=" 86 "></span></a>
<a id="__codelineno-65-87" name="__codelineno-65-87"></a><a href="#__codelineno-65-87"><span class="linenos" data-linenos=" 87 "></span></a><span class="w">                            </span>try:
<a id="__codelineno-65-88" name="__codelineno-65-88"></a><a href="#__codelineno-65-88"><span class="linenos" data-linenos=" 88 "></span></a><span class="w">                                </span>file.write<span class="o">(</span>f<span class="s2">&quot;Domain: {domain_name}\n&quot;</span><span class="o">)</span>
<a id="__codelineno-65-89" name="__codelineno-65-89"></a><a href="#__codelineno-65-89"><span class="linenos" data-linenos=" 89 "></span></a><span class="w">                                </span>file.write<span class="o">(</span>f<span class="s2">&quot;Issuer: {issuer}\n&quot;</span><span class="o">)</span>
<a id="__codelineno-65-90" name="__codelineno-65-90"></a><a href="#__codelineno-65-90"><span class="linenos" data-linenos=" 90 "></span></a><span class="w">                                </span>file.write<span class="o">(</span>f<span class="s2">&quot;Start Date: {start_date}\n&quot;</span><span class="o">)</span>
<a id="__codelineno-65-91" name="__codelineno-65-91"></a><a href="#__codelineno-65-91"><span class="linenos" data-linenos=" 91 "></span></a><span class="w">                                </span>file.write<span class="o">(</span>f<span class="s2">&quot;Expire Date: {expire_date}\n&quot;</span><span class="o">)</span>
<a id="__codelineno-65-92" name="__codelineno-65-92"></a><a href="#__codelineno-65-92"><span class="linenos" data-linenos=" 92 "></span></a><span class="w">                                </span>file.write<span class="o">(</span>f<span class="s2">&quot;Subject: {subject}\n&quot;</span><span class="o">)</span>
<a id="__codelineno-65-93" name="__codelineno-65-93"></a><a href="#__codelineno-65-93"><span class="linenos" data-linenos=" 93 "></span></a><span class="w">                                </span>file.write<span class="o">(</span><span class="s2">&quot;\n&quot;</span><span class="o">)</span>
<a id="__codelineno-65-94" name="__codelineno-65-94"></a><a href="#__codelineno-65-94"><span class="linenos" data-linenos=" 94 "></span></a><span class="w">                                </span>print<span class="o">(</span>f<span class="s2">&quot;写入文件: Domain: {domain_name}, Issuer: {issuer}, Start Date: {start_date}, Expire Date: {expire_date}, Subject: {subject}&quot;</span><span class="o">)</span>
<a id="__codelineno-65-95" name="__codelineno-65-95"></a><a href="#__codelineno-65-95"><span class="linenos" data-linenos=" 95 "></span></a><span class="w">                            </span>except<span class="w"> </span>Exception<span class="w"> </span>as<span class="w"> </span>e:
<a id="__codelineno-65-96" name="__codelineno-65-96"></a><a href="#__codelineno-65-96"><span class="linenos" data-linenos=" 96 "></span></a><span class="w">                                </span>print<span class="o">(</span>f<span class="s2">&quot;写入文件失败: {e}&quot;</span><span class="o">)</span>
<a id="__codelineno-65-97" name="__codelineno-65-97"></a><a href="#__codelineno-65-97"><span class="linenos" data-linenos=" 97 "></span></a><span class="w">                        </span><span class="k">else</span>:
<a id="__codelineno-65-98" name="__codelineno-65-98"></a><a href="#__codelineno-65-98"><span class="linenos" data-linenos=" 98 "></span></a><span class="w">                            </span>print<span class="o">(</span>f<span class="s2">&quot;获取 {domain} 的证书信息失败。返回消息: {data.get(&#39;msg&#39;)}&quot;</span><span class="o">)</span>
<a id="__codelineno-65-99" name="__codelineno-65-99"></a><a href="#__codelineno-65-99"><span class="linenos" data-linenos=" 99 "></span></a><span class="w">                    </span><span class="k">else</span>:
<a id="__codelineno-65-100" name="__codelineno-65-100"></a><a href="#__codelineno-65-100"><span class="linenos" data-linenos="100 "></span></a><span class="w">                        </span>print<span class="o">(</span>f<span class="s2">&quot;获取 {domain} 的证书信息失败。状态码: {cert_response.status_code}, 响应: {cert_response.text}&quot;</span><span class="o">)</span>
<a id="__codelineno-65-101" name="__codelineno-65-101"></a><a href="#__codelineno-65-101"><span class="linenos" data-linenos="101 "></span></a><span class="w">                    </span>print<span class="o">()</span>
<a id="__codelineno-65-102" name="__codelineno-65-102"></a><a href="#__codelineno-65-102"><span class="linenos" data-linenos="102 "></span></a><span class="w">                    </span>time.sleep<span class="o">(</span><span class="m">2</span><span class="o">)</span>
<a id="__codelineno-65-103" name="__codelineno-65-103"></a><a href="#__codelineno-65-103"><span class="linenos" data-linenos="103 "></span></a><span class="w">        </span><span class="k">else</span>:
<a id="__codelineno-65-104" name="__codelineno-65-104"></a><a href="#__codelineno-65-104"><span class="linenos" data-linenos="104 "></span></a><span class="w">            </span>print<span class="o">(</span><span class="s2">&quot;未找到任何域名。&quot;</span><span class="o">)</span>
<a id="__codelineno-65-105" name="__codelineno-65-105"></a><a href="#__codelineno-65-105"><span class="linenos" data-linenos="105 "></span></a><span class="w">    </span><span class="k">else</span>:
<a id="__codelineno-65-106" name="__codelineno-65-106"></a><a href="#__codelineno-65-106"><span class="linenos" data-linenos="106 "></span></a><span class="w">        </span>print<span class="o">(</span><span class="s2">&quot;登录失败，未能获取到 Token&quot;</span><span class="o">)</span>
<a id="__codelineno-65-107" name="__codelineno-65-107"></a><a href="#__codelineno-65-107"><span class="linenos" data-linenos="107 "></span></a><span class="k">else</span>:
<a id="__codelineno-65-108" name="__codelineno-65-108"></a><a href="#__codelineno-65-108"><span class="linenos" data-linenos="108 "></span></a><span class="w">    </span>print<span class="o">(</span>f<span class="s2">&quot;登录失败。状态码: {login_response.status_code}, 响应: {login_response.text}&quot;</span><span class="o">)</span>
<a id="__codelineno-65-109" name="__codelineno-65-109"></a><a href="#__codelineno-65-109"><span class="linenos" data-linenos="109 "></span></a>
<a id="__codelineno-65-110" name="__codelineno-65-110"></a><a href="#__codelineno-65-110"><span class="linenos" data-linenos="110 "></span></a>print<span class="o">(</span><span class="s2">&quot;获取证书信息执行结束！&quot;</span><span class="o">)</span>
</code></pre></div>
<p><strong>脚本说明：</strong></p>
<p>​       这里是与前面的脚本唯一不同的地方，因为脚本里配置的<code>size</code>属性值为<code>10</code>，即每一页最多显示10个域名信息，而公司内的域名比较多，会不止一页，因此通过在<code>while Ture</code>循环语句来增加页数<code>page</code>，直到最后一个域名打破跳出循坏。</p>
<h3 id="4运行python脚本sunline">4.运行python脚本（sunline）<a class="headerlink" href="#4运行python脚本sunline" title="Permanent link">&para;</a></h3>
<p>使用<code>python3</code>命令执行脚本<code>get_domain_info_sunline.py</code>：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-66-1" name="__codelineno-66-1"></a><a href="#__codelineno-66-1"><span class="linenos" data-linenos="1 "></span></a>python3<span class="w"> </span>get_domain_sunline.py<span class="w"> </span>
</code></pre></div>
<p>可通过执行<code>cat /tmp/certificates_sunline.txt</code>命令，查看执行结果如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-67-1" name="__codelineno-67-1"></a><a href="#__codelineno-67-1"><span class="linenos" data-linenos="1 "></span></a>Domain:<span class="w"> </span>harbor.sh.sunline.cn
<a id="__codelineno-67-2" name="__codelineno-67-2"></a><a href="#__codelineno-67-2"><span class="linenos" data-linenos="2 "></span></a>Issuer:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;C&#39;</span>:<span class="w"> </span><span class="s1">&#39;CN&#39;</span>,<span class="w"> </span><span class="s1">&#39;O&#39;</span>:<span class="w"> </span><span class="s1">&#39;TrustAsia Technologies, Inc.&#39;</span>,<span class="w"> </span><span class="s1">&#39;CN&#39;</span>:<span class="w"> </span><span class="s1">&#39;TrustAsia RSA DV TLS CA G2&#39;</span><span class="o">}</span>
<a id="__codelineno-67-3" name="__codelineno-67-3"></a><a href="#__codelineno-67-3"><span class="linenos" data-linenos="3 "></span></a>Start<span class="w"> </span>Date:<span class="w"> </span><span class="m">2023</span>-07-21<span class="w"> </span><span class="m">08</span>:00:00
<a id="__codelineno-67-4" name="__codelineno-67-4"></a><a href="#__codelineno-67-4"><span class="linenos" data-linenos="4 "></span></a>Expire<span class="w"> </span>Date:<span class="w"> </span><span class="m">2024</span>-07-21<span class="w"> </span><span class="m">07</span>:59:59
<a id="__codelineno-67-5" name="__codelineno-67-5"></a><a href="#__codelineno-67-5"><span class="linenos" data-linenos="5 "></span></a>Subject:<span class="w"> </span><span class="o">{</span><span class="s1">&#39;CN&#39;</span>:<span class="w"> </span><span class="s1">&#39;harbor.sh.sunline.cn&#39;</span><span class="o">}</span>
<a id="__codelineno-67-6" name="__codelineno-67-6"></a><a href="#__codelineno-67-6"><span class="linenos" data-linenos="6 "></span></a>
<a id="__codelineno-67-7" name="__codelineno-67-7"></a><a href="#__codelineno-67-7"><span class="linenos" data-linenos="7 "></span></a>......
</code></pre></div>
<h2 id="八获取nginx配置">八、获取nginx配置<a class="headerlink" href="#八获取nginx配置" title="Permanent link">&para;</a></h2>
<blockquote>
<p><strong>前面ansible获取nginx信息，是手动一个个执行ansible命令，以下是通过脚本，定义好server文件，自动执行，执行完成会筛出nginx的IP、安装路径、证书、密钥等等信息。</strong></p>
</blockquote>
<h3 id="1导出域名信息">1.导出域名信息<a class="headerlink" href="#1导出域名信息" title="Permanent link">&para;</a></h3>
<p>登录<a href="http://domain.its.sunline.cn">Domain Admin-域名和SSL证书监控系统</a>，打开【证书列表】，导出域名信息，命名为<code>domain_info.txt</code>，并上传到服务器上的<code>/usr/local/scripts/domain/</code>目录下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-68-1" name="__codelineno-68-1"></a><a href="#__codelineno-68-1"><span class="linenos" data-linenos="1 "></span></a>mkdir<span class="w"> </span>/usr/local/scripts/domain
<a id="__codelineno-68-2" name="__codelineno-68-2"></a><a href="#__codelineno-68-2"><span class="linenos" data-linenos="2 "></span></a><span class="nb">cd</span><span class="w"> </span>/usr/local/scripts/domain
<a id="__codelineno-68-3" name="__codelineno-68-3"></a><a href="#__codelineno-68-3"><span class="linenos" data-linenos="3 "></span></a>rz
</code></pre></div>
<h3 id="2配置将域名解析为ip的脚本">2.配置将域名解析为IP的脚本<a class="headerlink" href="#2配置将域名解析为ip的脚本" title="Permanent link">&para;</a></h3>
<h4 id="21-仅输出为ip信息且不重复">2.1 仅输出为IP信息且不重复<a class="headerlink" href="#21-仅输出为ip信息且不重复" title="Permanent link">&para;</a></h4>
<h5 id="211-配置shell脚本">2.1.1 配置shell脚本<a class="headerlink" href="#211-配置shell脚本" title="Permanent link">&para;</a></h5>
<p>通过<code>ping</code>命令读取一个包含域名的输入文件<code>domain_info.txt</code>，将每个域名解析出对应的服务器IP地址，并存入到<code>/usr/local/scripts/domain</code>目录下的<code>server_ip</code>输出文件内。</p>
<p>这里创建了一个shell脚本<code>ping_domain.sh</code>，用于批量<code>ping</code>域名解析到的IP并存到文件内，具体内容如下：</p>
<div class="language-shell highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-69-1" name="__codelineno-69-1"></a><a href="#__codelineno-69-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-69-2" name="__codelineno-69-2"></a><a href="#__codelineno-69-2"><span class="linenos" data-linenos=" 2 "></span></a>
<a id="__codelineno-69-3" name="__codelineno-69-3"></a><a href="#__codelineno-69-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="c1"># 域名信息路径</span>
<a id="__codelineno-69-4" name="__codelineno-69-4"></a><a href="#__codelineno-69-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="nv">DOMAIN_FILE</span><span class="o">=</span><span class="s2">&quot;/usr/local/scripts/domain/domain_info.txt&quot;</span>
<a id="__codelineno-69-5" name="__codelineno-69-5"></a><a href="#__codelineno-69-5"><span class="linenos" data-linenos=" 5 "></span></a>
<a id="__codelineno-69-6" name="__codelineno-69-6"></a><a href="#__codelineno-69-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="c1"># 存入IP地址的文件</span>
<a id="__codelineno-69-7" name="__codelineno-69-7"></a><a href="#__codelineno-69-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="nv">OUTPUT_FILE</span><span class="o">=</span><span class="s2">&quot;/usr/local/scripts/domain/server_ip&quot;</span>
<a id="__codelineno-69-8" name="__codelineno-69-8"></a><a href="#__codelineno-69-8"><span class="linenos" data-linenos=" 8 "></span></a>
<a id="__codelineno-69-9" name="__codelineno-69-9"></a><a href="#__codelineno-69-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="c1"># 邮箱域名解析的IP</span>
<a id="__codelineno-69-10" name="__codelineno-69-10"></a><a href="#__codelineno-69-10"><span class="linenos" data-linenos="10 "></span></a><span class="nv">SKIP_IP</span><span class="o">=</span><span class="s2">&quot;14.17.27.155&quot;</span>
<a id="__codelineno-69-11" name="__codelineno-69-11"></a><a href="#__codelineno-69-11"><span class="linenos" data-linenos="11 "></span></a>
<a id="__codelineno-69-12" name="__codelineno-69-12"></a><a href="#__codelineno-69-12"><span class="linenos" data-linenos="12 "></span></a>&gt;<span class="w"> </span><span class="nv">$OUTPUT_FILE</span>
<a id="__codelineno-69-13" name="__codelineno-69-13"></a><a href="#__codelineno-69-13"><span class="linenos" data-linenos="13 "></span></a>
<a id="__codelineno-69-14" name="__codelineno-69-14"></a><a href="#__codelineno-69-14"><span class="linenos" data-linenos="14 "></span></a><span class="c1"># 创建临时文件</span>
<a id="__codelineno-69-15" name="__codelineno-69-15"></a><a href="#__codelineno-69-15"><span class="linenos" data-linenos="15 "></span></a><span class="nv">TEMP_FILE</span><span class="o">=</span><span class="k">$(</span>mktemp<span class="k">)</span>
<a id="__codelineno-69-16" name="__codelineno-69-16"></a><a href="#__codelineno-69-16"><span class="linenos" data-linenos="16 "></span></a>
<a id="__codelineno-69-17" name="__codelineno-69-17"></a><a href="#__codelineno-69-17"><span class="linenos" data-linenos="17 "></span></a><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>domain<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-69-18" name="__codelineno-69-18"></a><a href="#__codelineno-69-18"><span class="linenos" data-linenos="18 "></span></a><span class="w">  </span><span class="nv">ip</span><span class="o">=</span><span class="k">$(</span>ping<span class="w"> </span>-c<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="nv">$domain</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;PING&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F<span class="s1">&#39;[()]&#39;</span><span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
<a id="__codelineno-69-19" name="__codelineno-69-19"></a><a href="#__codelineno-69-19"><span class="linenos" data-linenos="19 "></span></a>
<a id="__codelineno-69-20" name="__codelineno-69-20"></a><a href="#__codelineno-69-20"><span class="linenos" data-linenos="20 "></span></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ip</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ip</span><span class="s2">&quot;</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$SKIP_IP</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>!<span class="w"> </span>grep<span class="w"> </span>-q<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ip</span><span class="s2">&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TEMP_FILE</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-69-21" name="__codelineno-69-21"></a><a href="#__codelineno-69-21"><span class="linenos" data-linenos="21 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ip</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$OUTPUT_FILE</span>
<a id="__codelineno-69-22" name="__codelineno-69-22"></a><a href="#__codelineno-69-22"><span class="linenos" data-linenos="22 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$ip</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$TEMP_FILE</span>
<a id="__codelineno-69-23" name="__codelineno-69-23"></a><a href="#__codelineno-69-23"><span class="linenos" data-linenos="23 "></span></a><span class="w">  </span><span class="k">fi</span>
<a id="__codelineno-69-24" name="__codelineno-69-24"></a><a href="#__codelineno-69-24"><span class="linenos" data-linenos="24 "></span></a><span class="k">done</span><span class="w"> </span>&lt;<span class="w"> </span><span class="nv">$DOMAIN_FILE</span>
<a id="__codelineno-69-25" name="__codelineno-69-25"></a><a href="#__codelineno-69-25"><span class="linenos" data-linenos="25 "></span></a>
<a id="__codelineno-69-26" name="__codelineno-69-26"></a><a href="#__codelineno-69-26"><span class="linenos" data-linenos="26 "></span></a>rm<span class="w"> </span><span class="nv">$TEMP_FILE</span>
<a id="__codelineno-69-27" name="__codelineno-69-27"></a><a href="#__codelineno-69-27"><span class="linenos" data-linenos="27 "></span></a>
<a id="__codelineno-69-28" name="__codelineno-69-28"></a><a href="#__codelineno-69-28"><span class="linenos" data-linenos="28 "></span></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Ping操作完成，结果已保存到</span><span class="nv">$OUTPUT_FILE</span><span class="s2">。&quot;</span>
</code></pre></div>
<p><strong>脚本说明：</strong></p>
<ul>
<li>
<p><code>&gt; $OUTPUT_FILE</code>：清空 <code>OUTPUT_FILE</code> 文件的内容。如果文件不存在，则会创建一个空文件。</p>
</li>
<li>
<p><code>TEMP_FILE=$(mktemp)</code>：创建一个临时文件，并将临时文件的路径保存到变量 <code>TEMP_FILE</code> 中。这里的作用是为了跟踪已经处理过的IP地址，确保每个IP地址只处理一次，并避免重复记录。</p>
</li>
<li>
<p><code>while read -r domain; do ... done &lt; $DOMAIN_FILE</code>：读取 <code>DOMAIN_FILE</code> 文件中的每一行（即每个域名），对每个域名执行循环体内的命令。</p>
</li>
<li>
<p><code>ip=$(......)</code>：获取IP地址。</p>
</li>
<li>
<p><code>ping -c 1 $domain</code>：对当前读取的域名执行 <code>ping</code> 命令，只发送一个包（<code>-c 1</code>）。</p>
</li>
<li><code>grep 'PING'</code>：从 <code>ping</code> 命令的输出中筛选包含<code>PING</code>文本内容的行。</li>
<li><code>awk -F'[()]' '{print $2}'</code>：将 <code>grep</code> 命令筛选出的行作为输入，并使用 <code>awk</code> 来处理，最终打印出第二个字段。<ul>
<li><code>-F</code> ：用于指定字段分隔符；</li>
<li><code>[()]</code>：是一个正则表达式字符类，匹配中括号内的任意一个字符，这里表示匹配括号 <code>(</code> 或 <code>)</code> 作为分隔符；</li>
<li><code>{print $2}</code>：表示打印分隔后的第二个字段。</li>
</ul>
</li>
</ul>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-70-1" name="__codelineno-70-1"></a><a href="#__codelineno-70-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>domain<span class="o">]</span><span class="c1"># ping -c 1 iboss.sunline.cn</span>
<a id="__codelineno-70-2" name="__codelineno-70-2"></a><a href="#__codelineno-70-2"><span class="linenos" data-linenos=" 2 "></span></a>PING<span class="w"> </span>iboss.sunline.cn<span class="w"> </span><span class="o">(</span><span class="m">172</span>.18.0.160<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<a id="__codelineno-70-3" name="__codelineno-70-3"></a><a href="#__codelineno-70-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="m">64</span><span class="w"> </span>bytes<span class="w"> </span>from<span class="w"> </span>wecom.iboss.sunline.cn<span class="w"> </span><span class="o">(</span><span class="m">172</span>.18.0.160<span class="o">)</span>:<span class="w"> </span><span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span><span class="w"> </span><span class="nv">ttl</span><span class="o">=</span><span class="m">63</span><span class="w"> </span><span class="nv">time</span><span class="o">=</span><span class="m">0</span>.174<span class="w"> </span>ms
<a id="__codelineno-70-4" name="__codelineno-70-4"></a><a href="#__codelineno-70-4"><span class="linenos" data-linenos=" 4 "></span></a>
<a id="__codelineno-70-5" name="__codelineno-70-5"></a><a href="#__codelineno-70-5"><span class="linenos" data-linenos=" 5 "></span></a>---<span class="w"> </span>iboss.sunline.cn<span class="w"> </span>ping<span class="w"> </span>statistics<span class="w"> </span>---
<a id="__codelineno-70-6" name="__codelineno-70-6"></a><a href="#__codelineno-70-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="m">1</span><span class="w"> </span>packets<span class="w"> </span>transmitted,<span class="w"> </span><span class="m">1</span><span class="w"> </span>received,<span class="w"> </span><span class="m">0</span>%<span class="w"> </span>packet<span class="w"> </span>loss,<span class="w"> </span><span class="nb">time</span><span class="w"> </span>0ms
<a id="__codelineno-70-7" name="__codelineno-70-7"></a><a href="#__codelineno-70-7"><span class="linenos" data-linenos=" 7 "></span></a>rtt<span class="w"> </span>min/avg/max/mdev<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.174/0.174/0.174/0.000<span class="w"> </span>ms
<a id="__codelineno-70-8" name="__codelineno-70-8"></a><a href="#__codelineno-70-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>domain<span class="o">]</span><span class="c1"># ping -c 1 iboss.sunline.cn | grep &#39;PING&#39;</span>
<a id="__codelineno-70-9" name="__codelineno-70-9"></a><a href="#__codelineno-70-9"><span class="linenos" data-linenos=" 9 "></span></a>PING<span class="w"> </span>iboss.sunline.cn<span class="w"> </span><span class="o">(</span><span class="m">172</span>.18.0.161<span class="o">)</span><span class="w"> </span><span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span><span class="w"> </span>bytes<span class="w"> </span>of<span class="w"> </span>data.
<a id="__codelineno-70-10" name="__codelineno-70-10"></a><a href="#__codelineno-70-10"><span class="linenos" data-linenos="10 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>domain<span class="o">]</span><span class="c1"># ping -c 1 iboss.sunline.cn | grep &#39;PING&#39; | awk -F&#39;[()]&#39; &#39;{print $2}&#39; </span>
<a id="__codelineno-70-11" name="__codelineno-70-11"></a><a href="#__codelineno-70-11"><span class="linenos" data-linenos="11 "></span></a><span class="m">172</span>.18.0.161
</code></pre></div>
<ul>
<li>
<p><code>-n "$ip"</code>：检查变量 <code>ip</code> 是否非空，如果 <code>ip</code> 是一个非空字符串，这个条件为真。</p>
</li>
<li>
<p><code>grep -q "$ip" "$TEMP_FILE"</code>：用于检查 <code>TEMP_FILE</code> 文件中是否包含指定的IP地址（即变量 <code>ip</code> 的内容）。</p>
</li>
<li>
<p><code>grep</code> 是一个搜索工具，用于在文件或标准输入中搜索文本。</p>
</li>
<li><code>-q</code> 选项告诉 <code>grep</code> 以安静模式（quiet mode）运行，即不输出任何内容，只返回一个退出状态码。<ul>
<li>如果找到匹配的行，<code>grep</code> 返回退出状态码 0；</li>
<li>如果未找到匹配的行，<code>grep</code> 返回退出状态码 1。</li>
</ul>
</li>
<li><code>"$ip"</code> ：要搜索的模式，即IP地址。</li>
<li><code>"$TEMP_FILE"</code> ：要搜索的文件。</li>
</ul>
<h5 id="212-运行shell脚本">2.1.2 运行shell脚本<a class="headerlink" href="#212-运行shell脚本" title="Permanent link">&para;</a></h5>
<p>通过<code>sh</code>命令执行脚本<code>ping_domain.sh</code>，该脚本存放于<code>/usr/local/scripts/domain</code>目录下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-71-1" name="__codelineno-71-1"></a><a href="#__codelineno-71-1"><span class="linenos" data-linenos="1 "></span></a><span class="nb">cd</span><span class="w"> </span>/usr/local/scripts/domain
<a id="__codelineno-71-2" name="__codelineno-71-2"></a><a href="#__codelineno-71-2"><span class="linenos" data-linenos="2 "></span></a>sh<span class="w"> </span>ping_domain.sh
</code></pre></div>
<p>执行后的<code>server_ip</code>文件内容如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-72-1" name="__codelineno-72-1"></a><a href="#__codelineno-72-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>domain<span class="o">]</span><span class="c1"># cat server_ip</span>
<a id="__codelineno-72-2" name="__codelineno-72-2"></a><a href="#__codelineno-72-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="m">10</span>.10.200.19
<a id="__codelineno-72-3" name="__codelineno-72-3"></a><a href="#__codelineno-72-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="m">172</span>.18.0.160
<a id="__codelineno-72-4" name="__codelineno-72-4"></a><a href="#__codelineno-72-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="m">172</span>.18.0.79
<a id="__codelineno-72-5" name="__codelineno-72-5"></a><a href="#__codelineno-72-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="m">172</span>.18.0.100
<a id="__codelineno-72-6" name="__codelineno-72-6"></a><a href="#__codelineno-72-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="m">10</span>.22.50.249
<a id="__codelineno-72-7" name="__codelineno-72-7"></a><a href="#__codelineno-72-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="m">10</span>.22.50.221
<a id="__codelineno-72-8" name="__codelineno-72-8"></a><a href="#__codelineno-72-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="m">10</span>.22.50.220
<a id="__codelineno-72-9" name="__codelineno-72-9"></a><a href="#__codelineno-72-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="m">172</span>.18.0.78
<a id="__codelineno-72-10" name="__codelineno-72-10"></a><a href="#__codelineno-72-10"><span class="linenos" data-linenos="10 "></span></a><span class="m">10</span>.22.21.99
<a id="__codelineno-72-11" name="__codelineno-72-11"></a><a href="#__codelineno-72-11"><span class="linenos" data-linenos="11 "></span></a><span class="m">10</span>.22.50.135
<a id="__codelineno-72-12" name="__codelineno-72-12"></a><a href="#__codelineno-72-12"><span class="linenos" data-linenos="12 "></span></a><span class="m">172</span>.18.0.161
<a id="__codelineno-72-13" name="__codelineno-72-13"></a><a href="#__codelineno-72-13"><span class="linenos" data-linenos="13 "></span></a><span class="m">10</span>.22.50.129
<a id="__codelineno-72-14" name="__codelineno-72-14"></a><a href="#__codelineno-72-14"><span class="linenos" data-linenos="14 "></span></a><span class="m">172</span>.18.0.82
<a id="__codelineno-72-15" name="__codelineno-72-15"></a><a href="#__codelineno-72-15"><span class="linenos" data-linenos="15 "></span></a><span class="m">172</span>.18.0.50
</code></pre></div>
<h4 id="22-输出为域名ip信息">2.2 输出为域名+IP信息<a class="headerlink" href="#22-输出为域名ip信息" title="Permanent link">&para;</a></h4>
<h5 id="221-配置shell脚本">2.2.1 配置shell脚本<a class="headerlink" href="#221-配置shell脚本" title="Permanent link">&para;</a></h5>
<p>检查并安装<code>dig</code>命令（如果未安装），然后读取一个包含域名的输入文件<code>domain_info.txt</code>，对每个域名进行DNS解析，并将解析结果保存到<code>/usr/local/scripts/domain</code>目录下的<code>server_domain_ip</code>输出文件内。</p>
<p>这里创建了一个shell脚本<code>get_domain_ip.sh</code>，确保shell脚本和输入输出文件放在同一个目录，用于批量<code>dig</code>域名解析到的IP并将域名和IP存到文件内，具体内容如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-73-1" name="__codelineno-73-1"></a><a href="#__codelineno-73-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-73-2" name="__codelineno-73-2"></a><a href="#__codelineno-73-2"><span class="linenos" data-linenos=" 2 "></span></a>
<a id="__codelineno-73-3" name="__codelineno-73-3"></a><a href="#__codelineno-73-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="k">if</span><span class="w"> </span>!<span class="w"> </span>which<span class="w"> </span>dig<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-73-4" name="__codelineno-73-4"></a><a href="#__codelineno-73-4"><span class="linenos" data-linenos=" 4 "></span></a>
<a id="__codelineno-73-5" name="__codelineno-73-5"></a><a href="#__codelineno-73-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;dig 命令未安装，正在安装.....&quot;</span>
<a id="__codelineno-73-6" name="__codelineno-73-6"></a><a href="#__codelineno-73-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="w">  </span>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>bind-utils
<a id="__codelineno-73-7" name="__codelineno-73-7"></a><a href="#__codelineno-73-7"><span class="linenos" data-linenos=" 7 "></span></a>
<a id="__codelineno-73-8" name="__codelineno-73-8"></a><a href="#__codelineno-73-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">  </span><span class="k">if</span><span class="w"> </span>which<span class="w"> </span>dig<span class="w"> </span><span class="p">&amp;</span>&gt;<span class="w"> </span>/dev/null<span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-73-9" name="__codelineno-73-9"></a><a href="#__codelineno-73-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;dig 命令已安装.&quot;</span>
<a id="__codelineno-73-10" name="__codelineno-73-10"></a><a href="#__codelineno-73-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">  </span><span class="k">else</span>
<a id="__codelineno-73-11" name="__codelineno-73-11"></a><a href="#__codelineno-73-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;dig安装失败，请查看yum配置或者网络.&quot;</span>
<a id="__codelineno-73-12" name="__codelineno-73-12"></a><a href="#__codelineno-73-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">  </span><span class="k">fi</span>
<a id="__codelineno-73-13" name="__codelineno-73-13"></a><a href="#__codelineno-73-13"><span class="linenos" data-linenos="13 "></span></a><span class="k">else</span>
<a id="__codelineno-73-14" name="__codelineno-73-14"></a><a href="#__codelineno-73-14"><span class="linenos" data-linenos="14 "></span></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;dig命令已安装&quot;</span>
<a id="__codelineno-73-15" name="__codelineno-73-15"></a><a href="#__codelineno-73-15"><span class="linenos" data-linenos="15 "></span></a>
<a id="__codelineno-73-16" name="__codelineno-73-16"></a><a href="#__codelineno-73-16"><span class="linenos" data-linenos="16 "></span></a><span class="k">fi</span>
<a id="__codelineno-73-17" name="__codelineno-73-17"></a><a href="#__codelineno-73-17"><span class="linenos" data-linenos="17 "></span></a>
<a id="__codelineno-73-18" name="__codelineno-73-18"></a><a href="#__codelineno-73-18"><span class="linenos" data-linenos="18 "></span></a>
<a id="__codelineno-73-19" name="__codelineno-73-19"></a><a href="#__codelineno-73-19"><span class="linenos" data-linenos="19 "></span></a><span class="nv">input_file</span><span class="o">=</span><span class="s2">&quot;domain_info.txt&quot;</span>
<a id="__codelineno-73-20" name="__codelineno-73-20"></a><a href="#__codelineno-73-20"><span class="linenos" data-linenos="20 "></span></a><span class="nv">output_file</span><span class="o">=</span><span class="s2">&quot;server_domain_ip&quot;</span>
<a id="__codelineno-73-21" name="__codelineno-73-21"></a><a href="#__codelineno-73-21"><span class="linenos" data-linenos="21 "></span></a>
<a id="__codelineno-73-22" name="__codelineno-73-22"></a><a href="#__codelineno-73-22"><span class="linenos" data-linenos="22 "></span></a><span class="nv">skip_domains</span><span class="o">=(</span><span class="s2">&quot;mail.sunline-i.com&quot;</span><span class="w"> </span><span class="s2">&quot;mail.sunline.cn&quot;</span><span class="o">)</span>
<a id="__codelineno-73-23" name="__codelineno-73-23"></a><a href="#__codelineno-73-23"><span class="linenos" data-linenos="23 "></span></a>
<a id="__codelineno-73-24" name="__codelineno-73-24"></a><a href="#__codelineno-73-24"><span class="linenos" data-linenos="24 "></span></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$input_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-73-25" name="__codelineno-73-25"></a><a href="#__codelineno-73-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;输入文件 </span><span class="nv">$input_file</span><span class="s2"> 不存在，请检查后再运行脚本。&quot;</span>
<a id="__codelineno-73-26" name="__codelineno-73-26"></a><a href="#__codelineno-73-26"><span class="linenos" data-linenos="26 "></span></a><span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-73-27" name="__codelineno-73-27"></a><a href="#__codelineno-73-27"><span class="linenos" data-linenos="27 "></span></a><span class="k">fi</span>
<a id="__codelineno-73-28" name="__codelineno-73-28"></a><a href="#__codelineno-73-28"><span class="linenos" data-linenos="28 "></span></a>
<a id="__codelineno-73-29" name="__codelineno-73-29"></a><a href="#__codelineno-73-29"><span class="linenos" data-linenos="29 "></span></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$output_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-73-30" name="__codelineno-73-30"></a><a href="#__codelineno-73-30"><span class="linenos" data-linenos="30 "></span></a><span class="w">    </span>touch<span class="w"> </span><span class="nv">$output_file</span>
<a id="__codelineno-73-31" name="__codelineno-73-31"></a><a href="#__codelineno-73-31"><span class="linenos" data-linenos="31 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;输出文件不存在，已创建 </span><span class="nv">$output_file</span><span class="s2"> 文件。&quot;</span>
<a id="__codelineno-73-32" name="__codelineno-73-32"></a><a href="#__codelineno-73-32"><span class="linenos" data-linenos="32 "></span></a><span class="k">else</span>
<a id="__codelineno-73-33" name="__codelineno-73-33"></a><a href="#__codelineno-73-33"><span class="linenos" data-linenos="33 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;输出文件已存在，程序开始写入数据。&quot;</span>
<a id="__codelineno-73-34" name="__codelineno-73-34"></a><a href="#__codelineno-73-34"><span class="linenos" data-linenos="34 "></span></a><span class="k">fi</span>
<a id="__codelineno-73-35" name="__codelineno-73-35"></a><a href="#__codelineno-73-35"><span class="linenos" data-linenos="35 "></span></a>
<a id="__codelineno-73-36" name="__codelineno-73-36"></a><a href="#__codelineno-73-36"><span class="linenos" data-linenos="36 "></span></a>&gt;<span class="w"> </span><span class="nv">$output_file</span>
<a id="__codelineno-73-37" name="__codelineno-73-37"></a><a href="#__codelineno-73-37"><span class="linenos" data-linenos="37 "></span></a>
<a id="__codelineno-73-38" name="__codelineno-73-38"></a><a href="#__codelineno-73-38"><span class="linenos" data-linenos="38 "></span></a><span class="k">while</span><span class="w"> </span><span class="nv">IFS</span><span class="o">=</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>line
<a id="__codelineno-73-39" name="__codelineno-73-39"></a><a href="#__codelineno-73-39"><span class="linenos" data-linenos="39 "></span></a><span class="k">do</span>
<a id="__codelineno-73-40" name="__codelineno-73-40"></a><a href="#__codelineno-73-40"><span class="linenos" data-linenos="40 "></span></a><span class="w">    </span><span class="c1"># 去除行首行尾的空白字符</span>
<a id="__codelineno-73-41" name="__codelineno-73-41"></a><a href="#__codelineno-73-41"><span class="linenos" data-linenos="41 "></span></a><span class="w">    </span><span class="nv">domain</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;[:space:]&#39;</span><span class="k">)</span>
<a id="__codelineno-73-42" name="__codelineno-73-42"></a><a href="#__codelineno-73-42"><span class="linenos" data-linenos="42 "></span></a>
<a id="__codelineno-73-43" name="__codelineno-73-43"></a><a href="#__codelineno-73-43"><span class="linenos" data-linenos="43 "></span></a><span class="w">    </span><span class="c1"># 检查当前域名是否在跳过列表中</span>
<a id="__codelineno-73-44" name="__codelineno-73-44"></a><a href="#__codelineno-73-44"><span class="linenos" data-linenos="44 "></span></a><span class="w">    </span><span class="nv">skip</span><span class="o">=</span><span class="nb">false</span>
<a id="__codelineno-73-45" name="__codelineno-73-45"></a><a href="#__codelineno-73-45"><span class="linenos" data-linenos="45 "></span></a><span class="w">    </span><span class="k">for</span><span class="w"> </span>skip_domain<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">skip_domains</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-73-46" name="__codelineno-73-46"></a><a href="#__codelineno-73-46"><span class="linenos" data-linenos="46 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$domain</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$skip_domain</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-73-47" name="__codelineno-73-47"></a><a href="#__codelineno-73-47"><span class="linenos" data-linenos="47 "></span></a><span class="w">            </span><span class="nv">skip</span><span class="o">=</span><span class="nb">true</span>
<a id="__codelineno-73-48" name="__codelineno-73-48"></a><a href="#__codelineno-73-48"><span class="linenos" data-linenos="48 "></span></a><span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;跳过域名：</span><span class="nv">$domain</span><span class="s2">&quot;</span>
<a id="__codelineno-73-49" name="__codelineno-73-49"></a><a href="#__codelineno-73-49"><span class="linenos" data-linenos="49 "></span></a><span class="w">            </span><span class="k">break</span>
<a id="__codelineno-73-50" name="__codelineno-73-50"></a><a href="#__codelineno-73-50"><span class="linenos" data-linenos="50 "></span></a><span class="w">        </span><span class="k">fi</span>
<a id="__codelineno-73-51" name="__codelineno-73-51"></a><a href="#__codelineno-73-51"><span class="linenos" data-linenos="51 "></span></a><span class="w">    </span><span class="k">done</span>
<a id="__codelineno-73-52" name="__codelineno-73-52"></a><a href="#__codelineno-73-52"><span class="linenos" data-linenos="52 "></span></a>
<a id="__codelineno-73-53" name="__codelineno-73-53"></a><a href="#__codelineno-73-53"><span class="linenos" data-linenos="53 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$skip</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-73-54" name="__codelineno-73-54"></a><a href="#__codelineno-73-54"><span class="linenos" data-linenos="54 "></span></a><span class="w">        </span><span class="k">continue</span>
<a id="__codelineno-73-55" name="__codelineno-73-55"></a><a href="#__codelineno-73-55"><span class="linenos" data-linenos="55 "></span></a><span class="w">    </span><span class="k">fi</span>
<a id="__codelineno-73-56" name="__codelineno-73-56"></a><a href="#__codelineno-73-56"><span class="linenos" data-linenos="56 "></span></a>
<a id="__codelineno-73-57" name="__codelineno-73-57"></a><a href="#__codelineno-73-57"><span class="linenos" data-linenos="57 "></span></a><span class="w">    </span><span class="c1"># 使用dig命令解析域名，提取IP地址</span>
<a id="__codelineno-73-58" name="__codelineno-73-58"></a><a href="#__codelineno-73-58"><span class="linenos" data-linenos="58 "></span></a><span class="w">    </span><span class="c1"># ip=$(dig +short $domain | head -n 1)</span>
<a id="__codelineno-73-59" name="__codelineno-73-59"></a><a href="#__codelineno-73-59"><span class="linenos" data-linenos="59 "></span></a>
<a id="__codelineno-73-60" name="__codelineno-73-60"></a><a href="#__codelineno-73-60"><span class="linenos" data-linenos="60 "></span></a><span class="w">    </span><span class="c1"># 使用nslookup命令解析域名，提取IP地址</span>
<a id="__codelineno-73-61" name="__codelineno-73-61"></a><a href="#__codelineno-73-61"><span class="linenos" data-linenos="61 "></span></a><span class="w">    </span><span class="nv">ip</span><span class="o">=</span><span class="k">$(</span>nslookup<span class="w"> </span><span class="nv">$domain</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;Address&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F<span class="s1">&#39;: &#39;</span><span class="w"> </span><span class="s1">&#39;NR==2 {print $2}&#39;</span><span class="k">)</span>
<a id="__codelineno-73-62" name="__codelineno-73-62"></a><a href="#__codelineno-73-62"><span class="linenos" data-linenos="62 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$domain</span><span class="s2">:</span><span class="nv">$ip</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$output_file</span>
<a id="__codelineno-73-63" name="__codelineno-73-63"></a><a href="#__codelineno-73-63"><span class="linenos" data-linenos="63 "></span></a><span class="k">done</span><span class="w"> </span>&lt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$input_file</span><span class="s2">&quot;</span>
<a id="__codelineno-73-64" name="__codelineno-73-64"></a><a href="#__codelineno-73-64"><span class="linenos" data-linenos="64 "></span></a>
<a id="__codelineno-73-65" name="__codelineno-73-65"></a><a href="#__codelineno-73-65"><span class="linenos" data-linenos="65 "></span></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;域名解析完成，结果已保存至</span><span class="nv">$output_file</span><span class="s2">。&quot;</span>
</code></pre></div>
<p><strong>脚本说明：</strong></p>
<ul>
<li><code>if ! which dig &amp;&gt; /dev/null; then</code>：检查<code>dig</code>命令是否存在，如果不存在则执行条件块内的代码。</li>
<li><code>skip_domains=( )</code>：定义一个数组，包含需要跳过解析的域名，数组内的域名以空格分开。</li>
<li><code>while IFS= read -r line; do ... done &lt; "$input_file"</code>：开始读取输入文件的每一行，并将每一行的内容存储在变量<code>line</code>中。</li>
<li><code>IFS=</code>：在 <code>while</code> 循环的前面，我们设置 <code>IFS</code> 为空字符串。这意味着 <code>read</code> 命令不会将读取的行拆分成多个字段，而是将整行内容读入变量 <code>line</code> 中。</li>
<li><code>read -r line</code>：<code>read</code> 命令读取文件的每一行，并将其存储在变量 <code>line</code> 中。<code>-r</code> 选项告诉 <code>read</code> 命令不要对反斜杠进行转义处理。</li>
<li><code>done &lt; "$input_file"</code>：通过重定向符号 <code>&lt;</code>，我们将 <code>example.txt</code> 文件的内容作为输入提供给 <code>while</code> 循环。</li>
<li><code>domain=$(echo "$line" | tr -d '[:space:]')</code>：去除变量 <code>line</code> 中的所有空白字符（包括空格、制表符和换行符），并将处理后的结果存储在变量 <code>domain</code> 中。</li>
<li><code>echo "$line"</code>：将变量 <code>line</code> 的内容输出到标准输出。</li>
<li><code>|</code>：管道符，将 <code>echo</code> 命令的输出作为 <code>tr</code> 命令的输入。</li>
<li><code>tr -d '[:space:]'</code>：<code>tr</code> 命令删除所有的空白字符。<code>tr</code> 是一个用于进行字符转换或删除的命令，<code>-d</code> 选项表示删除指定的字符集，这里使用了 POSIX 字符类 <code>[:space:]</code>，代表所有的空白字符。</li>
<li><code>domain=$(...)</code>：将管道命令的输出结果赋值给变量 <code>domain</code>。</li>
<li><code>${skip_domains[@]}</code>：表示引用整个数组，<code>@</code>符号确保数组中的每个元素被单独处理，而不是作为一个单一的字符串。</li>
<li><code>dig +short $domain | head -n 1</code>：使用<code>dig</code>命令解析域名，并提取第一个IP地址。</li>
<li><code>nslookup $domain | grep "Address" | awk -F': ' 'NR==2 {print $1}'</code>：使用<code>nslookup</code>命令解析域名，并查找包含<code>Address</code>文本内容的行，然后通过<code>awk</code>命令只处理第二行内容，使用分隔符<code>': '</code>（冒号后面还有个空格）来将第二步结果进行分割，最终提取到IP地址。</li>
</ul>
<h5 id="222-运行shell脚本">2.2.2 运行shell脚本<a class="headerlink" href="#222-运行shell脚本" title="Permanent link">&para;</a></h5>
<p>通过<code>sh</code>命令执行脚本<code>get_domain_ip.sh</code>，该脚本存放于<code>/usr/local/scripts/domain</code>目录下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-74-1" name="__codelineno-74-1"></a><a href="#__codelineno-74-1"><span class="linenos" data-linenos="1 "></span></a><span class="nb">cd</span><span class="w"> </span>/usr/local/scripts/domain
<a id="__codelineno-74-2" name="__codelineno-74-2"></a><a href="#__codelineno-74-2"><span class="linenos" data-linenos="2 "></span></a>sh<span class="w"> </span>get_domain_ip.sh
</code></pre></div>
<p>执行后的<code>server_domain_ip</code>文件内容如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-75-1" name="__codelineno-75-1"></a><a href="#__codelineno-75-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>domain<span class="o">]</span><span class="c1"># cat server_domain_ip</span>
<a id="__codelineno-75-2" name="__codelineno-75-2"></a><a href="#__codelineno-75-2"><span class="linenos" data-linenos=" 2 "></span></a>harbor.sh.sunline.cn:10.10.200.19
<a id="__codelineno-75-3" name="__codelineno-75-3"></a><a href="#__codelineno-75-3"><span class="linenos" data-linenos=" 3 "></span></a>iboss.sunline.cn:172.18.0.161
<a id="__codelineno-75-4" name="__codelineno-75-4"></a><a href="#__codelineno-75-4"><span class="linenos" data-linenos=" 4 "></span></a>wecom.iboss.sunline.cn:172.18.0.161
<a id="__codelineno-75-5" name="__codelineno-75-5"></a><a href="#__codelineno-75-5"><span class="linenos" data-linenos=" 5 "></span></a>yhtprdnew.clhd.sunline.cn:172.18.0.79
<a id="__codelineno-75-6" name="__codelineno-75-6"></a><a href="#__codelineno-75-6"><span class="linenos" data-linenos=" 6 "></span></a>password.its.sunline.cn:172.18.0.100
<a id="__codelineno-75-7" name="__codelineno-75-7"></a><a href="#__codelineno-75-7"><span class="linenos" data-linenos=" 7 "></span></a>jump.its.sunline.cn:10.22.50.249
<a id="__codelineno-75-8" name="__codelineno-75-8"></a><a href="#__codelineno-75-8"><span class="linenos" data-linenos=" 8 "></span></a>demo.its.sunline.cn:172.18.0.100
<a id="__codelineno-75-9" name="__codelineno-75-9"></a><a href="#__codelineno-75-9"><span class="linenos" data-linenos=" 9 "></span></a>proxy.its.sunline.cn:172.18.0.100
<a id="__codelineno-75-10" name="__codelineno-75-10"></a><a href="#__codelineno-75-10"><span class="linenos" data-linenos="10 "></span></a>onlyoffice.cloud.sunline.cn:10.22.50.221
<a id="__codelineno-75-11" name="__codelineno-75-11"></a><a href="#__codelineno-75-11"><span class="linenos" data-linenos="11 "></span></a>nx.cloud.sunline.cn:10.22.50.220
<a id="__codelineno-75-12" name="__codelineno-75-12"></a><a href="#__codelineno-75-12"><span class="linenos" data-linenos="12 "></span></a>yhtprd.clhd.sunline.cn:172.18.0.78
<a id="__codelineno-75-13" name="__codelineno-75-13"></a><a href="#__codelineno-75-13"><span class="linenos" data-linenos="13 "></span></a>yhtsit.clhd.sunline.cn:10.22.21.99
<a id="__codelineno-75-14" name="__codelineno-75-14"></a><a href="#__codelineno-75-14"><span class="linenos" data-linenos="14 "></span></a>test.erp.sunline.cn:10.22.50.135
<a id="__codelineno-75-15" name="__codelineno-75-15"></a><a href="#__codelineno-75-15"><span class="linenos" data-linenos="15 "></span></a>hr.iboss.sunline.cn:172.18.0.160
<a id="__codelineno-75-16" name="__codelineno-75-16"></a><a href="#__codelineno-75-16"><span class="linenos" data-linenos="16 "></span></a>test.boss.sunline.cn:10.22.50.129
<a id="__codelineno-75-17" name="__codelineno-75-17"></a><a href="#__codelineno-75-17"><span class="linenos" data-linenos="17 "></span></a>ers.sunline.cn:172.18.0.82
<a id="__codelineno-75-18" name="__codelineno-75-18"></a><a href="#__codelineno-75-18"><span class="linenos" data-linenos="18 "></span></a>boss.sunline.cn:172.18.0.8
<a id="__codelineno-75-19" name="__codelineno-75-19"></a><a href="#__codelineno-75-19"><span class="linenos" data-linenos="19 "></span></a>sunline-i.com:172.18.0.50
<a id="__codelineno-75-20" name="__codelineno-75-20"></a><a href="#__codelineno-75-20"><span class="linenos" data-linenos="20 "></span></a>sunline.cn:172.18.0.50
</code></pre></div>
<h3 id="3获取nginx配置">3.获取nginx配置<a class="headerlink" href="#3获取nginx配置" title="Permanent link">&para;</a></h3>
<h4 id="31-配置主机清单文件">3.1 配置主机清单文件<a class="headerlink" href="#31-配置主机清单文件" title="Permanent link">&para;</a></h4>
<p>将前面获取到的<code>server_ip</code>文件内的所有<code>ip</code>复制到<code>/data/ansible/hosts</code>主机清单文件中，命名为<code>domain_ip</code>组：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-76-1" name="__codelineno-76-1"></a><a href="#__codelineno-76-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>ansible<span class="o">]</span><span class="c1"># vim hosts</span>
<a id="__codelineno-76-2" name="__codelineno-76-2"></a><a href="#__codelineno-76-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="o">[</span>domain_ip<span class="o">]</span>
<a id="__codelineno-76-3" name="__codelineno-76-3"></a><a href="#__codelineno-76-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="m">10</span>.10.200.19
<a id="__codelineno-76-4" name="__codelineno-76-4"></a><a href="#__codelineno-76-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="m">172</span>.18.0.160
<a id="__codelineno-76-5" name="__codelineno-76-5"></a><a href="#__codelineno-76-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="m">172</span>.18.0.79
<a id="__codelineno-76-6" name="__codelineno-76-6"></a><a href="#__codelineno-76-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="m">172</span>.18.0.100
<a id="__codelineno-76-7" name="__codelineno-76-7"></a><a href="#__codelineno-76-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="m">10</span>.22.50.249
<a id="__codelineno-76-8" name="__codelineno-76-8"></a><a href="#__codelineno-76-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="m">10</span>.22.50.221
<a id="__codelineno-76-9" name="__codelineno-76-9"></a><a href="#__codelineno-76-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="m">10</span>.22.50.220
<a id="__codelineno-76-10" name="__codelineno-76-10"></a><a href="#__codelineno-76-10"><span class="linenos" data-linenos="10 "></span></a><span class="m">172</span>.18.0.78
<a id="__codelineno-76-11" name="__codelineno-76-11"></a><a href="#__codelineno-76-11"><span class="linenos" data-linenos="11 "></span></a><span class="m">10</span>.22.21.99
<a id="__codelineno-76-12" name="__codelineno-76-12"></a><a href="#__codelineno-76-12"><span class="linenos" data-linenos="12 "></span></a><span class="m">10</span>.22.50.135
<a id="__codelineno-76-13" name="__codelineno-76-13"></a><a href="#__codelineno-76-13"><span class="linenos" data-linenos="13 "></span></a><span class="m">172</span>.18.0.161
<a id="__codelineno-76-14" name="__codelineno-76-14"></a><a href="#__codelineno-76-14"><span class="linenos" data-linenos="14 "></span></a><span class="m">10</span>.22.50.129
<a id="__codelineno-76-15" name="__codelineno-76-15"></a><a href="#__codelineno-76-15"><span class="linenos" data-linenos="15 "></span></a><span class="m">172</span>.18.0.82
<a id="__codelineno-76-16" name="__codelineno-76-16"></a><a href="#__codelineno-76-16"><span class="linenos" data-linenos="16 "></span></a><span class="m">172</span>.18.0.50
</code></pre></div>
<p>由于我是在测试机<code>10.22.51.63</code>上执行ansible命令的，发现有一些服务器IP本身做了<code>iptables</code>规则，运行脚本前通过<code>ansible domain_ip -m shell -a 'ls -l'</code>命令发现有以下服务器IP无法远程：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-77-1" name="__codelineno-77-1"></a><a href="#__codelineno-77-1"><span class="linenos" data-linenos="1 "></span></a><span class="m">172</span>.18.0.160
<a id="__codelineno-77-2" name="__codelineno-77-2"></a><a href="#__codelineno-77-2"><span class="linenos" data-linenos="2 "></span></a><span class="m">172</span>.18.0.161
<a id="__codelineno-77-3" name="__codelineno-77-3"></a><a href="#__codelineno-77-3"><span class="linenos" data-linenos="3 "></span></a><span class="m">10</span>.22.50.220
<a id="__codelineno-77-4" name="__codelineno-77-4"></a><a href="#__codelineno-77-4"><span class="linenos" data-linenos="4 "></span></a><span class="m">10</span>.10.200.19
<a id="__codelineno-77-5" name="__codelineno-77-5"></a><a href="#__codelineno-77-5"><span class="linenos" data-linenos="5 "></span></a><span class="m">172</span>.18.0.82
<a id="__codelineno-77-6" name="__codelineno-77-6"></a><a href="#__codelineno-77-6"><span class="linenos" data-linenos="6 "></span></a><span class="m">10</span>.22.50.129
</code></pre></div>
<p>可以在服务器<code>10.22.50.249</code>上远程上面这些服务器，在<code>iptables</code>配置文件内添加如下规则临时增加权限，保存后重启iptables服务：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-78-1" name="__codelineno-78-1"></a><a href="#__codelineno-78-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>root@nextcloud-ctrix<span class="w"> </span>~<span class="o">]</span><span class="c1"># vim /etc/sysconfig/iptables</span>
<a id="__codelineno-78-2" name="__codelineno-78-2"></a><a href="#__codelineno-78-2"><span class="linenos" data-linenos="2 "></span></a>-A<span class="w"> </span>INPUT<span class="w"> </span>-s<span class="w"> </span><span class="m">10</span>.22.51.63/32<span class="w"> </span>-j<span class="w"> </span>ACCEPT
</code></pre></div>
<p>其中，<code>10.10.200.19</code>和<code>10.22.50.129</code>不知道root密码，所以没办法通过<code>ansible</code>命令去远程执行，因此可以在<code>/data/ansible/hosts</code>主机清单文件和<code>/usr/local/scripts/domain/server_ip</code>文件内删掉。</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-79-1" name="__codelineno-79-1"></a><a href="#__codelineno-79-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># vim /data/ansible/hosts</span>
<a id="__codelineno-79-2" name="__codelineno-79-2"></a><a href="#__codelineno-79-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="o">[</span>domain_ip<span class="o">]</span>
<a id="__codelineno-79-3" name="__codelineno-79-3"></a><a href="#__codelineno-79-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="m">172</span>.18.0.160
<a id="__codelineno-79-4" name="__codelineno-79-4"></a><a href="#__codelineno-79-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="m">172</span>.18.0.79
<a id="__codelineno-79-5" name="__codelineno-79-5"></a><a href="#__codelineno-79-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="m">172</span>.18.0.100
<a id="__codelineno-79-6" name="__codelineno-79-6"></a><a href="#__codelineno-79-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="m">10</span>.22.50.249
<a id="__codelineno-79-7" name="__codelineno-79-7"></a><a href="#__codelineno-79-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="m">10</span>.22.50.221
<a id="__codelineno-79-8" name="__codelineno-79-8"></a><a href="#__codelineno-79-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="m">10</span>.22.50.220
<a id="__codelineno-79-9" name="__codelineno-79-9"></a><a href="#__codelineno-79-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="m">172</span>.18.0.78
<a id="__codelineno-79-10" name="__codelineno-79-10"></a><a href="#__codelineno-79-10"><span class="linenos" data-linenos="10 "></span></a><span class="m">10</span>.22.21.99
<a id="__codelineno-79-11" name="__codelineno-79-11"></a><a href="#__codelineno-79-11"><span class="linenos" data-linenos="11 "></span></a><span class="m">10</span>.22.50.135
<a id="__codelineno-79-12" name="__codelineno-79-12"></a><a href="#__codelineno-79-12"><span class="linenos" data-linenos="12 "></span></a><span class="m">172</span>.18.0.161
<a id="__codelineno-79-13" name="__codelineno-79-13"></a><a href="#__codelineno-79-13"><span class="linenos" data-linenos="13 "></span></a><span class="m">172</span>.18.0.82
<a id="__codelineno-79-14" name="__codelineno-79-14"></a><a href="#__codelineno-79-14"><span class="linenos" data-linenos="14 "></span></a><span class="m">172</span>.18.0.50
<a id="__codelineno-79-15" name="__codelineno-79-15"></a><a href="#__codelineno-79-15"><span class="linenos" data-linenos="15 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># vim /usr/local/scripts/domain/server_ip</span>
<a id="__codelineno-79-16" name="__codelineno-79-16"></a><a href="#__codelineno-79-16"><span class="linenos" data-linenos="16 "></span></a><span class="m">172</span>.18.0.160
<a id="__codelineno-79-17" name="__codelineno-79-17"></a><a href="#__codelineno-79-17"><span class="linenos" data-linenos="17 "></span></a><span class="m">172</span>.18.0.79
<a id="__codelineno-79-18" name="__codelineno-79-18"></a><a href="#__codelineno-79-18"><span class="linenos" data-linenos="18 "></span></a><span class="m">172</span>.18.0.100
<a id="__codelineno-79-19" name="__codelineno-79-19"></a><a href="#__codelineno-79-19"><span class="linenos" data-linenos="19 "></span></a><span class="m">10</span>.22.50.249
<a id="__codelineno-79-20" name="__codelineno-79-20"></a><a href="#__codelineno-79-20"><span class="linenos" data-linenos="20 "></span></a><span class="m">10</span>.22.50.221
<a id="__codelineno-79-21" name="__codelineno-79-21"></a><a href="#__codelineno-79-21"><span class="linenos" data-linenos="21 "></span></a><span class="m">10</span>.22.50.220
<a id="__codelineno-79-22" name="__codelineno-79-22"></a><a href="#__codelineno-79-22"><span class="linenos" data-linenos="22 "></span></a><span class="m">172</span>.18.0.78
<a id="__codelineno-79-23" name="__codelineno-79-23"></a><a href="#__codelineno-79-23"><span class="linenos" data-linenos="23 "></span></a><span class="m">10</span>.22.21.99
<a id="__codelineno-79-24" name="__codelineno-79-24"></a><a href="#__codelineno-79-24"><span class="linenos" data-linenos="24 "></span></a><span class="m">10</span>.22.50.135
<a id="__codelineno-79-25" name="__codelineno-79-25"></a><a href="#__codelineno-79-25"><span class="linenos" data-linenos="25 "></span></a><span class="m">172</span>.18.0.161
<a id="__codelineno-79-26" name="__codelineno-79-26"></a><a href="#__codelineno-79-26"><span class="linenos" data-linenos="26 "></span></a><span class="m">172</span>.18.0.82
<a id="__codelineno-79-27" name="__codelineno-79-27"></a><a href="#__codelineno-79-27"><span class="linenos" data-linenos="27 "></span></a><span class="m">172</span>.18.0.50
</code></pre></div>
<p>添加完规则后，重新执行<code>ansible</code>命令进行测试：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-80-1" name="__codelineno-80-1"></a><a href="#__codelineno-80-1"><span class="linenos" data-linenos="1 "></span></a>ansible<span class="w"> </span>domain_ip<span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s1">&#39;ls -l&#39;</span>
</code></pre></div>
<h4 id="32-配置获取nginx配置和证书信息的脚本">3.2 配置获取nginx配置和证书信息的脚本<a class="headerlink" href="#32-配置获取nginx配置和证书信息的脚本" title="Permanent link">&para;</a></h4>
<h5 id="321-配置shell脚本">3.2.1 配置shell脚本<a class="headerlink" href="#321-配置shell脚本" title="Permanent link">&para;</a></h5>
<p>该Shell脚本文件的目的是去循环读取一个包含域名ip的输入文件<code>server_ip</code>，然后通过 Ansible 对指定服务器执行一系列操作，以获取和处理 Nginx 配置和证书信息，并存入到<code>/usr/local/scripts/nginx_configuration</code>目录下的输出文件内。</p>
<p>这里创建了一个shell脚本<code>extract_nginx_configuration.sh</code>，具体内容如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-81-1" name="__codelineno-81-1"></a><a href="#__codelineno-81-1"><span class="linenos" data-linenos="  1 "></span></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-81-2" name="__codelineno-81-2"></a><a href="#__codelineno-81-2"><span class="linenos" data-linenos="  2 "></span></a>
<a id="__codelineno-81-3" name="__codelineno-81-3"></a><a href="#__codelineno-81-3"><span class="linenos" data-linenos="  3 "></span></a><span class="c1">#/usr/local/scripts/domain/server_ip 定义一个服务器IP列表</span>
<a id="__codelineno-81-4" name="__codelineno-81-4"></a><a href="#__codelineno-81-4"><span class="linenos" data-linenos="  4 "></span></a><span class="nv">server_list</span><span class="o">=</span><span class="s2">&quot;/usr/local/scripts/domain/server_ip&quot;</span>
<a id="__codelineno-81-5" name="__codelineno-81-5"></a><a href="#__codelineno-81-5"><span class="linenos" data-linenos="  5 "></span></a>
<a id="__codelineno-81-6" name="__codelineno-81-6"></a><a href="#__codelineno-81-6"><span class="linenos" data-linenos="  6 "></span></a><span class="c1">#read -p &quot;输入服务器列表文件路径: &quot; server_list</span>
<a id="__codelineno-81-7" name="__codelineno-81-7"></a><a href="#__codelineno-81-7"><span class="linenos" data-linenos="  7 "></span></a>
<a id="__codelineno-81-8" name="__codelineno-81-8"></a><a href="#__codelineno-81-8"><span class="linenos" data-linenos="  8 "></span></a><span class="nv">output_dir</span><span class="o">=</span><span class="s2">&quot;/usr/local/scripts/nginx_configuration&quot;</span>
<a id="__codelineno-81-9" name="__codelineno-81-9"></a><a href="#__codelineno-81-9"><span class="linenos" data-linenos="  9 "></span></a>
<a id="__codelineno-81-10" name="__codelineno-81-10"></a><a href="#__codelineno-81-10"><span class="linenos" data-linenos=" 10 "></span></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-f<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$server_list</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-81-11" name="__codelineno-81-11"></a><a href="#__codelineno-81-11"><span class="linenos" data-linenos=" 11 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;输入文件 </span><span class="nv">$server_list</span><span class="s2"> 不存在，请检查后再运行脚本。&quot;</span>
<a id="__codelineno-81-12" name="__codelineno-81-12"></a><a href="#__codelineno-81-12"><span class="linenos" data-linenos=" 12 "></span></a><span class="w">    </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
<a id="__codelineno-81-13" name="__codelineno-81-13"></a><a href="#__codelineno-81-13"><span class="linenos" data-linenos=" 13 "></span></a><span class="k">fi</span>
<a id="__codelineno-81-14" name="__codelineno-81-14"></a><a href="#__codelineno-81-14"><span class="linenos" data-linenos=" 14 "></span></a>
<a id="__codelineno-81-15" name="__codelineno-81-15"></a><a href="#__codelineno-81-15"><span class="linenos" data-linenos=" 15 "></span></a><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$output_dir</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-81-16" name="__codelineno-81-16"></a><a href="#__codelineno-81-16"><span class="linenos" data-linenos=" 16 "></span></a><span class="w">    </span>mkdir<span class="w"> </span>-p<span class="w"> </span><span class="nv">$output_dir</span>
<a id="__codelineno-81-17" name="__codelineno-81-17"></a><a href="#__codelineno-81-17"><span class="linenos" data-linenos=" 17 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;输出目录不存在，已创建 </span><span class="nv">$output_dir</span><span class="s2"> 目录。\n&quot;</span>
<a id="__codelineno-81-18" name="__codelineno-81-18"></a><a href="#__codelineno-81-18"><span class="linenos" data-linenos=" 18 "></span></a><span class="k">else</span>
<a id="__codelineno-81-19" name="__codelineno-81-19"></a><a href="#__codelineno-81-19"><span class="linenos" data-linenos=" 19 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;输出目录已存在，程序开始写入数据。\n&quot;</span>
<a id="__codelineno-81-20" name="__codelineno-81-20"></a><a href="#__codelineno-81-20"><span class="linenos" data-linenos=" 20 "></span></a><span class="k">fi</span>
<a id="__codelineno-81-21" name="__codelineno-81-21"></a><a href="#__codelineno-81-21"><span class="linenos" data-linenos=" 21 "></span></a>
<a id="__codelineno-81-22" name="__codelineno-81-22"></a><a href="#__codelineno-81-22"><span class="linenos" data-linenos=" 22 "></span></a><span class="k">while</span><span class="w"> </span><span class="nv">IFS</span><span class="o">=</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>-r<span class="w"> </span>server_ip
<a id="__codelineno-81-23" name="__codelineno-81-23"></a><a href="#__codelineno-81-23"><span class="linenos" data-linenos=" 23 "></span></a><span class="k">do</span>
<a id="__codelineno-81-24" name="__codelineno-81-24"></a><a href="#__codelineno-81-24"><span class="linenos" data-linenos=" 24 "></span></a><span class="w">    </span><span class="nv">output_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">output_dir</span><span class="si">}</span><span class="s2">/ansible_</span><span class="si">${</span><span class="nv">server_ip</span><span class="si">}</span><span class="s2">_nginx.txt&quot;</span>
<a id="__codelineno-81-25" name="__codelineno-81-25"></a><a href="#__codelineno-81-25"><span class="linenos" data-linenos=" 25 "></span></a><span class="w">    </span><span class="o">{</span>
<a id="__codelineno-81-26" name="__codelineno-81-26"></a><a href="#__codelineno-81-26"><span class="linenos" data-linenos=" 26 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;处理服务器: </span><span class="nv">$server_ip</span><span class="s2">&quot;</span>
<a id="__codelineno-81-27" name="__codelineno-81-27"></a><a href="#__codelineno-81-27"><span class="linenos" data-linenos=" 27 "></span></a>
<a id="__codelineno-81-28" name="__codelineno-81-28"></a><a href="#__codelineno-81-28"><span class="linenos" data-linenos=" 28 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n\n###### &lt;1&gt; 检查 nginx 路径&quot;</span>
<a id="__codelineno-81-29" name="__codelineno-81-29"></a><a href="#__codelineno-81-29"><span class="linenos" data-linenos=" 29 "></span></a>
<a id="__codelineno-81-30" name="__codelineno-81-30"></a><a href="#__codelineno-81-30"><span class="linenos" data-linenos=" 30 "></span></a><span class="w">        </span><span class="nv">nginx_path</span><span class="o">=</span><span class="k">$(</span>ansible<span class="w"> </span><span class="nv">$server_ip</span><span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;which nginx&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;/nginx&#39;</span><span class="k">)</span>
<a id="__codelineno-81-31" name="__codelineno-81-31"></a><a href="#__codelineno-81-31"><span class="linenos" data-linenos=" 31 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$nginx_path</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-81-32" name="__codelineno-81-32"></a><a href="#__codelineno-81-32"><span class="linenos" data-linenos=" 32 "></span></a><span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;未找到 Nginx 路径，说明该服务器未安装 Nginx。&quot;</span>
<a id="__codelineno-81-33" name="__codelineno-81-33"></a><a href="#__codelineno-81-33"><span class="linenos" data-linenos=" 33 "></span></a><span class="w">        </span><span class="k">else</span>
<a id="__codelineno-81-34" name="__codelineno-81-34"></a><a href="#__codelineno-81-34"><span class="linenos" data-linenos=" 34 "></span></a><span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Nginx 路径: </span><span class="nv">$nginx_path</span><span class="s2">&quot;</span>
<a id="__codelineno-81-35" name="__codelineno-81-35"></a><a href="#__codelineno-81-35"><span class="linenos" data-linenos=" 35 "></span></a>
<a id="__codelineno-81-36" name="__codelineno-81-36"></a><a href="#__codelineno-81-36"><span class="linenos" data-linenos=" 36 "></span></a><span class="w">            </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n\n\n###### &lt;2&gt; 查看 nginx 配置文件所在路径&quot;</span>
<a id="__codelineno-81-37" name="__codelineno-81-37"></a><a href="#__codelineno-81-37"><span class="linenos" data-linenos=" 37 "></span></a>
<a id="__codelineno-81-38" name="__codelineno-81-38"></a><a href="#__codelineno-81-38"><span class="linenos" data-linenos=" 38 "></span></a><span class="w">            </span><span class="nv">nginx_config_output</span><span class="o">=</span><span class="k">$(</span>ansible<span class="w"> </span><span class="nv">$server_ip</span><span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$nginx_path</span><span class="s2"> -V&quot;</span><span class="w"> </span><span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s1">&#39;prefix=&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-oP<span class="w"> </span><span class="s1">&#39;prefix=\K[^ ]*&#39;</span><span class="k">)</span>
<a id="__codelineno-81-39" name="__codelineno-81-39"></a><a href="#__codelineno-81-39"><span class="linenos" data-linenos=" 39 "></span></a><span class="w">            </span><span class="nv">nginx_config_output</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">nginx_config_output</span><span class="p">%/</span><span class="si">}</span><span class="s2">&quot;</span>/conf<span class="w">  </span><span class="c1"># 添加 /conf 以修正路径</span>
<a id="__codelineno-81-40" name="__codelineno-81-40"></a><a href="#__codelineno-81-40"><span class="linenos" data-linenos=" 40 "></span></a><span class="w">            </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Nginx 配置路径: </span><span class="nv">$nginx_config_output</span><span class="s2">&quot;</span>
<a id="__codelineno-81-41" name="__codelineno-81-41"></a><a href="#__codelineno-81-41"><span class="linenos" data-linenos=" 41 "></span></a>
<a id="__codelineno-81-42" name="__codelineno-81-42"></a><a href="#__codelineno-81-42"><span class="linenos" data-linenos=" 42 "></span></a><span class="w">            </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n\n\n###### &lt;3&gt; 查看 nginx 配置文件内容&quot;</span>
<a id="__codelineno-81-43" name="__codelineno-81-43"></a><a href="#__codelineno-81-43"><span class="linenos" data-linenos=" 43 "></span></a>
<a id="__codelineno-81-44" name="__codelineno-81-44"></a><a href="#__codelineno-81-44"><span class="linenos" data-linenos=" 44 "></span></a><span class="w">            </span><span class="nv">nginx_conf_file</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">nginx_config_output</span><span class="si">}</span><span class="s2">/nginx.conf&quot;</span>
<a id="__codelineno-81-45" name="__codelineno-81-45"></a><a href="#__codelineno-81-45"><span class="linenos" data-linenos=" 45 "></span></a><span class="w">            </span>ansible<span class="w"> </span><span class="nv">$server_ip</span><span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;cat </span><span class="nv">$nginx_conf_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">&#39;CHANGED | rc=0&#39;</span>
<a id="__codelineno-81-46" name="__codelineno-81-46"></a><a href="#__codelineno-81-46"><span class="linenos" data-linenos=" 46 "></span></a><span class="w">            </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n包含的配置文件:&quot;</span>
<a id="__codelineno-81-47" name="__codelineno-81-47"></a><a href="#__codelineno-81-47"><span class="linenos" data-linenos=" 47 "></span></a>
<a id="__codelineno-81-48" name="__codelineno-81-48"></a><a href="#__codelineno-81-48"><span class="linenos" data-linenos=" 48 "></span></a><span class="w">            </span><span class="nv">conf_files</span><span class="o">=</span><span class="k">$(</span>ansible<span class="w"> </span><span class="nv">$server_ip</span><span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;grep &#39;include&#39; </span><span class="nv">$nginx_conf_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">&#39;#&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-oP<span class="w"> </span><span class="s1">&#39;(conf.d|vhost)&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="k">)</span>
<a id="__codelineno-81-49" name="__codelineno-81-49"></a><a href="#__codelineno-81-49"><span class="linenos" data-linenos=" 49 "></span></a><span class="w">            </span><span class="nv">confd_conf_files</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<a id="__codelineno-81-50" name="__codelineno-81-50"></a><a href="#__codelineno-81-50"><span class="linenos" data-linenos=" 50 "></span></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$conf_files</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-81-51" name="__codelineno-81-51"></a><a href="#__codelineno-81-51"><span class="linenos" data-linenos=" 51 "></span></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;无&quot;</span>
<a id="__codelineno-81-52" name="__codelineno-81-52"></a><a href="#__codelineno-81-52"><span class="linenos" data-linenos=" 52 "></span></a><span class="w">            </span><span class="k">else</span>
<a id="__codelineno-81-53" name="__codelineno-81-53"></a><a href="#__codelineno-81-53"><span class="linenos" data-linenos=" 53 "></span></a><span class="w">                </span><span class="nv">confd_conf_files</span><span class="o">=</span><span class="k">$(</span>ansible<span class="w"> </span><span class="nv">$server_ip</span><span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;ls </span><span class="nv">$nginx_config_output</span><span class="s2">/</span><span class="nv">$conf_files</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-oP<span class="w"> </span><span class="s1">&#39;.*conf$&#39;</span><span class="k">)</span>
<a id="__codelineno-81-54" name="__codelineno-81-54"></a><a href="#__codelineno-81-54"><span class="linenos" data-linenos=" 54 "></span></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$confd_conf_files</span><span class="s2">&quot;</span>
<a id="__codelineno-81-55" name="__codelineno-81-55"></a><a href="#__codelineno-81-55"><span class="linenos" data-linenos=" 55 "></span></a><span class="w">            </span><span class="k">fi</span>
<a id="__codelineno-81-56" name="__codelineno-81-56"></a><a href="#__codelineno-81-56"><span class="linenos" data-linenos=" 56 "></span></a>
<a id="__codelineno-81-57" name="__codelineno-81-57"></a><a href="#__codelineno-81-57"><span class="linenos" data-linenos=" 57 "></span></a><span class="w">            </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n\n\n###### &lt;4&gt; 提取的证书路径&quot;</span>
<a id="__codelineno-81-58" name="__codelineno-81-58"></a><a href="#__codelineno-81-58"><span class="linenos" data-linenos=" 58 "></span></a>
<a id="__codelineno-81-59" name="__codelineno-81-59"></a><a href="#__codelineno-81-59"><span class="linenos" data-linenos=" 59 "></span></a><span class="w">            </span><span class="nv">cert_files</span><span class="o">=</span><span class="k">$(</span>ansible<span class="w"> </span><span class="nv">$server_ip</span><span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;grep -v &#39;#&#39; </span><span class="nv">$nginx_conf_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-oP<span class="w"> </span><span class="s1">&#39;ssl_certificate(_key)?\s+\K[^;]*&#39;</span><span class="k">)</span>
<a id="__codelineno-81-60" name="__codelineno-81-60"></a><a href="#__codelineno-81-60"><span class="linenos" data-linenos=" 60 "></span></a><span class="w">            </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;从nginx.conf提取的证书路径:&quot;</span>
<a id="__codelineno-81-61" name="__codelineno-81-61"></a><a href="#__codelineno-81-61"><span class="linenos" data-linenos=" 61 "></span></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$cert_files</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-81-62" name="__codelineno-81-62"></a><a href="#__codelineno-81-62"><span class="linenos" data-linenos=" 62 "></span></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;无\n&quot;</span>
<a id="__codelineno-81-63" name="__codelineno-81-63"></a><a href="#__codelineno-81-63"><span class="linenos" data-linenos=" 63 "></span></a><span class="w">            </span><span class="k">else</span>
<a id="__codelineno-81-64" name="__codelineno-81-64"></a><a href="#__codelineno-81-64"><span class="linenos" data-linenos=" 64 "></span></a><span class="w">                </span><span class="nv">cert_files_array</span><span class="o">=(</span><span class="nv">$cert_files</span><span class="o">)</span><span class="w">   </span><span class="c1"># 转换为数组</span>
<a id="__codelineno-81-65" name="__codelineno-81-65"></a><a href="#__codelineno-81-65"><span class="linenos" data-linenos=" 65 "></span></a><span class="w">                </span><span class="nv">cert_paths</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<a id="__codelineno-81-66" name="__codelineno-81-66"></a><a href="#__codelineno-81-66"><span class="linenos" data-linenos=" 66 "></span></a><span class="w">                </span><span class="k">for</span><span class="w"> </span>cert_file<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">cert_files_array</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-81-67" name="__codelineno-81-67"></a><a href="#__codelineno-81-67"><span class="linenos" data-linenos=" 67 "></span></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="o">[[</span><span class="w">  </span><span class="s2">&quot;</span><span class="nv">$cert_file</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span><span class="s2">&quot;none&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-81-68" name="__codelineno-81-68"></a><a href="#__codelineno-81-68"><span class="linenos" data-linenos=" 68 "></span></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="si">${</span><span class="nv">cert_file</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-81-69" name="__codelineno-81-69"></a><a href="#__codelineno-81-69"><span class="linenos" data-linenos=" 69 "></span></a><span class="w">                            </span><span class="nv">cert_paths</span><span class="o">+=</span><span class="s2">&quot;</span><span class="nv">$nginx_config_output</span><span class="s2">/</span><span class="nv">$cert_file</span><span class="s2">&quot;</span>
<a id="__codelineno-81-70" name="__codelineno-81-70"></a><a href="#__codelineno-81-70"><span class="linenos" data-linenos=" 70 "></span></a><span class="w">                        </span><span class="k">else</span>
<a id="__codelineno-81-71" name="__codelineno-81-71"></a><a href="#__codelineno-81-71"><span class="linenos" data-linenos=" 71 "></span></a><span class="w">                            </span><span class="nv">cert_paths</span><span class="o">+=</span><span class="s2">&quot;</span><span class="nv">$cert_file</span><span class="s2">&quot;</span>
<a id="__codelineno-81-72" name="__codelineno-81-72"></a><a href="#__codelineno-81-72"><span class="linenos" data-linenos=" 72 "></span></a><span class="w">                        </span><span class="k">fi</span>
<a id="__codelineno-81-73" name="__codelineno-81-73"></a><a href="#__codelineno-81-73"><span class="linenos" data-linenos=" 73 "></span></a><span class="w">                        </span><span class="nv">cert_paths</span><span class="o">+=</span><span class="s1">$&#39;\n&#39;</span><span class="w">   </span><span class="c1"># 添加换行符作为分隔符</span>
<a id="__codelineno-81-74" name="__codelineno-81-74"></a><a href="#__codelineno-81-74"><span class="linenos" data-linenos=" 74 "></span></a><span class="w">                    </span><span class="k">fi</span>
<a id="__codelineno-81-75" name="__codelineno-81-75"></a><a href="#__codelineno-81-75"><span class="linenos" data-linenos=" 75 "></span></a><span class="w">                </span><span class="k">done</span>
<a id="__codelineno-81-76" name="__codelineno-81-76"></a><a href="#__codelineno-81-76"><span class="linenos" data-linenos=" 76 "></span></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$cert_paths</span><span class="s2">&quot;</span>
<a id="__codelineno-81-77" name="__codelineno-81-77"></a><a href="#__codelineno-81-77"><span class="linenos" data-linenos=" 77 "></span></a><span class="w">            </span><span class="k">fi</span>
<a id="__codelineno-81-78" name="__codelineno-81-78"></a><a href="#__codelineno-81-78"><span class="linenos" data-linenos=" 78 "></span></a>
<a id="__codelineno-81-79" name="__codelineno-81-79"></a><a href="#__codelineno-81-79"><span class="linenos" data-linenos=" 79 "></span></a><span class="w">            </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;从非nginx.conf提取的证书路径:&quot;</span>
<a id="__codelineno-81-80" name="__codelineno-81-80"></a><a href="#__codelineno-81-80"><span class="linenos" data-linenos=" 80 "></span></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$confd_conf_files</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-81-81" name="__codelineno-81-81"></a><a href="#__codelineno-81-81"><span class="linenos" data-linenos=" 81 "></span></a><span class="w">                </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;无\n&quot;</span>
<a id="__codelineno-81-82" name="__codelineno-81-82"></a><a href="#__codelineno-81-82"><span class="linenos" data-linenos=" 82 "></span></a><span class="w">            </span><span class="k">else</span>
<a id="__codelineno-81-83" name="__codelineno-81-83"></a><a href="#__codelineno-81-83"><span class="linenos" data-linenos=" 83 "></span></a><span class="w">                </span><span class="nv">cert_files2</span><span class="o">=</span><span class="k">$(</span>ansible<span class="w"> </span><span class="nv">$server_ip</span><span class="w"> </span>-m<span class="w"> </span>shell<span class="w"> </span>-a<span class="w"> </span><span class="s2">&quot;cd </span><span class="nv">$nginx_config_output</span><span class="s2">/</span><span class="nv">$conf_files</span><span class="s2"> &amp;&amp; echo &#39;</span><span class="nv">$confd_conf_files</span><span class="s2">&#39; | xargs cat&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s1">&#39;#&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-oP<span class="w"> </span><span class="s1">&#39;ssl_certificate(_key)?\s+\K[^;]*&#39;</span><span class="k">)</span>
<a id="__codelineno-81-84" name="__codelineno-81-84"></a><a href="#__codelineno-81-84"><span class="linenos" data-linenos=" 84 "></span></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$cert_files2</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-81-85" name="__codelineno-81-85"></a><a href="#__codelineno-81-85"><span class="linenos" data-linenos=" 85 "></span></a><span class="w">                    </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;无\n&quot;</span>
<a id="__codelineno-81-86" name="__codelineno-81-86"></a><a href="#__codelineno-81-86"><span class="linenos" data-linenos=" 86 "></span></a><span class="w">                </span><span class="k">else</span>
<a id="__codelineno-81-87" name="__codelineno-81-87"></a><a href="#__codelineno-81-87"><span class="linenos" data-linenos=" 87 "></span></a><span class="w">                    </span><span class="nv">cert_files_array2</span><span class="o">=(</span><span class="nv">$cert_files2</span><span class="o">)</span><span class="w">   </span><span class="c1"># 转换为数组</span>
<a id="__codelineno-81-88" name="__codelineno-81-88"></a><a href="#__codelineno-81-88"><span class="linenos" data-linenos=" 88 "></span></a><span class="w">                    </span><span class="nv">cert_paths2</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<a id="__codelineno-81-89" name="__codelineno-81-89"></a><a href="#__codelineno-81-89"><span class="linenos" data-linenos=" 89 "></span></a><span class="w">                    </span><span class="k">for</span><span class="w"> </span>cert_file2<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">cert_files_array2</span><span class="p">[@]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
<a id="__codelineno-81-90" name="__codelineno-81-90"></a><a href="#__codelineno-81-90"><span class="linenos" data-linenos=" 90 "></span></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span>!<span class="w"> </span><span class="o">[[</span><span class="w">  </span><span class="s2">&quot;</span><span class="nv">$cert_file2</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">=</span>~<span class="w"> </span><span class="s2">&quot;none&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-81-91" name="__codelineno-81-91"></a><a href="#__codelineno-81-91"><span class="linenos" data-linenos=" 91 "></span></a><span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="si">${</span><span class="nv">cert_file2</span><span class="p">:</span><span class="nv">0</span><span class="p">:</span><span class="nv">1</span><span class="si">}</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-81-92" name="__codelineno-81-92"></a><a href="#__codelineno-81-92"><span class="linenos" data-linenos=" 92 "></span></a><span class="w">                                </span><span class="nv">cert_paths2</span><span class="o">+=</span><span class="s2">&quot;</span><span class="nv">$nginx_config_output</span><span class="s2">/</span><span class="nv">$cert_file2</span><span class="s2">&quot;</span>
<a id="__codelineno-81-93" name="__codelineno-81-93"></a><a href="#__codelineno-81-93"><span class="linenos" data-linenos=" 93 "></span></a><span class="w">                            </span><span class="k">else</span>
<a id="__codelineno-81-94" name="__codelineno-81-94"></a><a href="#__codelineno-81-94"><span class="linenos" data-linenos=" 94 "></span></a><span class="w">                                </span><span class="nv">cert_paths2</span><span class="o">+=</span><span class="s2">&quot;</span><span class="nv">$cert_file2</span><span class="s2">&quot;</span>
<a id="__codelineno-81-95" name="__codelineno-81-95"></a><a href="#__codelineno-81-95"><span class="linenos" data-linenos=" 95 "></span></a><span class="w">                            </span><span class="k">fi</span>
<a id="__codelineno-81-96" name="__codelineno-81-96"></a><a href="#__codelineno-81-96"><span class="linenos" data-linenos=" 96 "></span></a><span class="w">                            </span><span class="nv">cert_paths2</span><span class="o">+=</span><span class="s1">$&#39;\n&#39;</span><span class="w">   </span><span class="c1"># 添加换行符作为分隔符</span>
<a id="__codelineno-81-97" name="__codelineno-81-97"></a><a href="#__codelineno-81-97"><span class="linenos" data-linenos=" 97 "></span></a><span class="w">                        </span><span class="k">fi</span>
<a id="__codelineno-81-98" name="__codelineno-81-98"></a><a href="#__codelineno-81-98"><span class="linenos" data-linenos=" 98 "></span></a><span class="w">                    </span><span class="k">done</span>
<a id="__codelineno-81-99" name="__codelineno-81-99"></a><a href="#__codelineno-81-99"><span class="linenos" data-linenos=" 99 "></span></a><span class="w">                    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$cert_paths2</span><span class="s2">&quot;</span>
<a id="__codelineno-81-100" name="__codelineno-81-100"></a><a href="#__codelineno-81-100"><span class="linenos" data-linenos="100 "></span></a><span class="w">                </span><span class="k">fi</span>
<a id="__codelineno-81-101" name="__codelineno-81-101"></a><a href="#__codelineno-81-101"><span class="linenos" data-linenos="101 "></span></a><span class="w">            </span><span class="k">fi</span>
<a id="__codelineno-81-102" name="__codelineno-81-102"></a><a href="#__codelineno-81-102"><span class="linenos" data-linenos="102 "></span></a><span class="w">        </span><span class="k">fi</span>
<a id="__codelineno-81-103" name="__codelineno-81-103"></a><a href="#__codelineno-81-103"><span class="linenos" data-linenos="103 "></span></a><span class="w">    </span><span class="o">}</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$output_file</span>
<a id="__codelineno-81-104" name="__codelineno-81-104"></a><a href="#__codelineno-81-104"><span class="linenos" data-linenos="104 "></span></a>
<a id="__codelineno-81-105" name="__codelineno-81-105"></a><a href="#__codelineno-81-105"><span class="linenos" data-linenos="105 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;服务器 </span><span class="nv">$server_ip</span><span class="s2"> 的结果已保存到 </span><span class="si">${</span><span class="nv">output_file</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-81-106" name="__codelineno-81-106"></a><a href="#__codelineno-81-106"><span class="linenos" data-linenos="106 "></span></a><span class="k">done</span><span class="w"> </span>&lt;<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$server_list</span><span class="s2">&quot;</span>
<a id="__codelineno-81-107" name="__codelineno-81-107"></a><a href="#__codelineno-81-107"><span class="linenos" data-linenos="107 "></span></a>
<a id="__codelineno-81-108" name="__codelineno-81-108"></a><a href="#__codelineno-81-108"><span class="linenos" data-linenos="108 "></span></a><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;\n所有服务器执行完毕！&quot;</span>
</code></pre></div>
<p><strong>脚本说明：</strong></p>
<h6 id="3211-检查-nginx-路径">3.2.1.1 检查 nginx 路径<a class="headerlink" href="#3211-检查-nginx-路径" title="Permanent link">&para;</a></h6>
<ul>
<li>
<p><code>! -f "$server_list"</code>：检查文件是否不存在。</p>
</li>
<li>
<p><code>-d "$output_dir"</code>：检查目录是否存在。</p>
</li>
<li>
<p><code>search_dirs=( )</code>：定义一个数组 <code>search_dirs</code>，包含多个目录路径，用于在系统中搜索证书文件。</p>
</li>
<li>
<p><code>while IFS= read -r server_ip</code>：使用 <code>while</code> 循环逐行读取服务器列表文件，每行存储在变量 <code>server_ip</code> 中。</p>
</li>
<li>
<p><code>{ ...... } &gt; $output_file</code>：使用花括号 <code>{}</code> 包含所有命令，确保所有输出重定向到 <code>output_file</code>。</p>
</li>
<li>
<p><code>"which nginx" | grep '/nginx'</code>：</p>
</li>
<li>
<p><code>which nginx</code>：这个命令用于查找 <code>nginx</code> 可执行文件的位置，并输出其路径。</p>
</li>
<li><code>| grep '/nginx'</code>：通过管道将 <code>which nginx</code> 的输出传递给 <code>grep</code> 命令，并查找包含“/nginx&rdquo;内容的行。</li>
</ul>
<p><strong>存在nginx，以<code>172.18.0.160</code>为例：</strong></p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-82-1" name="__codelineno-82-1"></a><a href="#__codelineno-82-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.160 -m shell -a &#39;which nginx&#39;</span>
<a id="__codelineno-82-2" name="__codelineno-82-2"></a><a href="#__codelineno-82-2"><span class="linenos" data-linenos="2 "></span></a><span class="m">172</span>.18.0.160<span class="w"> </span><span class="p">|</span><span class="w"> </span>CHANGED<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">rc</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>&gt;&gt;
<a id="__codelineno-82-3" name="__codelineno-82-3"></a><a href="#__codelineno-82-3"><span class="linenos" data-linenos="3 "></span></a>/bin/nginx
<a id="__codelineno-82-4" name="__codelineno-82-4"></a><a href="#__codelineno-82-4"><span class="linenos" data-linenos="4 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>nginx_configuration<span class="o">]</span><span class="c1"># ansible 172.18.0.160 -m shell -a &#39;which nginx&#39; | grep &#39;/nginx&#39;</span>
<a id="__codelineno-82-5" name="__codelineno-82-5"></a><a href="#__codelineno-82-5"><span class="linenos" data-linenos="5 "></span></a>/bin/nginx
</code></pre></div>
<p><strong>不存在nginx，以<code>10.22.50.249</code>为例：</strong></p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-83-1" name="__codelineno-83-1"></a><a href="#__codelineno-83-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 10.22.50.249 -m shell -a &#39;which nginx&#39;</span>
<a id="__codelineno-83-2" name="__codelineno-83-2"></a><a href="#__codelineno-83-2"><span class="linenos" data-linenos="2 "></span></a><span class="m">10</span>.22.50.249<span class="w"> </span><span class="p">|</span><span class="w"> </span>FAILED<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">rc</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>&gt;&gt;
<a id="__codelineno-83-3" name="__codelineno-83-3"></a><a href="#__codelineno-83-3"><span class="linenos" data-linenos="3 "></span></a>which:<span class="w"> </span>no<span class="w"> </span>nginx<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">(</span>/sbin:/bin:/usr/sbin:/usr/bin<span class="o">)</span>non-zero<span class="w"> </span><span class="k">return</span><span class="w"> </span>code
<a id="__codelineno-83-4" name="__codelineno-83-4"></a><a href="#__codelineno-83-4"><span class="linenos" data-linenos="4 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>nginx_configuration<span class="o">]</span><span class="c1"># ansible 10.22.50.249 -m shell -a &#39;which nginx&#39; | grep &#39;/nginx&#39;</span>
<a id="__codelineno-83-5" name="__codelineno-83-5"></a><a href="#__codelineno-83-5"><span class="linenos" data-linenos="5 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>nginx_configuration<span class="o">]</span><span class="c1"># </span>
</code></pre></div>
<h6 id="3212-查看-nginx-配置文件所在路径">3.2.1.2 查看 nginx 配置文件所在路径<a class="headerlink" href="#3212-查看-nginx-配置文件所在路径" title="Permanent link">&para;</a></h6>
<ul>
<li>
<p><code>echo -e</code>：用于打印带有转义字符的字符串，使用 <code>-e</code> 选项时，<code>echo</code> 会解释转义字符，例如 <code>\n</code> 表示换行，<code>\t</code> 表示制表符等。</p>
</li>
<li>
<p><code>"$nginx_path -V" 2&gt;&amp;1 | grep 'prefix=' | grep -oP 'prefix=\K[^ ]*'</code>：从nginx的版本信息中提取nginx的安装路径。</p>
</li>
<li>
<p><code>$nginx_path -V</code>：执行nginx的路径变量（<code>$nginx_path</code>）加上<code>-V</code>参数，通常用于显示nginx的版本信息及编译时的相关配置。</p>
</li>
<li>
<p><code>2&gt;&amp;1</code>：将标准错误（stderr）合并到标准输出（stdout）。这样，错误信息也会被传递到管道中，确保所有输出都被处理。</p>
</li>
<li>
<p><code>grep 'prefix='</code>：从合并后的输出中筛选包含<code>prefix=</code>的行。<code>prefix</code>是nginx编译时设置的安装目录。</p>
</li>
<li>
<p><code>grep -oP 'prefix=\K[^ ]*'</code>：</p>
<ul>
<li><code>grep -oP</code>: <code>-P</code>表示使用 Perl 正则表达式（PCRE），<code>-o</code> 表示只输出匹配部分。</li>
<li><code>'prefix=\K[^ ]*'</code> ：这是一个要匹配的正则表达式。</li>
<li><code>prefix=</code>：直接匹配字符串 <code>prefix=</code>，这部分用于寻找包含 <code>prefix=</code> 的文本行。</li>
<li><code>\K</code>：重置匹配的开始位置，忽略 <code>prefix=</code> 。</li>
<li><code>[^;]*</code> 从当前位置开始，匹配任何字符，但不包括空格，即直到遇到空格。</li>
</ul>
<p><strong>如果不想对圆括号进行转义，在 <code>sed</code> 中可以使用 <code>-E</code>或<code>-r</code> 选项，来使用扩展正则表达式，这样可以直接使用圆括号。</strong></p>
<ul>
<li><code>.*</code>：匹配捕获组之后的任意字符（除了换行符）。</li>
<li><code>/\1/</code>：将匹配的内容替换为第一个捕获组的内容，这里最后面没有使用全局标志 <code>g</code> 的原因是这个命令只需要在每一行中进行一次替换操作。</li>
</ul>
</li>
</ul>
<p><strong>存在nginx，以<code>172.18.0.160</code>为例：</strong></p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-84-1" name="__codelineno-84-1"></a><a href="#__codelineno-84-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.160 -m shell -a &quot;/bin/nginx -V&quot; 2&gt;&amp;1</span>
<a id="__codelineno-84-2" name="__codelineno-84-2"></a><a href="#__codelineno-84-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="m">172</span>.18.0.160<span class="w"> </span><span class="p">|</span><span class="w"> </span>CHANGED<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">rc</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>&gt;&gt;
<a id="__codelineno-84-3" name="__codelineno-84-3"></a><a href="#__codelineno-84-3"><span class="linenos" data-linenos=" 3 "></span></a>nginx<span class="w"> </span>version:<span class="w"> </span>nginx/1.25.1
<a id="__codelineno-84-4" name="__codelineno-84-4"></a><a href="#__codelineno-84-4"><span class="linenos" data-linenos=" 4 "></span></a>built<span class="w"> </span>by<span class="w"> </span>gcc<span class="w"> </span><span class="m">4</span>.8.5<span class="w"> </span><span class="m">20150623</span><span class="w"> </span><span class="o">(</span>Red<span class="w"> </span>Hat<span class="w"> </span><span class="m">4</span>.8.5-44<span class="o">)</span><span class="w"> </span><span class="o">(</span>GCC<span class="o">)</span><span class="w"> </span>
<a id="__codelineno-84-5" name="__codelineno-84-5"></a><a href="#__codelineno-84-5"><span class="linenos" data-linenos=" 5 "></span></a>built<span class="w"> </span>with<span class="w"> </span>OpenSSL<span class="w"> </span><span class="m">1</span>.0.2k-fips<span class="w">  </span><span class="m">26</span><span class="w"> </span>Jan<span class="w"> </span><span class="m">2017</span>
<a id="__codelineno-84-6" name="__codelineno-84-6"></a><a href="#__codelineno-84-6"><span class="linenos" data-linenos=" 6 "></span></a>TLS<span class="w"> </span>SNI<span class="w"> </span>support<span class="w"> </span>enabled
<a id="__codelineno-84-7" name="__codelineno-84-7"></a><a href="#__codelineno-84-7"><span class="linenos" data-linenos=" 7 "></span></a>configure<span class="w"> </span>arguments:<span class="w"> </span>--user<span class="o">=</span>nginx<span class="w"> </span>--group<span class="o">=</span>nginx<span class="w"> </span>--prefix<span class="o">=</span>/data/nginx<span class="w"> </span>--with-pcre<span class="w"> </span>--with-http_v2_module<span class="w"> </span>--with-stream<span class="w"> </span>--with-stream_ssl_module<span class="w"> </span>--with-stream_ssl_preread_module<span class="w"> </span>--with-http_stub_status_module<span class="w"> </span>--with-http_ssl_module<span class="w"> </span>--with-http_image_filter_module<span class="w"> </span>--with-http_gzip_static_module<span class="w"> </span>--with-http_gunzip_module<span class="w"> </span>--with-http_sub_module<span class="w"> </span>--with-http_flv_module<span class="w"> </span>--with-http_addition_module<span class="w"> </span>--with-http_realip_module<span class="w"> </span>--with-http_mp4_module<span class="w"> </span>--with-http_dav_module<span class="w"> </span>--with-ld-opt<span class="o">=</span>-Wl,-E<span class="w"> </span>--with-cc-opt<span class="o">=</span>-Wno-error<span class="w"> </span>--with-ld-opt<span class="o">=</span>-ljemalloc<span class="w"> </span>--add-module<span class="o">=</span>/root/ngx_brotli<span class="w"> </span>--add-module<span class="o">=</span>/root/ngx_http_substitutions_filter_module-master
<a id="__codelineno-84-8" name="__codelineno-84-8"></a><a href="#__codelineno-84-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.160 -m shell -a &quot;/bin/nginx -V&quot; 2&gt;&amp;1 | grep &#39;prefix=&#39;</span>
<a id="__codelineno-84-9" name="__codelineno-84-9"></a><a href="#__codelineno-84-9"><span class="linenos" data-linenos=" 9 "></span></a>configure<span class="w"> </span>arguments:<span class="w"> </span>--user<span class="o">=</span>nginx<span class="w"> </span>--group<span class="o">=</span>nginx<span class="w"> </span>--prefix<span class="o">=</span>/data/nginx<span class="w"> </span>--with-pcre<span class="w"> </span>--with-http_v2_module<span class="w"> </span>--with-stream<span class="w"> </span>--with-stream_ssl_module<span class="w"> </span>--with-stream_ssl_preread_module<span class="w"> </span>--with-http_stub_status_module<span class="w"> </span>--with-http_ssl_module<span class="w"> </span>--with-http_image_filter_module<span class="w"> </span>--with-http_gzip_static_module<span class="w"> </span>--with-http_gunzip_module<span class="w"> </span>--with-http_sub_module<span class="w"> </span>--with-http_flv_module<span class="w"> </span>--with-http_addition_module<span class="w"> </span>--with-http_realip_module<span class="w"> </span>--with-http_mp4_module<span class="w"> </span>--with-http_dav_module<span class="w"> </span>--with-ld-opt<span class="o">=</span>-Wl,-E<span class="w"> </span>--with-cc-opt<span class="o">=</span>-Wno-error<span class="w"> </span>--with-ld-opt<span class="o">=</span>-ljemalloc<span class="w"> </span>--add-module<span class="o">=</span>/root/ngx_brotli<span class="w"> </span>--add-module<span class="o">=</span>/root/ngx_http_substitutions_filter_module-master
<a id="__codelineno-84-10" name="__codelineno-84-10"></a><a href="#__codelineno-84-10"><span class="linenos" data-linenos="10 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.160 -m shell -a &quot;/bin/nginx -V&quot; 2&gt;&amp;1 | grep &#39;prefix=&#39; | grep -oP &#39;prefix=\K[^ ]*&#39; </span>
<a id="__codelineno-84-11" name="__codelineno-84-11"></a><a href="#__codelineno-84-11"><span class="linenos" data-linenos="11 "></span></a>/data/nginx
</code></pre></div>
<p><strong>不存在nginx，以<code>10.22.50.249</code>为例：</strong></p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-85-1" name="__codelineno-85-1"></a><a href="#__codelineno-85-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 10.22.50.249 -m shell -a &quot;/bin/nginx -V&quot; 2&gt;&amp;1</span>
<a id="__codelineno-85-2" name="__codelineno-85-2"></a><a href="#__codelineno-85-2"><span class="linenos" data-linenos="2 "></span></a><span class="m">10</span>.22.50.249<span class="w"> </span><span class="p">|</span><span class="w"> </span>FAILED<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">rc</span><span class="o">=</span><span class="m">127</span><span class="w"> </span>&gt;&gt;
<a id="__codelineno-85-3" name="__codelineno-85-3"></a><a href="#__codelineno-85-3"><span class="linenos" data-linenos="3 "></span></a>/bin/sh:<span class="w"> </span>/bin/nginx:<span class="w"> </span>没有那个文件或目录non-zero<span class="w"> </span><span class="k">return</span><span class="w"> </span>code
<a id="__codelineno-85-4" name="__codelineno-85-4"></a><a href="#__codelineno-85-4"><span class="linenos" data-linenos="4 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 10.22.50.249 -m shell -a &quot;/bin/nginx -V&quot; 2&gt;&amp;1 | grep &#39;prefix=&#39; | grep -oP &#39;prefix=\K[^ ]*&#39;</span>
<a id="__codelineno-85-5" name="__codelineno-85-5"></a><a href="#__codelineno-85-5"><span class="linenos" data-linenos="5 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># </span>
</code></pre></div>
<h6 id="3213-查看-nginx-配置文件内容包含的配置文件">3.2.1.3 查看 nginx 配置文件内容（包含的配置文件）<a class="headerlink" href="#3213-查看-nginx-配置文件内容包含的配置文件" title="Permanent link">&para;</a></h6>
<ul>
<li>
<p><code>${nginx_config_output%/}/conf</code>：</p>
</li>
<li>
<p><code>${nginx_config_output%/}</code>：<code>${variable%pattern}</code> 是 Bash 中的一种字符串操作语法，<code>nginx_config_output%/</code> 表示从变量 <code>nginx_config_output</code> 的末尾删除一个 <code>/</code> 字符（如果存在），如果字符串末尾没有 <code>/</code>，则什么都不做。</p>
</li>
<li>
<p><code>/conf</code>：在执行了前一步之后，将结果与字符串 <code>"/conf"</code> 连接起来。</p>
</li>
<li>
<p><code>"grep 'include' $nginx_conf_file" | grep -v '#' | grep -oP '(conf.d|vhost)' | head -n 1</code>：主要是在<code>nginx.conf</code>配置文件内，查找是否包含<code>conf</code>配置文件，然后提取父目录，<strong>目的是为后面的从非nginx.conf提取的证书路径做准备</strong>。</p>
</li>
<li>
<p><code>grep 'include' $nginx_conf_file</code>：在 <code>nginx.conf</code> 文件中查找所有包含 &ldquo;include&rdquo; 的行。</p>
</li>
<li><code>grep -v '#'</code>：查找所有包含“#”的行，将其删除。</li>
<li><code>grep -oP '(conf.d|vhost)'</code>：<ul>
<li><code>grep -oP</code>: <code>-P</code>表示使用 Perl 正则表达式（PCRE），<code>-o</code> 表示只输出匹配部分。</li>
<li><code>'(conf.d|vhost)'</code> ：这是一个要匹配的正则表达式，直接匹配字符串 <code>conf.d/</code>或<code>vhosts/</code>，这部分主要用于寻找<code>conf</code>配置文件存放在 <code>conf.d/</code>还是<code>vhosts/</code>目录下。</li>
</ul>
</li>
<li><code>head -n 1</code>：用<code>head</code>命令只取第一行的值，作用为若有多个配置文件，父目录均为相同，因此只需要取第一个即可。</li>
</ul>
<p><strong>存在nginx，且配置文件所在目录为<code>conf.d</code>，以<code>172.18.0.100</code>为例：</strong></p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-86-1" name="__codelineno-86-1"></a><a href="#__codelineno-86-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.100 -m shell -a &quot;grep &#39;include&#39; /usr/local/nginx/conf/nginx.conf&quot; | grep -v &#39;#&#39;</span>
<a id="__codelineno-86-2" name="__codelineno-86-2"></a><a href="#__codelineno-86-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="m">172</span>.18.0.100<span class="w"> </span><span class="p">|</span><span class="w"> </span>CHANGED<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">rc</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>&gt;&gt;
<a id="__codelineno-86-3" name="__codelineno-86-3"></a><a href="#__codelineno-86-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">  </span>include<span class="w"> </span>mime.types<span class="p">;</span>
<a id="__codelineno-86-4" name="__codelineno-86-4"></a><a href="#__codelineno-86-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="w">  </span>include<span class="w"> </span>conf.d/proxy.its.sunline.cn.conf<span class="p">;</span>
<a id="__codelineno-86-5" name="__codelineno-86-5"></a><a href="#__codelineno-86-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="w">  </span>include<span class="w"> </span>conf.d/demo.its.sunline.cn.conf<span class="p">;</span>
<a id="__codelineno-86-6" name="__codelineno-86-6"></a><a href="#__codelineno-86-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="w">  </span>include<span class="w"> </span>conf.d/domain.its.sunline.cn.conf<span class="p">;</span>
<a id="__codelineno-86-7" name="__codelineno-86-7"></a><a href="#__codelineno-86-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="w">  </span>include<span class="w"> </span>conf.d/share.mis.sunline.cn.conf<span class="p">;</span>
<a id="__codelineno-86-8" name="__codelineno-86-8"></a><a href="#__codelineno-86-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">  </span>include<span class="w"> </span>conf.d/download.cloud.sunline.cn.conf<span class="p">;</span>
<a id="__codelineno-86-9" name="__codelineno-86-9"></a><a href="#__codelineno-86-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">  </span>include<span class="w"> </span>conf.d/nginxui.its.sunline.cn.conf<span class="p">;</span>
<a id="__codelineno-86-10" name="__codelineno-86-10"></a><a href="#__codelineno-86-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">  </span>include<span class="w"> </span>conf.d/password.its.sunline.cn.conf<span class="p">;</span>
<a id="__codelineno-86-11" name="__codelineno-86-11"></a><a href="#__codelineno-86-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">  </span>include<span class="w"> </span>conf.d/harbor.sh.sunline.cn.conf<span class="p">;</span>
<a id="__codelineno-86-12" name="__codelineno-86-12"></a><a href="#__codelineno-86-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">  </span>include<span class="w"> </span>conf.d/_.conf<span class="p">;</span>
<a id="__codelineno-86-13" name="__codelineno-86-13"></a><a href="#__codelineno-86-13"><span class="linenos" data-linenos="13 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.100 -m shell -a &quot;grep &#39;include&#39; /usr/local/nginx/conf/nginx.conf&quot; | grep -v &#39;#&#39; | grep -oP &#39;(conf.d|vhost)&#39; </span>
<a id="__codelineno-86-14" name="__codelineno-86-14"></a><a href="#__codelineno-86-14"><span class="linenos" data-linenos="14 "></span></a>conf.d
<a id="__codelineno-86-15" name="__codelineno-86-15"></a><a href="#__codelineno-86-15"><span class="linenos" data-linenos="15 "></span></a>conf.d
<a id="__codelineno-86-16" name="__codelineno-86-16"></a><a href="#__codelineno-86-16"><span class="linenos" data-linenos="16 "></span></a>conf.d
<a id="__codelineno-86-17" name="__codelineno-86-17"></a><a href="#__codelineno-86-17"><span class="linenos" data-linenos="17 "></span></a>conf.d
<a id="__codelineno-86-18" name="__codelineno-86-18"></a><a href="#__codelineno-86-18"><span class="linenos" data-linenos="18 "></span></a>conf.d
<a id="__codelineno-86-19" name="__codelineno-86-19"></a><a href="#__codelineno-86-19"><span class="linenos" data-linenos="19 "></span></a>conf.d
<a id="__codelineno-86-20" name="__codelineno-86-20"></a><a href="#__codelineno-86-20"><span class="linenos" data-linenos="20 "></span></a>conf.d
<a id="__codelineno-86-21" name="__codelineno-86-21"></a><a href="#__codelineno-86-21"><span class="linenos" data-linenos="21 "></span></a>conf.d
<a id="__codelineno-86-22" name="__codelineno-86-22"></a><a href="#__codelineno-86-22"><span class="linenos" data-linenos="22 "></span></a>conf.d
<a id="__codelineno-86-23" name="__codelineno-86-23"></a><a href="#__codelineno-86-23"><span class="linenos" data-linenos="23 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.100 -m shell -a &quot;grep &#39;include&#39; /usr/local/nginx/conf/nginx.conf&quot; | grep -v &#39;#&#39; | grep -oP &#39;(conf.d|vhost)&#39; | head -n 1</span>
<a id="__codelineno-86-24" name="__codelineno-86-24"></a><a href="#__codelineno-86-24"><span class="linenos" data-linenos="24 "></span></a>conf.d
</code></pre></div>
<p><strong>存在nginx，且配置文件所在目录为<code>vhost</code>，以<code>172.18.0.50</code>为例：</strong></p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-87-1" name="__codelineno-87-1"></a><a href="#__codelineno-87-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.50 -m shell -a &quot;grep &#39;include&#39; /usr/local/nginx/conf/nginx.conf&quot; | grep -v &#39;#&#39;</span>
<a id="__codelineno-87-2" name="__codelineno-87-2"></a><a href="#__codelineno-87-2"><span class="linenos" data-linenos="2 "></span></a><span class="m">172</span>.18.0.50<span class="w"> </span><span class="p">|</span><span class="w"> </span>CHANGED<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">rc</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>&gt;&gt;
<a id="__codelineno-87-3" name="__codelineno-87-3"></a><a href="#__codelineno-87-3"><span class="linenos" data-linenos="3 "></span></a><span class="w">  </span>include<span class="w"> </span>mime.types<span class="p">;</span>
<a id="__codelineno-87-4" name="__codelineno-87-4"></a><a href="#__codelineno-87-4"><span class="linenos" data-linenos="4 "></span></a><span class="w">  </span>add_header<span class="w"> </span>Strict-Transport-Security<span class="w"> </span><span class="s2">&quot;max-age=31536000; includeSubdomains; preload&quot;</span><span class="w"> </span>always<span class="p">;</span>
<a id="__codelineno-87-5" name="__codelineno-87-5"></a><a href="#__codelineno-87-5"><span class="linenos" data-linenos="5 "></span></a><span class="w">  </span>include<span class="w"> </span>/usr/local/nginx/conf/vhost/*.conf<span class="p">;</span>
<a id="__codelineno-87-6" name="__codelineno-87-6"></a><a href="#__codelineno-87-6"><span class="linenos" data-linenos="6 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.50 -m shell -a &quot;grep &#39;include&#39; /usr/local/nginx/conf/nginx.conf&quot; | grep -v &#39;#&#39; | grep -oP &#39;(conf.d|vhost)&#39; | head -n 1</span>
<a id="__codelineno-87-7" name="__codelineno-87-7"></a><a href="#__codelineno-87-7"><span class="linenos" data-linenos="7 "></span></a>vhost
</code></pre></div>
<ul>
<li>
<p><code>"ls $nginx_config_output/$conf_files" | grep -oP '.*conf$'</code>：</p>
</li>
<li>
<p><code>"ls $nginx_config_output/$conf_files"</code>：<code>$conf_files</code>属性值为<code>conf</code>配置文件所在的父目录，即列出父目录下的所有配置文件。</p>
</li>
<li><code>grep -oP '.*conf$'</code>：<ul>
<li><code>-o</code> ：表示只输出匹配部分。</li>
<li><code>-P</code>： 表示使用 Perl 兼容正则表达式（PCRE）。</li>
<li><code>'.*conf$'</code> ：匹配任意多个字符，直到结尾为<code>conf</code>。</li>
</ul>
</li>
</ul>
<p><strong>存在nginx，且配置文件所在目录为<code>conf.d</code>，以<code>172.18.0.160</code>为例：</strong></p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-88-1" name="__codelineno-88-1"></a><a href="#__codelineno-88-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.160 -m shell -a &quot;grep &#39;conf.d&#39; /data/nginx/conf/nginx.conf&quot;</span>
<a id="__codelineno-88-2" name="__codelineno-88-2"></a><a href="#__codelineno-88-2"><span class="linenos" data-linenos="2 "></span></a><span class="m">172</span>.18.0.160<span class="w"> </span><span class="p">|</span><span class="w"> </span>CHANGED<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">rc</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>&gt;&gt;
<a id="__codelineno-88-3" name="__codelineno-88-3"></a><a href="#__codelineno-88-3"><span class="linenos" data-linenos="3 "></span></a><span class="w">  </span>include<span class="w"> </span>conf.d/*.conf<span class="p">;</span>
<a id="__codelineno-88-4" name="__codelineno-88-4"></a><a href="#__codelineno-88-4"><span class="linenos" data-linenos="4 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.160 -m shell -a &quot;ls /data/nginx/conf/conf.d&quot; |  grep -oP &#39;.*conf$&#39;</span>
<a id="__codelineno-88-5" name="__codelineno-88-5"></a><a href="#__codelineno-88-5"><span class="linenos" data-linenos="5 "></span></a>hr.iboss.sunline.cn-9443.conf
<a id="__codelineno-88-6" name="__codelineno-88-6"></a><a href="#__codelineno-88-6"><span class="linenos" data-linenos="6 "></span></a>iboss.sunline.cn-8443.conf
<a id="__codelineno-88-7" name="__codelineno-88-7"></a><a href="#__codelineno-88-7"><span class="linenos" data-linenos="7 "></span></a>iboss.sunline.cn.conf
<a id="__codelineno-88-8" name="__codelineno-88-8"></a><a href="#__codelineno-88-8"><span class="linenos" data-linenos="8 "></span></a>none.conf
<a id="__codelineno-88-9" name="__codelineno-88-9"></a><a href="#__codelineno-88-9"><span class="linenos" data-linenos="9 "></span></a>wecom.iboss.sunline.cn-6443.conf
</code></pre></div>
<p><strong>存在nginx，且配置文件所在目录为<code>vhost</code>，以<code>172.18.0.50</code>为例：</strong></p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-89-1" name="__codelineno-89-1"></a><a href="#__codelineno-89-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.50 -m shell -a &quot;grep &#39;vhost&#39; /usr/local/nginx/conf/nginx.conf&quot;</span>
<a id="__codelineno-89-2" name="__codelineno-89-2"></a><a href="#__codelineno-89-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="m">172</span>.18.0.50<span class="w"> </span><span class="p">|</span><span class="w"> </span>CHANGED<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">rc</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>&gt;&gt;
<a id="__codelineno-89-3" name="__codelineno-89-3"></a><a href="#__codelineno-89-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="w">  </span>include<span class="w"> </span>/usr/local/nginx/conf/vhost/*.conf<span class="p">;</span>
<a id="__codelineno-89-4" name="__codelineno-89-4"></a><a href="#__codelineno-89-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.50 -m shell -a &quot;ls /usr/local/nginx/conf/vhost&quot;</span>
<a id="__codelineno-89-5" name="__codelineno-89-5"></a><a href="#__codelineno-89-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="m">172</span>.18.0.50<span class="w"> </span><span class="p">|</span><span class="w"> </span>CHANGED<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">rc</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>&gt;&gt;
<a id="__codelineno-89-6" name="__codelineno-89-6"></a><a href="#__codelineno-89-6"><span class="linenos" data-linenos=" 6 "></span></a>none.conf
<a id="__codelineno-89-7" name="__codelineno-89-7"></a><a href="#__codelineno-89-7"><span class="linenos" data-linenos=" 7 "></span></a>sunline.cn.conf
<a id="__codelineno-89-8" name="__codelineno-89-8"></a><a href="#__codelineno-89-8"><span class="linenos" data-linenos=" 8 "></span></a>sunline-i.com.conf
<a id="__codelineno-89-9" name="__codelineno-89-9"></a><a href="#__codelineno-89-9"><span class="linenos" data-linenos=" 9 "></span></a>www_cpanel.conf.bak
<a id="__codelineno-89-10" name="__codelineno-89-10"></a><a href="#__codelineno-89-10"><span class="linenos" data-linenos="10 "></span></a>zw-A.conf
<a id="__codelineno-89-11" name="__codelineno-89-11"></a><a href="#__codelineno-89-11"><span class="linenos" data-linenos="11 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.50 -m shell -a &quot;ls /usr/local/nginx/conf/vhost&quot; | grep -oP &#39;.*conf$&#39;</span>
<a id="__codelineno-89-12" name="__codelineno-89-12"></a><a href="#__codelineno-89-12"><span class="linenos" data-linenos="12 "></span></a>none.conf
<a id="__codelineno-89-13" name="__codelineno-89-13"></a><a href="#__codelineno-89-13"><span class="linenos" data-linenos="13 "></span></a>sunline.cn.conf
<a id="__codelineno-89-14" name="__codelineno-89-14"></a><a href="#__codelineno-89-14"><span class="linenos" data-linenos="14 "></span></a>sunline-i.com.conf
<a id="__codelineno-89-15" name="__codelineno-89-15"></a><a href="#__codelineno-89-15"><span class="linenos" data-linenos="15 "></span></a>zw-A.conf
</code></pre></div>
<h6 id="3214-从nginxconf提取的证书路径">3.2.1.4 从nginx.conf提取的证书路径<a class="headerlink" href="#3214-从nginxconf提取的证书路径" title="Permanent link">&para;</a></h6>
<ul>
<li>
<p><code>grep -oP 'ssl_certificate(_key)?\s+\K[^;]*'</code>：</p>
</li>
<li>
<p><code>grep -oP</code>: <code>-P</code>表示使用 Perl 正则表达式（PCRE），<code>-o</code> 表示只输出匹配部分。</p>
</li>
<li><code>'ssl_certificate\s+\K[^;]*'</code> ：这是一个要匹配的正则表达式。<ul>
<li><code>ssl_certificate</code>：直接匹配字符串 <code>ssl_certificate</code>，这部分用于寻找包含 <code>ssl_certificate</code> 的文本行。</li>
<li><code>(_key)?</code>：表示 <code>_key</code> 是可选的，可以出现0次或1次。</li>
<li><code>\s+</code>：匹配到一个或多个空白字符（例如空格）。</li>
<li><code>\K</code>：重置匹配的开始位置，忽略 <code>ssl_certificate</code> 和空白字符。</li>
<li><code>[^;]*</code> 从当前位置开始，匹配任何字符，但不包括分号 <code>;</code>，即直到遇到分号 <code>;</code>。</li>
</ul>
</li>
</ul>
<p><strong>存在nginx，以<code>172.18.0.78</code>为例：</strong></p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-90-1" name="__codelineno-90-1"></a><a href="#__codelineno-90-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.78 -m shell -a &quot;grep -v &#39;#&#39; /usr/local/nginx/conf/nginx.conf&quot; | grep -oP &#39;ssl_certificate(_key)?\s+\K[^;]*&#39;</span>
<a id="__codelineno-90-2" name="__codelineno-90-2"></a><a href="#__codelineno-90-2"><span class="linenos" data-linenos=" 2 "></span></a>/usr/local/nginx/ssl/yhtprd.clhd.sunline.cn_bundle.crt
<a id="__codelineno-90-3" name="__codelineno-90-3"></a><a href="#__codelineno-90-3"><span class="linenos" data-linenos=" 3 "></span></a>/usr/local/nginx/ssl/yhtprd.clhd.sunline.cn.key
<a id="__codelineno-90-4" name="__codelineno-90-4"></a><a href="#__codelineno-90-4"><span class="linenos" data-linenos=" 4 "></span></a>/usr/local/nginx/ssl/none-ca.crt
<a id="__codelineno-90-5" name="__codelineno-90-5"></a><a href="#__codelineno-90-5"><span class="linenos" data-linenos=" 5 "></span></a>/usr/local/nginx/ssl/none-ca.key
<a id="__codelineno-90-6" name="__codelineno-90-6"></a><a href="#__codelineno-90-6"><span class="linenos" data-linenos=" 6 "></span></a>
<a id="__codelineno-90-7" name="__codelineno-90-7"></a><a href="#__codelineno-90-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="c1"># 172.18.0.78的ssl证书所在目录/usr/local/nginx/ssl下不止nginx.conf中用到的，通过ls命令查看目录证书下，还包括了没有用到的，为20230103目录的证书，所以直接取nginx.conf中用到的路径就行</span>
<a id="__codelineno-90-8" name="__codelineno-90-8"></a><a href="#__codelineno-90-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.78 -m shell -a &quot;ls /usr/local/nginx/ssl&quot;</span>
<a id="__codelineno-90-9" name="__codelineno-90-9"></a><a href="#__codelineno-90-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="m">172</span>.18.0.78<span class="w"> </span><span class="p">|</span><span class="w"> </span>CHANGED<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">rc</span><span class="o">=</span><span class="m">0</span><span class="w"> </span>&gt;&gt;
<a id="__codelineno-90-10" name="__codelineno-90-10"></a><a href="#__codelineno-90-10"><span class="linenos" data-linenos="10 "></span></a><span class="m">20230103</span>
<a id="__codelineno-90-11" name="__codelineno-90-11"></a><a href="#__codelineno-90-11"><span class="linenos" data-linenos="11 "></span></a>none-ca.crt
<a id="__codelineno-90-12" name="__codelineno-90-12"></a><a href="#__codelineno-90-12"><span class="linenos" data-linenos="12 "></span></a>none-ca.key
<a id="__codelineno-90-13" name="__codelineno-90-13"></a><a href="#__codelineno-90-13"><span class="linenos" data-linenos="13 "></span></a>yhtprd.clhd.sunline.cn_bundle.crt
<a id="__codelineno-90-14" name="__codelineno-90-14"></a><a href="#__codelineno-90-14"><span class="linenos" data-linenos="14 "></span></a>yhtprd.clhd.sunline.cn.key
</code></pre></div>
<ul>
<li><code>cert_files_array=($cert_files)</code>：将获取到的证书路径转换为数组。</li>
<li><code>for cert_file in "${cert_files_array[@]}"; do .... done</code>：这里通过for循环遍历证书路径数组目的为后面判断路径是相对路径还是绝对路径做准备，然后将所有路径存放于变量<code>cert_paths</code>中。</li>
<li><code>! [[  "$cert_file" =~ "none" ]]</code>：判断证书是否为none证书，不是的话执行if语句里的命令，是的话直接跳过。</li>
<li><code>${cert_files:0:1} != "/"</code>：判断字符串变量的第一个字符是否不等于<code>/</code>。这里主要是用来判断证书路径为绝对路径还是相对路径，如果是相对路径，第一个字符不会以<code>/</code>开始，则执行<code>if</code>语句里的命令。</li>
<li><code>:0:1</code>：这是切片的部分，表示从字符串的第0个字符开始，取长度为1的子字符串。</li>
<li><code>!= "/"</code>：判断是否不等于字符<code>/</code>。</li>
</ul>
<h6 id="3215-从非nginxconf提取的证书路径">3.2.1.5 从非nginx.conf提取的证书路径<a class="headerlink" href="#3215-从非nginxconf提取的证书路径" title="Permanent link">&para;</a></h6>
<ul>
<li>
<p><code>"cd $nginx_config_output/$conf_files &amp;&amp; echo '$confd_conf_files' | xargs cat"</code>：</p>
</li>
<li>
<p><code>cd $nginx_config_output/$conf_files</code>：进入到<code>conf</code>配置文件所在的父目录。</p>
</li>
<li><code>&amp;&amp;</code>：使用逻辑与运算符，主要用于保证前后的命令在同一个子shell中执行。</li>
<li>
<p><code>echo '$confd_conf_files' | xargs cat"</code>：</p>
<ul>
<li><code>echo '$confd_conf_files'</code>：输出变量 <code>$confd_conf_files</code> 的内容，即多个<code>conf</code>配置文件。</li>
<li><code>|</code>：通过<code>|</code>管道操作符，将前一个命令的输出作为后一个命令的输入。</li>
<li><code>xargs cat</code>：<code>xargs</code> 从标准输入读取数据并将其作为参数传递给后面的命令<strong>（主要确保 <code>cat</code> 命令一次性读取所有文件）</strong>，而后<code>cat</code> 命令会接收 <code>xargs</code> 传递的文件名并读取它们的内容。</li>
</ul>
<p><strong>存在nginx，以<code>172.18.0.161</code>为例：</strong></p>
</li>
</ul>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-91-1" name="__codelineno-91-1"></a><a href="#__codelineno-91-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="c1"># 先定义了一个变量confd_conf_files获取conf.d目录下的conf配置文件，然后通过cat命令读取所有配置文件的内容再进行处理</span>
<a id="__codelineno-91-2" name="__codelineno-91-2"></a><a href="#__codelineno-91-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># confd_conf_files=$(ansible 172.18.0.161 -m shell -a &quot;ls /data/nginx/conf/conf.d&quot; | grep -oP &#39;.*conf$&#39;)</span>
<a id="__codelineno-91-3" name="__codelineno-91-3"></a><a href="#__codelineno-91-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>~<span class="o">]</span><span class="c1"># ansible 172.18.0.161 -m shell -a &quot;cd /data/nginx/conf/conf.d &amp;&amp; echo &#39;$confd_conf_files&#39; | xargs cat&quot; | grep -v &#39;#&#39; | grep -oP &#39;ssl_certificate(_key)?\s+\K[^;]*&#39;</span>
<a id="__codelineno-91-4" name="__codelineno-91-4"></a><a href="#__codelineno-91-4"><span class="linenos" data-linenos=" 4 "></span></a>cert/hr.iboss.sunline.cn_bundle.pem
<a id="__codelineno-91-5" name="__codelineno-91-5"></a><a href="#__codelineno-91-5"><span class="linenos" data-linenos=" 5 "></span></a>cert/hr.iboss.sunline.cn.key
<a id="__codelineno-91-6" name="__codelineno-91-6"></a><a href="#__codelineno-91-6"><span class="linenos" data-linenos=" 6 "></span></a>cert/iboss.sunline.cn.pem
<a id="__codelineno-91-7" name="__codelineno-91-7"></a><a href="#__codelineno-91-7"><span class="linenos" data-linenos=" 7 "></span></a>cert/iboss.sunline.cn.key
<a id="__codelineno-91-8" name="__codelineno-91-8"></a><a href="#__codelineno-91-8"><span class="linenos" data-linenos=" 8 "></span></a>cert/iboss.sunline.cn.pem
<a id="__codelineno-91-9" name="__codelineno-91-9"></a><a href="#__codelineno-91-9"><span class="linenos" data-linenos=" 9 "></span></a>cert/iboss.sunline.cn.key
<a id="__codelineno-91-10" name="__codelineno-91-10"></a><a href="#__codelineno-91-10"><span class="linenos" data-linenos="10 "></span></a>cert/none-ca.crt
<a id="__codelineno-91-11" name="__codelineno-91-11"></a><a href="#__codelineno-91-11"><span class="linenos" data-linenos="11 "></span></a>cert/none-ca.key
<a id="__codelineno-91-12" name="__codelineno-91-12"></a><a href="#__codelineno-91-12"><span class="linenos" data-linenos="12 "></span></a>cert/wecom.iboss.sunline.cn.pem
<a id="__codelineno-91-13" name="__codelineno-91-13"></a><a href="#__codelineno-91-13"><span class="linenos" data-linenos="13 "></span></a>cert/wecom.iboss.sunline.cn.key
</code></pre></div>
<h5 id="322-运行shell脚本">3.2.2 运行shell脚本<a class="headerlink" href="#322-运行shell脚本" title="Permanent link">&para;</a></h5>
<p>执行脚本<code>extract_nginx_configuration.sh</code>，该脚本存放于<code>/usr/local/scripts/nginx_configuration</code>目录下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-92-1" name="__codelineno-92-1"></a><a href="#__codelineno-92-1"><span class="linenos" data-linenos="1 "></span></a><span class="nb">cd</span><span class="w"> </span>/usr/local/scripts/nginx_configuration
<a id="__codelineno-92-2" name="__codelineno-92-2"></a><a href="#__codelineno-92-2"><span class="linenos" data-linenos="2 "></span></a>sh<span class="w"> </span>extract_nginx_configuration.sh
</code></pre></div>
<p>执行后的结果如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-93-1" name="__codelineno-93-1"></a><a href="#__codelineno-93-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>nginx_configuration<span class="o">]</span><span class="c1"># sh extract_nginx_configuration.sh </span>
<a id="__codelineno-93-2" name="__codelineno-93-2"></a><a href="#__codelineno-93-2"><span class="linenos" data-linenos="2 "></span></a>输出目录已存在，程序开始写入数据。
<a id="__codelineno-93-3" name="__codelineno-93-3"></a><a href="#__codelineno-93-3"><span class="linenos" data-linenos="3 "></span></a>
<a id="__codelineno-93-4" name="__codelineno-93-4"></a><a href="#__codelineno-93-4"><span class="linenos" data-linenos="4 "></span></a>服务器<span class="w"> </span><span class="m">172</span>.18.0.160<span class="w"> </span>的结果已保存到......
<a id="__codelineno-93-5" name="__codelineno-93-5"></a><a href="#__codelineno-93-5"><span class="linenos" data-linenos="5 "></span></a>.......
<a id="__codelineno-93-6" name="__codelineno-93-6"></a><a href="#__codelineno-93-6"><span class="linenos" data-linenos="6 "></span></a>
<a id="__codelineno-93-7" name="__codelineno-93-7"></a><a href="#__codelineno-93-7"><span class="linenos" data-linenos="7 "></span></a>所有服务器执行完毕！
</code></pre></div>
<p>执行后通过<code>ls</code>命令查看<code>nginx_configuration</code>目录，可以看到生成了获取nginx配置的每个服务器文件：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-94-1" name="__codelineno-94-1"></a><a href="#__codelineno-94-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>scripts<span class="o">]</span><span class="c1"># ls nginx_configuration</span>
<a id="__codelineno-94-2" name="__codelineno-94-2"></a><a href="#__codelineno-94-2"><span class="linenos" data-linenos="2 "></span></a>ansible_10.22.21.99_nginx.txt<span class="w">   </span>ansible_172.18.0.100_nginx.txt<span class="w">  </span>ansible_172.18.0.79_nginx.txt
<a id="__codelineno-94-3" name="__codelineno-94-3"></a><a href="#__codelineno-94-3"><span class="linenos" data-linenos="3 "></span></a>ansible_10.22.50.135_nginx.txt<span class="w">  </span>ansible_172.18.0.160_nginx.txt<span class="w">  </span>ansible_172.18.0.82_nginx.txt
<a id="__codelineno-94-4" name="__codelineno-94-4"></a><a href="#__codelineno-94-4"><span class="linenos" data-linenos="4 "></span></a>ansible_10.22.50.220_nginx.txt<span class="w">  </span>ansible_172.18.0.161_nginx.txt<span class="w">  </span>extract_nginx_configuration.sh
<a id="__codelineno-94-5" name="__codelineno-94-5"></a><a href="#__codelineno-94-5"><span class="linenos" data-linenos="5 "></span></a>ansible_10.22.50.221_nginx.txt<span class="w">  </span>ansible_172.18.0.50_nginx.txt
<a id="__codelineno-94-6" name="__codelineno-94-6"></a><a href="#__codelineno-94-6"><span class="linenos" data-linenos="6 "></span></a>ansible_10.22.50.249_nginx.txt<span class="w">  </span>ansible_172.18.0.78_nginx.txt
</code></pre></div>
<p>进入<code>ansible_172.18.0.100_nginx.txt</code>文件，可以查看到每个获取的信息：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-95-1" name="__codelineno-95-1"></a><a href="#__codelineno-95-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>nginx_configuration<span class="o">]</span><span class="c1"># vim ansible_172.18.0.100_nginx.txt</span>
<a id="__codelineno-95-2" name="__codelineno-95-2"></a><a href="#__codelineno-95-2"><span class="linenos" data-linenos=" 2 "></span></a>处理服务器:<span class="w"> </span><span class="m">172</span>.18.0.100
<a id="__codelineno-95-3" name="__codelineno-95-3"></a><a href="#__codelineno-95-3"><span class="linenos" data-linenos=" 3 "></span></a>
<a id="__codelineno-95-4" name="__codelineno-95-4"></a><a href="#__codelineno-95-4"><span class="linenos" data-linenos=" 4 "></span></a>
<a id="__codelineno-95-5" name="__codelineno-95-5"></a><a href="#__codelineno-95-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="c1">###### &lt;1&gt; 检查 nginx 路径</span>
<a id="__codelineno-95-6" name="__codelineno-95-6"></a><a href="#__codelineno-95-6"><span class="linenos" data-linenos=" 6 "></span></a>Nginx<span class="w"> </span>路径:<span class="w"> </span>/sbin/nginx
<a id="__codelineno-95-7" name="__codelineno-95-7"></a><a href="#__codelineno-95-7"><span class="linenos" data-linenos=" 7 "></span></a>
<a id="__codelineno-95-8" name="__codelineno-95-8"></a><a href="#__codelineno-95-8"><span class="linenos" data-linenos=" 8 "></span></a>......
<a id="__codelineno-95-9" name="__codelineno-95-9"></a><a href="#__codelineno-95-9"><span class="linenos" data-linenos=" 9 "></span></a>
<a id="__codelineno-95-10" name="__codelineno-95-10"></a><a href="#__codelineno-95-10"><span class="linenos" data-linenos="10 "></span></a>
<a id="__codelineno-95-11" name="__codelineno-95-11"></a><a href="#__codelineno-95-11"><span class="linenos" data-linenos="11 "></span></a><span class="c1">###### &lt;4&gt; 提取的证书路径</span>
<a id="__codelineno-95-12" name="__codelineno-95-12"></a><a href="#__codelineno-95-12"><span class="linenos" data-linenos="12 "></span></a>从nginx.conf提取的证书路径:
<a id="__codelineno-95-13" name="__codelineno-95-13"></a><a href="#__codelineno-95-13"><span class="linenos" data-linenos="13 "></span></a>无
<a id="__codelineno-95-14" name="__codelineno-95-14"></a><a href="#__codelineno-95-14"><span class="linenos" data-linenos="14 "></span></a>
<a id="__codelineno-95-15" name="__codelineno-95-15"></a><a href="#__codelineno-95-15"><span class="linenos" data-linenos="15 "></span></a>从非nginx.conf提取的证书路径:
<a id="__codelineno-95-16" name="__codelineno-95-16"></a><a href="#__codelineno-95-16"><span class="linenos" data-linenos="16 "></span></a>/usr/local/nginxwebui/cert/demo.its.sunline.cn/demo.its.sunline.cn.pem
<a id="__codelineno-95-17" name="__codelineno-95-17"></a><a href="#__codelineno-95-17"><span class="linenos" data-linenos="17 "></span></a>/usr/local/nginxwebui/cert/demo.its.sunline.cn/demo.its.sunline.cn.key
<a id="__codelineno-95-18" name="__codelineno-95-18"></a><a href="#__codelineno-95-18"><span class="linenos" data-linenos="18 "></span></a>/usr/local/nginxwebui/cert/harbor.sh.sunline.cn/harbor.sh.sunline.cn.pem
<a id="__codelineno-95-19" name="__codelineno-95-19"></a><a href="#__codelineno-95-19"><span class="linenos" data-linenos="19 "></span></a>/usr/local/nginxwebui/cert/harbor.sh.sunline.cn/harbor.sh.sunline.cn.key
<a id="__codelineno-95-20" name="__codelineno-95-20"></a><a href="#__codelineno-95-20"><span class="linenos" data-linenos="20 "></span></a>/usr/local/nginxwebui/cert/password.its.sunline.cn/password.its.sunline.cn.pem
<a id="__codelineno-95-21" name="__codelineno-95-21"></a><a href="#__codelineno-95-21"><span class="linenos" data-linenos="21 "></span></a>/usr/local/nginxwebui/cert/password.its.sunline.cn/password.its.sunline.cn.key
<a id="__codelineno-95-22" name="__codelineno-95-22"></a><a href="#__codelineno-95-22"><span class="linenos" data-linenos="22 "></span></a>/usr/local/nginxwebui/cert/proxy.its.sunline.cn/proxy.its.sunline.cn.pem
<a id="__codelineno-95-23" name="__codelineno-95-23"></a><a href="#__codelineno-95-23"><span class="linenos" data-linenos="23 "></span></a>/usr/local/nginxwebui/cert/proxy.its.sunline.cn/proxy.its.sunline.cn.key
</code></pre></div>
<h4 id="33-配置提取nginx及证书信息的脚本">3.3 配置提取nginx及证书信息的脚本<a class="headerlink" href="#33-配置提取nginx及证书信息的脚本" title="Permanent link">&para;</a></h4>
<h5 id="331-配置shell脚本">3.3.1 配置shell脚本<a class="headerlink" href="#331-配置shell脚本" title="Permanent link">&para;</a></h5>
<p>该脚本是基于上方每台服务器获取到nginx配置和证书信息生成的文件的脚本后执行，主要是将所有服务器的nginx配置和证书信息文件<code>ansible_*_nginx.txt</code>提取部分nginx信息并合并到一个文件，方便查看。</p>
<p>这里创建了一个shell脚本<code>extract_nginx_info.sh</code>，具体内容如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-96-1" name="__codelineno-96-1"></a><a href="#__codelineno-96-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-96-2" name="__codelineno-96-2"></a><a href="#__codelineno-96-2"><span class="linenos" data-linenos=" 2 "></span></a>
<a id="__codelineno-96-3" name="__codelineno-96-3"></a><a href="#__codelineno-96-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="nv">output_file</span><span class="o">=</span><span class="s2">&quot;/tmp/extract_nginx_data.txt&quot;</span>
<a id="__codelineno-96-4" name="__codelineno-96-4"></a><a href="#__codelineno-96-4"><span class="linenos" data-linenos=" 4 "></span></a>
<a id="__codelineno-96-5" name="__codelineno-96-5"></a><a href="#__codelineno-96-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span>&gt;<span class="w"> </span><span class="nv">$output_file</span>
<a id="__codelineno-96-6" name="__codelineno-96-6"></a><a href="#__codelineno-96-6"><span class="linenos" data-linenos=" 6 "></span></a>
<a id="__codelineno-96-7" name="__codelineno-96-7"></a><a href="#__codelineno-96-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="nv">directory</span><span class="o">=</span><span class="s2">&quot;/usr/local/scripts/nginx_configuration&quot;</span>
<a id="__codelineno-96-8" name="__codelineno-96-8"></a><a href="#__codelineno-96-8"><span class="linenos" data-linenos=" 8 "></span></a>
<a id="__codelineno-96-9" name="__codelineno-96-9"></a><a href="#__codelineno-96-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="k">for</span><span class="w"> </span>file<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nv">$directory</span>/ansible_*.txt<span class="w">    </span>
<a id="__codelineno-96-10" name="__codelineno-96-10"></a><a href="#__codelineno-96-10"><span class="linenos" data-linenos="10 "></span></a><span class="k">do</span>
<a id="__codelineno-96-11" name="__codelineno-96-11"></a><a href="#__codelineno-96-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">    </span><span class="nv">ip</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-oP<span class="w"> </span><span class="s1">&#39;ansible_\K[0-9.]+(?=_nginx.txt)&#39;</span><span class="k">)</span>
<a id="__codelineno-96-12" name="__codelineno-96-12"></a><a href="#__codelineno-96-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Processing </span><span class="nv">$ip</span><span class="s2">&quot;</span>
<a id="__codelineno-96-13" name="__codelineno-96-13"></a><a href="#__codelineno-96-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">    </span><span class="nv">nginx_path</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span><span class="s2">&quot;Nginx 路径&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F<span class="s1">&#39;: &#39;</span><span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
<a id="__codelineno-96-14" name="__codelineno-96-14"></a><a href="#__codelineno-96-14"><span class="linenos" data-linenos="14 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$nginx_path</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<a id="__codelineno-96-15" name="__codelineno-96-15"></a><a href="#__codelineno-96-15"><span class="linenos" data-linenos="15 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;IP: </span><span class="nv">$ip</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$output_file</span>
<a id="__codelineno-96-16" name="__codelineno-96-16"></a><a href="#__codelineno-96-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;No Nginx&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$output_file</span>
<a id="__codelineno-96-17" name="__codelineno-96-17"></a><a href="#__codelineno-96-17"><span class="linenos" data-linenos="17 "></span></a><span class="w">    </span><span class="k">else</span>
<a id="__codelineno-96-18" name="__codelineno-96-18"></a><a href="#__codelineno-96-18"><span class="linenos" data-linenos="18 "></span></a><span class="w">        </span><span class="nv">config_path</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span><span class="s2">&quot;Nginx 配置路径&quot;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span>-F<span class="s1">&#39;: &#39;</span><span class="w"> </span><span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
<a id="__codelineno-96-19" name="__codelineno-96-19"></a><a href="#__codelineno-96-19"><span class="linenos" data-linenos="19 "></span></a><span class="w">        </span><span class="nv">cert_path</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span>-P<span class="w"> </span><span class="s1">&#39;\.(pem|cer|crt)$&#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="k">)</span>
<a id="__codelineno-96-20" name="__codelineno-96-20"></a><a href="#__codelineno-96-20"><span class="linenos" data-linenos="20 "></span></a><span class="w">        </span><span class="nv">key_path</span><span class="o">=</span><span class="k">$(</span>grep<span class="w"> </span>-P<span class="w"> </span><span class="s1">&#39;\.key$&#39;</span><span class="w"> </span><span class="s2">&quot;</span><span class="nv">$file</span><span class="s2">&quot;</span><span class="k">)</span>
<a id="__codelineno-96-21" name="__codelineno-96-21"></a><a href="#__codelineno-96-21"><span class="linenos" data-linenos="21 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;IP: </span><span class="nv">$ip</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$output_file</span>
<a id="__codelineno-96-22" name="__codelineno-96-22"></a><a href="#__codelineno-96-22"><span class="linenos" data-linenos="22 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Nginx Path: </span><span class="nv">$nginx_path</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$output_file</span>
<a id="__codelineno-96-23" name="__codelineno-96-23"></a><a href="#__codelineno-96-23"><span class="linenos" data-linenos="23 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Config Path: </span><span class="nv">$config_path</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$output_file</span>
<a id="__codelineno-96-24" name="__codelineno-96-24"></a><a href="#__codelineno-96-24"><span class="linenos" data-linenos="24 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;Cert Path:\n</span><span class="nv">$cert_path</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$output_file</span>
<a id="__codelineno-96-25" name="__codelineno-96-25"></a><a href="#__codelineno-96-25"><span class="linenos" data-linenos="25 "></span></a><span class="w">        </span><span class="nb">echo</span><span class="w"> </span>-e<span class="w"> </span><span class="s2">&quot;Key Path:\n</span><span class="nv">$key_path</span><span class="s2">&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$output_file</span>
<a id="__codelineno-96-26" name="__codelineno-96-26"></a><a href="#__codelineno-96-26"><span class="linenos" data-linenos="26 "></span></a><span class="w">    </span><span class="k">fi</span>
<a id="__codelineno-96-27" name="__codelineno-96-27"></a><a href="#__codelineno-96-27"><span class="linenos" data-linenos="27 "></span></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;-------------------------------------&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span><span class="nv">$output_file</span>
<a id="__codelineno-96-28" name="__codelineno-96-28"></a><a href="#__codelineno-96-28"><span class="linenos" data-linenos="28 "></span></a><span class="w">    </span>sleep<span class="w"> </span><span class="m">1</span>
<a id="__codelineno-96-29" name="__codelineno-96-29"></a><a href="#__codelineno-96-29"><span class="linenos" data-linenos="29 "></span></a><span class="k">done</span>
<a id="__codelineno-96-30" name="__codelineno-96-30"></a><a href="#__codelineno-96-30"><span class="linenos" data-linenos="30 "></span></a>
<a id="__codelineno-96-31" name="__codelineno-96-31"></a><a href="#__codelineno-96-31"><span class="linenos" data-linenos="31 "></span></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Data extraction complete. Results saved in </span><span class="nv">$output_file</span><span class="s2">&quot;</span>
</code></pre></div>
<p><strong>脚本说明：</strong></p>
<ul>
<li><code>echo -n</code>：输出文本，<code>-n</code>表示不会在末尾添加换行符。</li>
<li><code>grep -oP 'ansible_\K[0-9.]+(?=_nginx.txt)'</code>：</li>
<li><code>grep -oP</code>: <code>-P</code>表示使用 Perl 正则表达式（PCRE），<code>-o</code> 表示只输出匹配部分。</li>
<li><code>'ansible_\K[0-9.]+(?=_nginx.txt)'</code> ：这是一个要匹配的正则表达式。<ul>
<li><code>\K</code>：重置匹配的起始位置，只将此位置之后的部分作为匹配结果的一部分。</li>
<li><code>[0-9.]+</code>：匹配一个或多个数字（0-9）和点（.）。</li>
<li><code>\K</code>：重置匹配的开始位置，忽略 <code>ssl_certificate</code> 和空白字符。</li>
<li><code>(?=_nginx.txt)</code>：正向前瞻断言，表示匹配的内容后面紧跟着 &ldquo;_nginx.txt&rdquo;。<code>(?=...)</code> 是一个正向前瞻断言，它用于确保某个模式在匹配的位置之后存在，而不会将其包含在匹配结果中。</li>
</ul>
</li>
<li><code>awk -F': ' '{print $2}'</code>：读取文件中的每一行，并以 <code>:</code>（冒号后面有空格）作为分隔符，将行分割成多个字段，然后打印第二个字段。</li>
<li><code>'\.(pem|cer|crt)$'</code>：先匹配一个点（.），然后匹配 <code>pem</code>、<code>cer</code> 或 <code>crt</code> 其中之一，<code>$</code>表示以这三个为结尾的内容。</li>
<li><code>'\.key$'</code>：先匹配一个点（.），然后匹配<code>key</code>，<code>$</code>表示以<code>key</code>为结尾的内容。</li>
</ul>
<h5 id="332-运行shell脚本">3.3.2 运行shell脚本<a class="headerlink" href="#332-运行shell脚本" title="Permanent link">&para;</a></h5>
<p>执行脚本<code>extract_nginx_info.sh</code>，该脚本存放于<code>/usr/local/scripts/nginx_configuration</code>目录下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-97-1" name="__codelineno-97-1"></a><a href="#__codelineno-97-1"><span class="linenos" data-linenos="1 "></span></a><span class="nb">cd</span><span class="w"> </span>/usr/local/scripts/nginx_configuration
<a id="__codelineno-97-2" name="__codelineno-97-2"></a><a href="#__codelineno-97-2"><span class="linenos" data-linenos="2 "></span></a>sh<span class="w"> </span>extract_nginx_info
</code></pre></div>
<p>执行后的结果如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-98-1" name="__codelineno-98-1"></a><a href="#__codelineno-98-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>nginx_configuration<span class="o">]</span><span class="c1"># sh extract_nginx_info.sh</span>
<a id="__codelineno-98-2" name="__codelineno-98-2"></a><a href="#__codelineno-98-2"><span class="linenos" data-linenos="2 "></span></a>Processing<span class="w"> </span><span class="m">10</span>.22.21.99
<a id="__codelineno-98-3" name="__codelineno-98-3"></a><a href="#__codelineno-98-3"><span class="linenos" data-linenos="3 "></span></a>Processing<span class="w"> </span><span class="m">10</span>.22.50.135
<a id="__codelineno-98-4" name="__codelineno-98-4"></a><a href="#__codelineno-98-4"><span class="linenos" data-linenos="4 "></span></a>....
<a id="__codelineno-98-5" name="__codelineno-98-5"></a><a href="#__codelineno-98-5"><span class="linenos" data-linenos="5 "></span></a>Data<span class="w"> </span>extraction<span class="w"> </span>complete.<span class="w"> </span>Results<span class="w"> </span>saved<span class="w"> </span><span class="k">in</span><span class="w"> </span>/tmp/extract_nginx_data.txt
</code></pre></div>
<p>执行后通过<code>cat</code>命令查看<code>/tmp/extract_nginx_data.txt</code>文件，可以看到将每个服务器获取到nginx配置和证书信息文件内的部分信息提取并合并了起来：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-99-1" name="__codelineno-99-1"></a><a href="#__codelineno-99-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="o">[</span>root@jerion<span class="w"> </span>nginx_configuration<span class="o">]</span><span class="c1"># cat /tmp/extract_nginx_data.txt    </span>
<a id="__codelineno-99-2" name="__codelineno-99-2"></a><a href="#__codelineno-99-2"><span class="linenos" data-linenos=" 2 "></span></a>IP:<span class="w"> </span><span class="m">10</span>.22.21.99
<a id="__codelineno-99-3" name="__codelineno-99-3"></a><a href="#__codelineno-99-3"><span class="linenos" data-linenos=" 3 "></span></a>No<span class="w"> </span>Nginx
<a id="__codelineno-99-4" name="__codelineno-99-4"></a><a href="#__codelineno-99-4"><span class="linenos" data-linenos=" 4 "></span></a>-------------------------------------
<a id="__codelineno-99-5" name="__codelineno-99-5"></a><a href="#__codelineno-99-5"><span class="linenos" data-linenos=" 5 "></span></a>IP:<span class="w"> </span><span class="m">10</span>.22.50.220
<a id="__codelineno-99-6" name="__codelineno-99-6"></a><a href="#__codelineno-99-6"><span class="linenos" data-linenos=" 6 "></span></a>Nginx<span class="w"> </span>Path:<span class="w"> </span>/sbin/nginx
<a id="__codelineno-99-7" name="__codelineno-99-7"></a><a href="#__codelineno-99-7"><span class="linenos" data-linenos=" 7 "></span></a>Config<span class="w"> </span>Path:<span class="w"> </span>/usr/local/nginx/conf
<a id="__codelineno-99-8" name="__codelineno-99-8"></a><a href="#__codelineno-99-8"><span class="linenos" data-linenos=" 8 "></span></a>Cert<span class="w"> </span>Path:
<a id="__codelineno-99-9" name="__codelineno-99-9"></a><a href="#__codelineno-99-9"><span class="linenos" data-linenos=" 9 "></span></a>/usr/local/nginx/cert/nx.cloud.sunline.cn_nginx/nx.cloud.sunline.cn_bundle.crt
<a id="__codelineno-99-10" name="__codelineno-99-10"></a><a href="#__codelineno-99-10"><span class="linenos" data-linenos="10 "></span></a>Key<span class="w"> </span>Path:
<a id="__codelineno-99-11" name="__codelineno-99-11"></a><a href="#__codelineno-99-11"><span class="linenos" data-linenos="11 "></span></a>/usr/local/nginx/cert/nx.cloud.sunline.cn_nginx/nx.cloud.sunline.cn.key
<a id="__codelineno-99-12" name="__codelineno-99-12"></a><a href="#__codelineno-99-12"><span class="linenos" data-linenos="12 "></span></a>-------------------------------------
<a id="__codelineno-99-13" name="__codelineno-99-13"></a><a href="#__codelineno-99-13"><span class="linenos" data-linenos="13 "></span></a>......
</code></pre></div>
<h2 id="九使用yunwei账号">九、使用yunwei账号<a class="headerlink" href="#九使用yunwei账号" title="Permanent link">&para;</a></h2>
<p><code>sshpass</code>是一个允许你在命令行中传递密码的工具。</p>
<h3 id="1安装sshpass">1.安装sshpass<a class="headerlink" href="#1安装sshpass" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-100-1" name="__codelineno-100-1"></a><a href="#__codelineno-100-1"><span class="linenos" data-linenos="1 "></span></a>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>epel-release
<a id="__codelineno-100-2" name="__codelineno-100-2"></a><a href="#__codelineno-100-2"><span class="linenos" data-linenos="2 "></span></a>yum<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>sshpass
</code></pre></div>
<h3 id="2修改主机清单文件">2.修改主机清单文件<a class="headerlink" href="#2修改主机清单文件" title="Permanent link">&para;</a></h3>
<p>修改<code>/data/ansible/hosts</code>文件如下：</p>
<div class="language-bash highlight"><span class="filename">Bash</span><pre><span></span><code><a id="__codelineno-101-1" name="__codelineno-101-1"></a><a href="#__codelineno-101-1"><span class="linenos" data-linenos="1 "></span></a><span class="o">[</span>all:vars<span class="o">]</span>
<a id="__codelineno-101-2" name="__codelineno-101-2"></a><a href="#__codelineno-101-2"><span class="linenos" data-linenos="2 "></span></a><span class="c1">#ansible_user=root</span>
<a id="__codelineno-101-3" name="__codelineno-101-3"></a><a href="#__codelineno-101-3"><span class="linenos" data-linenos="3 "></span></a><span class="c1">#ansible_ssh_private_key_file=/root/.ssh/id_rsa</span>
<a id="__codelineno-101-4" name="__codelineno-101-4"></a><a href="#__codelineno-101-4"><span class="linenos" data-linenos="4 "></span></a><span class="nv">ansible_ssh_user</span><span class="o">=</span>yunwei
<a id="__codelineno-101-5" name="__codelineno-101-5"></a><a href="#__codelineno-101-5"><span class="linenos" data-linenos="5 "></span></a><span class="nv">ansible_ssh_pass</span><span class="o">=</span>Sun%2020
<a id="__codelineno-101-6" name="__codelineno-101-6"></a><a href="#__codelineno-101-6"><span class="linenos" data-linenos="6 "></span></a><span class="nv">ansible_sudo_pass</span><span class="o">=</span>Sun%2020
</code></pre></div>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date">2024-11-21</span>
  </span>

    
    
    
    
  </aside>


  




                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../../../blog/" class="md-footer__link md-footer__link--prev" aria-label="上一页: 博客介绍">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                博客介绍
              </div>
            </div>
          </a>
        
        
          
          <a href="../../Linux%E5%91%BD%E4%BB%A4/1.linux%E5%91%BD%E4%BB%A4%E5%9F%BA%E6%9C%AC%E6%A0%BC%E5%BC%8F/" class="md-footer__link md-footer__link--next" aria-label="下一页: 1. linux命令基本格式">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                1. linux命令基本格式
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <!--
  Copyright (c) 2016-2023 Martin Donath <martin.donath@squidfunk.com>

  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:

  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Copyright and theme information -->
<div class="md-copyright">
  
    <div class="md-copyright__highlight">
      版权所有 © 2023-2024 | <a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">粤ICP备2024253391号</a>
    </div>
  
  
    <script id="LA-DATA-WIDGET" crossorigin="anonymous" charset="UTF-8" src="https://v6-widget.51.la/v6/3JIbgFniDcGIaNP7/quote.js?theme=#FFFFFF,#808080,#808080,#B3B3B3,#FFFFFF,#1690FF,12&f=12&display=0,0,1,1,1,1,1,1"></script>
    <!--Made with
    <a
      href="https://squidfunk.github.io/mkdocs-material/"
      target="_blank" rel="noopener"
    >
      Material for MkDocs
    </a> | <a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener">粤ICP备16023717号</a-->
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://github.com" target="_blank" rel="noopener" title="GitHub" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.google.com/" target="_blank" rel="noopener" title="Google" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M488 261.8C488 403.3 391.1 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 123 24.5 166.3 64.9l-67.5 64.9C258.5 52.6 94.3 116.6 94.3 256c0 86.5 69.1 156.6 153.7 156.6 98.2 0 135-70.4 140.8-106.9H248v-85.3h236.1c2.3 12.7 3.9 24.9 3.9 41.4z"/></svg>
    </a>
  
    
    
    
    
    <a href="https://www.linux.org/" target="_blank" rel="noopener" title="Linux" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M220.8 123.3c1 .5 1.8 1.7 3 1.7 1.1 0 2.8-.4 2.9-1.5.2-1.4-1.9-2.3-3.2-2.9-1.7-.7-3.9-1-5.5-.1-.4.2-.8.7-.6 1.1.3 1.3 2.3 1.1 3.4 1.7zm-21.9 1.7c1.2 0 2-1.2 3-1.7 1.1-.6 3.1-.4 3.5-1.6.2-.4-.2-.9-.6-1.1-1.6-.9-3.8-.6-5.5.1-1.3.6-3.4 1.5-3.2 2.9.1 1 1.8 1.5 2.8 1.4zM420 403.8c-3.6-4-5.3-11.6-7.2-19.7-1.8-8.1-3.9-16.8-10.5-22.4-1.3-1.1-2.6-2.1-4-2.9-1.3-.8-2.7-1.5-4.1-2 9.2-27.3 5.6-54.5-3.7-79.1-11.4-30.1-31.3-56.4-46.5-74.4-17.1-21.5-33.7-41.9-33.4-72C311.1 85.4 315.7.1 234.8 0 132.4-.2 158 103.4 156.9 135.2c-1.7 23.4-6.4 41.8-22.5 64.7-18.9 22.5-45.5 58.8-58.1 96.7-6 17.9-8.8 36.1-6.2 53.3-6.5 5.8-11.4 14.7-16.6 20.2-4.2 4.3-10.3 5.9-17 8.3s-14 6-18.5 14.5c-2.1 3.9-2.8 8.1-2.8 12.4 0 3.9.6 7.9 1.2 11.8 1.2 8.1 2.5 15.7.8 20.8-5.2 14.4-5.9 24.4-2.2 31.7 3.8 7.3 11.4 10.5 20.1 12.3 17.3 3.6 40.8 2.7 59.3 12.5 19.8 10.4 39.9 14.1 55.9 10.4 11.6-2.6 21.1-9.6 25.9-20.2 12.5-.1 26.3-5.4 48.3-6.6 14.9-1.2 33.6 5.3 55.1 4.1.6 2.3 1.4 4.6 2.5 6.7v.1c8.3 16.7 23.8 24.3 40.3 23 16.6-1.3 34.1-11 48.3-27.9 13.6-16.4 36-23.2 50.9-32.2 7.4-4.5 13.4-10.1 13.9-18.3.4-8.2-4.4-17.3-15.5-29.7zM223.7 87.3c9.8-22.2 34.2-21.8 44-.4 6.5 14.2 3.6 30.9-4.3 40.4-1.6-.8-5.9-2.6-12.6-4.9 1.1-1.2 3.1-2.7 3.9-4.6 4.8-11.8-.2-27-9.1-27.3-7.3-.5-13.9 10.8-11.8 23-4.1-2-9.4-3.5-13-4.4-1-6.9-.3-14.6 2.9-21.8zM183 75.8c10.1 0 20.8 14.2 19.1 33.5-3.5 1-7.1 2.5-10.2 4.6 1.2-8.9-3.3-20.1-9.6-19.6-8.4.7-9.8 21.2-1.8 28.1 1 .8 1.9-.2-5.9 5.5-15.6-14.6-10.5-52.1 8.4-52.1zm-13.6 60.7c6.2-4.6 13.6-10 14.1-10.5 4.7-4.4 13.5-14.2 27.9-14.2 7.1 0 15.6 2.3 25.9 8.9 6.3 4.1 11.3 4.4 22.6 9.3 8.4 3.5 13.7 9.7 10.5 18.2-2.6 7.1-11 14.4-22.7 18.1-11.1 3.6-19.8 16-38.2 14.9-3.9-.2-7-1-9.6-2.1-8-3.5-12.2-10.4-20-15-8.6-4.8-13.2-10.4-14.7-15.3-1.4-4.9 0-9 4.2-12.3zm3.3 334c-2.7 35.1-43.9 34.4-75.3 18-29.9-15.8-68.6-6.5-76.5-21.9-2.4-4.7-2.4-12.7 2.6-26.4v-.2c2.4-7.6.6-16-.6-23.9-1.2-7.8-1.8-15 .9-20 3.5-6.7 8.5-9.1 14.8-11.3 10.3-3.7 11.8-3.4 19.6-9.9 5.5-5.7 9.5-12.9 14.3-18 5.1-5.5 10-8.1 17.7-6.9 8.1 1.2 15.1 6.8 21.9 16l19.6 35.6c9.5 19.9 43.1 48.4 41 68.9zm-1.4-25.9c-4.1-6.6-9.6-13.6-14.4-19.6 7.1 0 14.2-2.2 16.7-8.9 2.3-6.2 0-14.9-7.4-24.9-13.5-18.2-38.3-32.5-38.3-32.5-13.5-8.4-21.1-18.7-24.6-29.9s-3-23.3-.3-35.2c5.2-22.9 18.6-45.2 27.2-59.2 2.3-1.7.8 3.2-8.7 20.8-8.5 16.1-24.4 53.3-2.6 82.4.6-20.7 5.5-41.8 13.8-61.5 12-27.4 37.3-74.9 39.3-112.7 1.1.8 4.6 3.2 6.2 4.1 4.6 2.7 8.1 6.7 12.6 10.3 12.4 10 28.5 9.2 42.4 1.2 6.2-3.5 11.2-7.5 15.9-9 9.9-3.1 17.8-8.6 22.3-15 7.7 30.4 25.7 74.3 37.2 95.7 6.1 11.4 18.3 35.5 23.6 64.6 3.3-.1 7 .4 10.9 1.4 13.8-35.7-11.7-74.2-23.3-84.9-4.7-4.6-4.9-6.6-2.6-6.5 12.6 11.2 29.2 33.7 35.2 59 2.8 11.6 3.3 23.7.4 35.7 16.4 6.8 35.9 17.9 30.7 34.8-2.2-.1-3.2 0-4.2 0 3.2-10.1-3.9-17.6-22.8-26.1-19.6-8.6-36-8.6-38.3 12.5-12.1 4.2-18.3 14.7-21.4 27.3-2.8 11.2-3.6 24.7-4.4 39.9-.5 7.7-3.6 18-6.8 29-32.1 22.9-76.7 32.9-114.3 7.2zm257.4-11.5c-.9 16.8-41.2 19.9-63.2 46.5-13.2 15.7-29.4 24.4-43.6 25.5s-26.5-4.8-33.7-19.3c-4.7-11.1-2.4-23.1 1.1-36.3 3.7-14.2 9.2-28.8 9.9-40.6.8-15.2 1.7-28.5 4.2-38.7 2.6-10.3 6.6-17.2 13.7-21.1.3-.2.7-.3 1-.5.8 13.2 7.3 26.6 18.8 29.5 12.6 3.3 30.7-7.5 38.4-16.3 9-.3 15.7-.9 22.6 5.1 9.9 8.5 7.1 30.3 17.1 41.6 10.6 11.6 14 19.5 13.7 24.6zM173.3 148.7c2 1.9 4.7 4.5 8 7.1 6.6 5.2 15.8 10.6 27.3 10.6 11.6 0 22.5-5.9 31.8-10.8 4.9-2.6 10.9-7 14.8-10.4s5.9-6.3 3.1-6.6-2.6 2.6-6 5.1c-4.4 3.2-9.7 7.4-13.9 9.8-7.4 4.2-19.5 10.2-29.9 10.2s-18.7-4.8-24.9-9.7c-3.1-2.5-5.7-5-7.7-6.9-1.5-1.4-1.9-4.6-4.3-4.9-1.4-.1-1.8 3.7 1.7 6.5z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.tabs", "navigation.tracking", "navigation.indexes", "navigation.sections", "navigation.expand", "navigation.prune", "navigation.path", "toc.follow", "navigation.top", "search.suggest", "search.highlight", "search.share", "navigation.footer", "content.code.copy", "content.action.view"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.af256bd8.min.js"></script>
      
        <script src="../../../js/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.bootcss.com/mathjax/3.0.5/es5/tex-mml-chtml.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>